---
title: 《x86 汇编语言：从实模式到保护模式（第2版）》读书笔记（第 1-10 章）
intro: 一本 2023 年的新书，这里挑些重点记一记。
comments: false
date: 2023-04-09 10:51:58
tags:
- 汇编
- x86
- x64
---

一本 2023 年的新书，这里挑些重点记一记。

### 第 1 章 - 十六进制计数法

（略）

### 第 2 章 - 计算机和汇编语言

1. Intel 处理器的发展：4004（4 位）、8088（8 位）、8086（16 位）、80286、80386、80486、Pentium、...。
2. 人们最早用的是开关、跳线以及纸带来给计算机编程。

### 第 3 章 - 分段机制和逻辑地址

3. **处理器的字长**：指寄存器和算术逻辑部件的数据宽度。
4. 8086 处理器：

![](1.jpg)

* 诞生于 1978 年；
* 访问内存时使用的是**逻辑地址**：“段地址”+“段内偏移”，指令中的地址均相对于某个段；
* 16 位 *ip* 寄存器；
* 4 个 16 位段寄存器：
  * *cs*：指定代码段位置；
  * *ds*：指定数据段位置；
  * *es*：附加段，冗余的段寄存器；
  * *ss*：栈段寄存器。
* 提供了 20 根地址线，可寻址 1MB 内存：
  * 大部分用于访问 **DRAM**（0x0\~0x9ffff），少部分用于访问 **ROM-BIOS**（0xf0000\~0xfffff），和**外围板卡**（0xa0000\～0xeffff）。ROM 部分存有固化的开机启动代码（通常为跳转指令，将 cs/ip 跳回 ROM 的低地址区），通常也被称为 BIOS；
  * 段只能起始于被 16 整除的物理内存地址（可以被表示）；
  * 段逻辑地址 => 段物理地址 >> 4；
  * 单个段最大 64KB。

### 第 4 章 - 汇编语言和汇编软件

5. 汇编语言对指令的大小写没有特别的要求。
6. NASM -> Netwide Assembler。

### 第 5 章 - 虚拟机的安装和使用

7. 计算机的加电与复位：

* *RESET 引脚*：接受复位信号。复位后 CPU 会进行硬件初始化、BIST 内部自测试，并将内部所有寄存器的内容恢复到预置状态；
* 主引导扇区（MBR）：即 “0 盘面 0 磁道 1 扇区”。BIOS 会将该扇区内容加载到内存地址 **0x0000:0x7c00** 的位置（来自 Intel 第一代个人电脑芯片 8088，后续 CPU 为了保持兼容，一直使用这个地址），然后跳转到该位置执行。

8. 硬盘的访问模式：

* CHS（Cylinder-head-sector）模式：通过磁柱，磁头，扇区寻址；
* LBA（Logical Block Address）模式：物理扇区被组织成逻辑扇区，逻辑扇区号连续递增。

9. 一个简单的启动程序：

```assembly
mov ax, 0xb800

; x86 下的段寄存器只能间接赋值；
mov ds, ax  

; ds 会作为默认的数据段寄存器，也可以显式使用 es；
mov byte [0x00], 'a'  
mov byte [0x02], 's'
mov byte [0x04], 'm'
jmp $
times 510-($-$$) db 0
db 0x55, 0xaa
```

### 第 6 章 - 编写主引导扇区代码

10. **一个有效的主引导扇区，其最后 2 字节应当是 0x55 和 0xaa**。正常情况下，一段精心编写的主引导扇区代码将检测用来启动计算机的操作系统，并计算出它所在的硬盘位置。然后，它把操作系统的自举代码加载到内存，也用jmp指令跳转到那里继续执行，直到操作系统完全启动。
11. 显卡有自己的存储器（VRAM），要显示的内容都预先写入显存。

* 两种基本模式：
  * *文本模式*：用于显示字符的工作方式（字符代码存入显存，由字符发生器和控制电路决定如何渲染）；
  * *图形模式*：用于显示图形的工作方式。
* 由于历史的原因，所有在个人计算机上使用的显卡，在加电自检之后都会把自己初始化为 **80×25 文本模式**。在这种模式下，屏幕上可以显示 25 行，每行 80 个字符，每屏总共 2000 个字符；
* **0xb8000～0xbffff**（段起始 0xb800）这段物理地址空间，通常默认被用来映射显存；
* 屏幕上的**每个字符对应着显存中连续 2 字节**，前一个是字符的 ASCII 代码，后面是字符的显示属性。

![](2.jpg)

12. Nasm 伪指令（不对应处理器指令，由编译器处理）：db、dw、dd、dq。
13. **对于寄存器清零，使用 *xor* 指令生成的机器码更短**：

```assembly
mov rax, 0
xor rax, rax  ; better!
```

14. 段内近转移：

```assembly
infi: jmp near infi
```

* *near* 关键字表示代码转移位置在当前段内，相对量为 16 位；
* 取指令的位置：CS << 4 + IP；
* `jmp` 指令的几种形式：
  * 绝对地址跳转 -> *jmp 0x5000:0xf0c0*；
  * 相对偏移地址跳转（目标位置相对当前指令的偏移量）-> *jmp near infi*。

15. Nasm 伪指令：

* 重复指令：`times 20 mov ax, bx`；
* 当前指令的位置：`$`；
* 当前段的起始位置：`$$`；
* 当前位置已经过的段大小：`$ - $$`。

16. **Bochs**：开源的 x86 PC 模拟器。用软件来模拟处理器取指令和执行指令的过程，以及整个计算机硬件。

* 可用于调试 MBR 程序；
* 

17. 
18. 
19. 
20. 
21. 

