---
title: 《x86 汇编语言：从实模式到保护模式（第2版）》读书笔记（第 10-20 章）
intro: 书接上文。
comments: false
date: 2023-06-03 22:03:00
tags:
- 汇编
- x86
- x64
---

书接上文。相关代码和注释参考[这里](https://github.com/Becavalier/x86-asm-snippets)。

### 第 11 章 - 32 位 x86 处理器编程架构

30. IA-32：Intel 32 位处理器架构。

* 发展于 1978 年的 8086 处理器；
* **32 根数据线，以及至少 32 根地址线**。可访问至少 4GB 内存，每次可连续读写 4 字节（双字）数据；
* 32 位通用目的寄存器：eax \ ebx \ ecx \ edx \ esi \ edi \ esp \ ebp；
  * 高 16 位部分不可独立使用；
  * 源操作数与目的操作数必须具有相同长度。
* 32 位标志寄存器 eflags，32 位指令指针寄存器 eip；
* 仍基于分段模型，段基地址 32 位，段内偏移量 32 位。16 位段寄存器 cs \ ss \ ds \ es \ fs \ gs 中存放段选择子，即要访问的段（段选择器）。真正的段基地址存放在对应的描述符高速缓存中；
* 支持使用**平坦模型**（Flat Mode），即只分一个段，段基址为 0x00000000；
* **处理器要求在加载程序时，先定义该程序所拥有的段，然后才允许使用这些段**。定义段时，除基地址（起始地址）外，还附加了段界限、特权级别、类型等属性。当程序访问一个段时，处理器将进行检查，以防止对内存的违规访问；
* 提供了 V86（虚拟 8086）模式，在这种模式下，IA-32 处理器被模拟成多个 8086 处理器并行工作（支持同时运行 32 保护模式和 8086 实模式程序）；
* 逻辑地址 = 偏移地址（有效地址，EA）+ 段地址；
* 分页机制：页大小一般 4KB。每个任务对应 4GB 虚拟线性地址空间，并使用线性地址描述，MMU 负责将该地址转换为物理地址；

![](1.jpg)

* 内存寻址方式（如上图）：在 32 位处理器上，允许在内存操作数中使用栈指针寄存器 esp。

31. 现代处理器的结构和特点：

* **流水线**：把一条指令的执行过程分解成若干个细小的步骤，并分配给相应的单元来完成。各个单元的执行是独立的、并行的。如此一来，各个步骤的执行在时间上就会重叠起来；
* **高速缓存**：利用程序的局部性原理（时间 + 空间），缓存经常使用的数据；
* **乱序执行**：将指令拆分为“微指令”后，以乱序方式执行它们，某种程度可以提高效率；

```assembly
mov eax, [mem1]
; 拆分为两个微操作，esp 的值可以提前被修改（不需要等待 eax）；
push eax   
; esp 值更新后，该指令可以提前执行；
call func
```

* **寄存器重命名**：处理器重命名临时寄存器以代表目标逻辑寄存器，借此优化代码的执行顺序；

```assembly
mov eax, [mem1]
shl eax, 3
mov [mem2], eax
; 以下三条指令将在内部使用不同的临时寄存器并行执行；
mov eax, [mem3]   
add eax, 2
mov [mem4], eax
; 代码执行完毕前会将临时寄存器的值更新到真实寄存器中；
```

* **分支目标预测**：预测条件分支的后续执行路径，减少流水线指令清空带来的惩罚。


### 第 12 章 - 进入保护模式

32. 
33. 
34. 
35. 
36. 
37. 

