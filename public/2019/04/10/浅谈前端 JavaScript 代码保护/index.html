<!DOCTYPE html><html lang="en-us"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>浅谈前端 JavaScript 代码保护 | 曜彤.手记</title><meta name="description" content="本文主要介绍了可用于前端 JavaScript 代码保护的相关方案，这些方案仅用于参考，这里并不讨论它们的实用价值。而所谓“代码保护”可以被进一步理解为「如何在外部环境中尽量降低明文 JavaScript 代码的可读性，以让代码的执行细节成为黑盒？」这样一来，我们提到的“代码保护”便可在一定程度上实现。"><meta name="generator" content="曜彤.手记"><meta name="about" content="[object Object]"><meta name="keywords" content="博客, C++, C, Rust, Web, Java, IT, 编程, 开发, Android, Python, MySQL, 科技, 黑客, 技术, Javascript, 云, 大数据, 计算, 机器学习, AI, 人工智能, 创业, 产品, 公司, WebAssembly, Wasm"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=0"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.jpg"><link rel="apple-touch-icon" sizes="60x60" href="/images/apple-touch-icon-60x60.jpg"><link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.jpg"><link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.jpg"><link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.jpg"><link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.jpg"><link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.jpg"><link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.jpg"><link rel="apple-touch-icon" sizes="196x196" href="/images/apple-touch-icon-196x196.jpg"><link rel="apple-touch-icon" sizes="310x310" href="/images/apple-touch-icon-310x310.jpg"><link href="/images/splash/iphone5_splash.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphone6_splash.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphoneplus_splash.png" media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/iphonex_splash.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/iphonexr_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphonexsmax_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/ipad_splash.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro1_splash.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro3_splash.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro2_splash.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="128x128" href="/images/favicon-128.png"><link rel="icon" type="image/png" sizes="196x196" href="/images/favicon-196x196.png"><meta name="msapplication-TileColor" content="#FFFFFF"><meta name="msapplication-TileImage" content="mstile-144x144.png"><meta name="msapplication-square70x70logo" content="mstile-70x70.png"><meta name="msapplication-square150x150logo" content="mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="mstile-310x150.png"><meta name="msapplication-square310x310logo" content="mstile-310x310.png"><meta name="msapplication-square310x310logo" content="mstile-310x310.png"><link rel="manifest" href="/manifest.webmanifest"><link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="/atom.xml"><link rel="stylesheet" href="/css/prism-okaidia.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body itemscope itemtype="https://schema.org/WebPage"><div class="canvas-containter"><span>X</span></div><header itemscope itemtype="https://schema.org/WPHeader"><div class="logo"></div><h1 class="title"><a href="/" alt="曜彤.手记" title="曜彤.手记" itemprop="headline">曜彤.手记</a><a title="Atom 0.3" target="__blank" href="/atom.xml" class="rss"><img src="/images/rss.png"></a></h1><p itemprop="description" class="description">随记，关于互联网技术、产品与创业</p><nav itemscope itemtype="https://schema.org/SiteNavigationElement"><ul><li itemprop="name" class="menu-item"><a href="/ " alt="首页" title="首页" itemprop="url">首页</a></li><li itemprop="name" class="menu-item"><a href="/articles" alt="文章" title="文章" itemprop="url">文章</a></li><li itemprop="name" class="menu-item"><a href="/readings" alt="阅读" title="阅读" itemprop="url">阅读</a></li><li itemprop="name" class="menu-item"><a href="/cards" alt="快记" title="快记" itemprop="url">快记</a></li><li itemprop="name" class="menu-item"><a href="/tags" alt="标签" title="标签" itemprop="url">标签</a></li><li itemprop="name" class="menu-item"><a href="/about" alt="关于" title="关于" itemprop="url">关于</a></li></ul></nav><div class="dynamic-slot"></div><div class="toc-body"><div class="bookmark"></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86%EF%BC%88Code-Obfuscation%EF%BC%89"><span class="toc-text">代码混淆（Code Obfuscation）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%8A%9F%E8%83%BD"><span class="toc-text">基本功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%80%9C%E5%85%A5%E4%BE%B5%E5%BC%8F%E2%80%9D%E6%B7%B7%E6%B7%86"><span class="toc-text">“入侵式”混淆</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B2%99%E7%9B%92%EF%BC%88Sandboxing%EF%BC%89"><span class="toc-text">沙盒（Sandboxing）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text">参考资料</span></a></div><div class="space"></div></header><main itemscope itemtype="https://schema.org/Blog"><script src="https://shadow.elemecdn.com/npm/zoomage.js@latest/dist/zoomage.min.js" type="text/javascript"></script><script src="https://shadow.elemecdn.com/npm/axios@0.18.0/dist/axios.min.js" type="text/javascript"></script><script src="/scripts/post.js" type="text/javascript"></script><div class="touch-top"><span></span></div><article post-id="浅谈前端 JavaScript 代码保护" class="full"><h1 itemprop="headline" class="align-center">浅谈前端 JavaScript 代码保护</h1><div class="content"><div class="article-meta"><span class="post-meta"><br>Created on<time itemprop="dateCreated" datetime="2019-04-10T08:58:34.000Z"> 2019 / 04 / 10, 16:58:34</time></span><span class="page-tag-anchor"><a href="/tags/JavaScript" itemprop="url">#JavaScript</a>&nbsp;&nbsp;<a href="/tags/代码保护" itemprop="url">#代码保护</a>&nbsp;&nbsp;</span></div><p>本文主要介绍了可用于前端 JavaScript 代码保护的相关方案，这些方案仅用于参考，这里并不讨论它们的实用价值。而所谓“代码保护”可以被进一步理解为「<strong>如何在外部环境中尽量降低明文 JavaScript 代码的可读性，以让代码的执行细节成为黑盒？</strong>」这样一来，我们提到的“代码保护”便可在一定程度上实现。</p>
<p>总的来看，想到的方法可分为以下几种：</p>
<h3 id="代码混淆（Code-Obfuscation）"><a href="#代码混淆（Code-Obfuscation）" class="headerlink" title="代码混淆（Code Obfuscation）"></a>代码混淆（Code Obfuscation）</h3><p>第一种可以直接想到的方式便是使用“<strong>代码混淆</strong>”（由于两者一般同时进行，因此这里不特意区分“压缩”与“混淆”）。</p>
<h4 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h4><p>大多数基本的代码混淆工具都可以压缩原始的 ASCII 明文代码，并将其中的诸如：变量名、函数名等，使用简短且无意义的标识符进行替换，这是作为一款代码混淆工具的最基础功能。比如，以我们最常用的 “<em>Uglify</em>” 与 “<em>GCC</em> (Google Closure Compiler)” 两个工具为例，对下面这样一段未经处理的 ES6 源代码进行默认的代码混淆处理：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">let</span> times <span class="token operator">=</span> <span class="token number">0.1</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> getExtra <span class="token operator">=</span> n <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>i <span class="token operator">=</span><span class="token operator">></span> i <span class="token operator">*</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">94</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">88</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">39</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> newArr <span class="token operator">=</span> <span class="token function">getExtra</span><span class="token punctuation">(</span>times<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">=</span><span class="token operator">></span> item <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sortarr <span class="token operator">=</span> arr <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> i<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">></span> arr<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> temp <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        arr<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> arr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sortarr</span><span class="token punctuation">(</span>newArr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在经过 UglifyJS 的代码处理后，我们可以得到如下结果（这里为了直观比对，保留了空格和换行）：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">let</span> times <span class="token operator">=</span> <span class="token number">1.8</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> getExtra <span class="token operator">=</span> r <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>t <span class="token operator">=</span><span class="token operator">></span> t <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">,</span>
  arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">94</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">88</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">39</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  newArr <span class="token operator">=</span> <span class="token function">getExtra</span><span class="token punctuation">(</span>times<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>r <span class="token operator">=</span><span class="token operator">></span> <span class="token number">2</span> <span class="token operator">*</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  sortarr <span class="token operator">=</span> r <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> t <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> t<span class="token operator">++</span><span class="token punctuation">)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> e <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> e <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">;</span> e<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">></span> r<span class="token punctuation">[</span>e <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> t <span class="token operator">=</span> r<span class="token punctuation">[</span>e<span class="token punctuation">]</span><span class="token punctuation">;</span>
          r<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">[</span>e <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> r<span class="token punctuation">[</span>e <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> t
        <span class="token punctuation">}</span> <span class="token keyword">return</span> r
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sortarr</span><span class="token punctuation">(</span>newArr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而在经过 GCC 的代码处理后我们可以得到：</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token string">'use strict'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token punctuation">(</span>c <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>a <span class="token operator">=</span><span class="token operator">></span> a <span class="token operator">*</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1.8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">94</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">88</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">39</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>c <span class="token operator">=</span><span class="token operator">></span> <span class="token number">2</span> <span class="token operator">*</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> d <span class="token operator">=</span> console<span class="token punctuation">,</span>
  e <span class="token operator">=</span> d<span class="token punctuation">.</span>log<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> c <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> c<span class="token operator">++</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> a <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> c<span class="token punctuation">;</span> a<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">></span> b<span class="token punctuation">[</span>a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> f <span class="token operator">=</span> b<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">;</span>
      b<span class="token punctuation">[</span>a<span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">[</span>a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      b<span class="token punctuation">[</span>a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> f
    <span class="token punctuation">}</span> e<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对比上述两种工具的代码处理结果可以看到，默认情况下 UglifyJS 不会对原始代码进行“重写”，所有的混淆压缩工作都是在“<strong>保证原有代码基本结构不变</strong>”这个条件的基础之上进行的。而 GCC 对代码的处理过程则更接近于“编译器”。其除了会对常见的变量名、函数名等标识符进行混淆替换外，还应用了诸多 DCE 优化手段。比如对常量表达式进行提前求值（0.1 * 8 + 1）、通过 “<em>inlining</em>” 减少中间变量的使用等等。当然，UglifyJS 在经过一定的配置后也可以使用一些相对“激进”的优化手段，这里只需知道传统代码混淆工具所具备的能力即可。</p>
<p>借助 UglifyJS，我们也可以编写自己的源码处理程序。比如可以首先使用 <code>UglifyJS.parse</code> 将一段 JavaScript 代码转换成其对应的 AST 形式；然后再通过 <code>UglifyJS.Compressor</code> 等方法对这些 AST 进行转换；最后再使用 <code>print_to_string</code> 方法将处理后的 AST 结构转换成相应的 ASCII 明文代码形式。<em>UglifyJS.Compressor</em> 的本质是一个 “TreeTransformer” 类型，其内部已经封装好了众多常用的代码优化方法，而通过对 <code>UglifyJS.TreeTransformer</code> 进行适当的封装，我们也可以编写自己的代码优化器。如下所示这段简短的代码便实现了一个支持“<strong>常量传播</strong>”与“<strong>常量折叠</strong>”的 JavaScript 代码转换器（非完备，仅供参考）。</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">const</span> UglifyJS <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uglify-js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> symbolTable <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> binaryOperations <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">"+"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">+</span> y<span class="token punctuation">,</span>
  <span class="token string">"-"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">-</span> y<span class="token punctuation">,</span>
  <span class="token string">"*"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">*</span> y
<span class="token punctuation">}</span>
<span class="token keyword">const</span> constexpr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UglifyJS<span class="token punctuation">.</span>TreeTransformer</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> node <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token keyword">instanceof</span> <span class="token class-name">UglifyJS<span class="token punctuation">.</span>AST_Binary</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token function">isInteger</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> Number<span class="token punctuation">.</span><span class="token function">isInteger</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UglifyJS<span class="token punctuation">.</span>AST_Number</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> binaryOperations<span class="token punctuation">[</span>node<span class="token punctuation">.</span>operator<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> 
          <span class="token function">Number</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> 
          <span class="token function">Number</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UglifyJS<span class="token punctuation">.</span>AST_Number</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> binaryOperations<span class="token punctuation">[</span>node<span class="token punctuation">.</span>operator<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> 
          <span class="token function">Number</span><span class="token punctuation">(</span>symbolTable<span class="token punctuation">[</span>node<span class="token punctuation">.</span>left<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> 
          <span class="token function">Number</span><span class="token punctuation">(</span>symbolTable<span class="token punctuation">[</span>node<span class="token punctuation">.</span>right<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token keyword">instanceof</span> <span class="token class-name">UglifyJS<span class="token punctuation">.</span>AST_VarDef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    symbolTable<span class="token punctuation">[</span>node<span class="token punctuation">.</span>name<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> ast <span class="token operator">=</span> UglifyJS<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`
  const x = 10 * 2 + 6;
  const y = 4 - 1 * 100;
  console.log(x + y);
`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// transform and print.</span>
ast<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>constexpr<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ast<span class="token punctuation">.</span><span class="token function">print_to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// "var x=26;var y=-96;console.log(-70);".</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里我们通过识别特定的 Uglify AST 节点类型（<em>UglifyJS.AST_Binary</em> / <em>UglifyJS.AST_VarDef</em>）来达到对代码进行精准处理的目的。可以看到，变量 <code>x</code> 和 <code>y</code> 的值在代码转换过程中被提前计算。不仅如此，其作为变量的值还被“传递”到了表达式 <code>x + y</code> 中，且整个表达式的值也被提前计算，进而省去了运行时计算的成本。类似的，通过诸如 Babel 的 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@babel/traverse"><code>@babel/traverse</code></a> 等插件，我们也可实现同样的效果，其基本原理大同小异。</p>
<h4 id="“入侵式”混淆"><a href="#“入侵式”混淆" class="headerlink" title="“入侵式”混淆"></a>“入侵式”混淆</h4><p>对于经由 UglifyJS 和 GCC 等传统 JavaScript 代码混淆工具处理后的代码，我们尚能清楚地了解代码的大致执行逻辑。而对于某些更加激进（<em>aggressive</em>）的 JavaScript 代码混淆工具来说，经由它们处理后生成的明文代码已基本丧失了可读性。比如本文开头的那段 JavaScript 代码在经由 “<b><a target="_blank" rel="noopener" href="https://github.com/javascript-obfuscator/javascript-obfuscator">javascript-obfuscator</a></b>” 默认配置下的代码混淆功能处理后，可以得到以下结果。能够看到，这部分代码已基本丧失可读性。</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">const</span> _0x1dc7 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'12nNpunz'</span><span class="token punctuation">,</span> <span class="token string">'log'</span><span class="token punctuation">,</span> <span class="token string">'3dzOihv'</span><span class="token punctuation">,</span> <span class="token string">'length'</span><span class="token punctuation">,</span> <span class="token string">'140940hmJpHd'</span><span class="token punctuation">,</span> <span class="token string">'570593RvJQQj'</span><span class="token punctuation">,</span> <span class="token string">'30406WiuNiv'</span><span class="token punctuation">,</span> <span class="token string">'154511VRvByU'</span><span class="token punctuation">,</span> <span class="token string">'1HvqfmW'</span><span class="token punctuation">,</span> <span class="token string">'522351ALcOFX'</span><span class="token punctuation">,</span> <span class="token string">'map'</span><span class="token punctuation">,</span> <span class="token string">'1318841sxtxER'</span><span class="token punctuation">,</span> <span class="token string">'36YiKqrR'</span><span class="token punctuation">,</span> <span class="token string">'16126qXbaLY'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> _0x84e884 <span class="token operator">=</span> _0x3580<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>_0x5cef26<span class="token punctuation">,</span> _0x52c0dc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> _0x1d18c7 <span class="token operator">=</span> _0x3580<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> _0x1540ed <span class="token operator">=</span> <span class="token operator">-</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">_0x1d18c7</span><span class="token punctuation">(</span><span class="token number">0x1d4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">_0x1d18c7</span><span class="token punctuation">(</span><span class="token number">0x1d5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token operator">-</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">_0x1d18c7</span><span class="token punctuation">(</span><span class="token number">0x1da</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token operator">-</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">_0x1d18c7</span><span class="token punctuation">(</span><span class="token number">0x1db</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token operator">-</span><span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">_0x1d18c7</span><span class="token punctuation">(</span><span class="token number">0x1df</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">_0x1d18c7</span><span class="token punctuation">(</span><span class="token number">0x1d8</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">_0x1d18c7</span><span class="token punctuation">(</span><span class="token number">0x1dd</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">_0x1d18c7</span><span class="token punctuation">(</span><span class="token number">0x1d6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">_0x1d18c7</span><span class="token punctuation">(</span><span class="token number">0x1dc</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">_0x1d18c7</span><span class="token punctuation">(</span><span class="token number">0x1de</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token function">_0x1d18c7</span><span class="token punctuation">(</span><span class="token number">0x1d3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_0x1540ed <span class="token operator">===</span> _0x52c0dc<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> _0x5cef26<span class="token punctuation">[</span><span class="token string">'push'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>_0x5cef26<span class="token punctuation">[</span><span class="token string">'shift'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">_0x51e61c</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _0x5cef26<span class="token punctuation">[</span><span class="token string">'push'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>_0x5cef26<span class="token punctuation">[</span><span class="token string">'shift'</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span>_0x1dc7<span class="token punctuation">,</span> <span class="token number">0x5141a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">_0x3580</span><span class="token punctuation">(</span>_0x3769d1<span class="token punctuation">,</span> _0x4940d9<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  _0x3769d1 <span class="token operator">=</span> _0x3769d1 <span class="token operator">-</span> <span class="token number">0x1d3</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> _0x1dc7dc <span class="token operator">=</span> _0x1dc7<span class="token punctuation">[</span>_0x3769d1<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> _0x1dc7dc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> times <span class="token operator">=</span> <span class="token number">0.1</span> <span class="token operator">*</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> getExtra <span class="token operator">=</span> _0x4cd659 <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span><span class="token number">0x1</span><span class="token punctuation">,</span> <span class="token number">0x4</span><span class="token punctuation">,</span> <span class="token number">0x6</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'map'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>_0x25d119 <span class="token operator">=</span><span class="token operator">></span> _0x25d119 <span class="token operator">*</span> _0x4cd659<span class="token punctuation">)</span><span class="token punctuation">,</span>
  arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x8</span><span class="token punctuation">,</span> <span class="token number">0x5e</span><span class="token punctuation">,</span> <span class="token number">0xf</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x4c</span><span class="token punctuation">,</span> <span class="token number">0x15</span><span class="token punctuation">,</span> <span class="token number">0x27</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  newArr <span class="token operator">=</span> <span class="token function">getExtra</span><span class="token punctuation">(</span>times<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'concat'</span><span class="token punctuation">]</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token function">_0x84e884</span><span class="token punctuation">(</span><span class="token number">0x1e0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span>_0x42b6c9 <span class="token operator">=</span><span class="token operator">></span> _0x42b6c9 <span class="token operator">*</span> <span class="token number">0x2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  sortarr <span class="token operator">=</span> _0x3d0937 <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> _0x3e9648 <span class="token operator">=</span> _0x84e884<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> _0x584873 <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span> _0x584873 <span class="token operator">&lt;</span> _0x3d0937<span class="token punctuation">[</span><span class="token function">_0x3e9648</span><span class="token punctuation">(</span><span class="token number">0x1d9</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">0x1</span><span class="token punctuation">;</span> _0x584873<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> _0x1bd1d5 <span class="token operator">=</span> <span class="token number">0x0</span><span class="token punctuation">;</span> _0x1bd1d5 <span class="token operator">&lt;</span> _0x3d0937<span class="token punctuation">[</span><span class="token function">_0x3e9648</span><span class="token punctuation">(</span><span class="token number">0x1d9</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">0x1</span> <span class="token operator">-</span> _0x584873<span class="token punctuation">;</span> _0x1bd1d5<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_0x3d0937<span class="token punctuation">[</span>_0x1bd1d5<span class="token punctuation">]</span> <span class="token operator">></span> _0x3d0937<span class="token punctuation">[</span>_0x1bd1d5 <span class="token operator">+</span> <span class="token number">0x1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> _0x2dace4 <span class="token operator">=</span> _0x3d0937<span class="token punctuation">[</span>_0x1bd1d5<span class="token punctuation">]</span><span class="token punctuation">;</span>
          _0x3d0937<span class="token punctuation">[</span>_0x1bd1d5<span class="token punctuation">]</span> <span class="token operator">=</span> _0x3d0937<span class="token punctuation">[</span>_0x1bd1d5 <span class="token operator">+</span> <span class="token number">0x1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> _0x3d0937<span class="token punctuation">[</span>_0x1bd1d5 <span class="token operator">+</span> <span class="token number">0x1</span><span class="token punctuation">]</span> <span class="token operator">=</span> _0x2dace4<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> _0x3d0937<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
console<span class="token punctuation">[</span><span class="token function">_0x84e884</span><span class="token punctuation">(</span><span class="token number">0x1d7</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token function">sortarr</span><span class="token punctuation">(</span>newArr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了尽可能降低原始代码的可读性，较为“专业“的 Obfuscator 会使用很多特殊的手段来“打散”原始 JavaScript 代码的执行逻辑。比如就上述生成的这段代码而言，<em>javascript-obfuscator</em> 在处理时会默认采用以下这些代码混淆策略（部分）：</p>
<ul>
<li><em>stringArray</em>：移除源代码中出现的字符串字面量值，并将它们放置在特殊的数组中，以间接方式引用；</li>
<li><em>rotateStringArray</em>：将用于存放字符串字面量值的 stringArray 数组中的有效元素随机移动固定偏移量，并使该数组中含有随机垃圾；</li>
<li><em>shuffleStringArray</em>：随机打乱 stringArray 数组中的元素：</li>
<li><em>Identifier Names Generator</em>：将源代码中出现的标识符替换为随机的“类十六进制字符串”或其他无意义的标识符形式。</li>
</ul>
<p>除上述这些默认情况下会采用的基本代码混淆策略外，Obfuscator 通常还会使用诸如 “<strong>Control Flow Flattening</strong>” 等更为激进的、代码执行流层面的混淆策略。“<em>Control Flow Flattening</em>” 翻译过来即“控制流扁平化”，该策略会将源代码中的基本块（函数体、循环，以及条件分支语句等）进行拆分，并将它们全部放入一个死循环结构中。而在这个循环结构中，Obfuscator 将通过 <em>switch</em> 语句来控制程序的实际执行流程。通过这种方式，程序的真实执行流程将变得难以跟踪，从而增加了代码逆向工程的难度。</p>
<p>另一方面，由于增加了这些激进的代码处理逻辑，Obfuscator 生成代码的实际执行效率相较于原始代码会相应下降 15% 至 80% 左右，具体依使用的混淆策略不同而有所差异。</p>
<h3 id="沙盒（Sandboxing）"><a href="#沙盒（Sandboxing）" class="headerlink" title="沙盒（Sandboxing）"></a>沙盒（Sandboxing）</h3><p>这种方式的思路也很好理解。其基本形式是将明文的 JavaScript 源代码预先编译为某种 JavaScript VM 实现的内部格式代码，然后将这些内部代码作为对外分发的“源代码”。当在浏览器中执行这些代码时，则需要将完整的 VM 实现托管在浏览器环境中，然后再让 VM 来间接执行这些分发的“内部源代码”。通过这种“间接执行”的方式，实际对外分发的源代码将不再包含任何 JavaScript 代码的语法和语义。而当 VM 的实现变成私有时，这些代码的内部执行细节将无人可知，在某种意义上便可实现真正的“黑盒”。当然，在此期间 VM 将承担一切需要与浏览器交互的任务（DOM 操作、Web API 调用等），因此代码的执行效率会有所降低。上述我们提到的 VM，其内部私有的执行环境便可被理解为“沙盒”。</p>
<p>一个简单的基于沙盒实现的 JavaScript 代码保护机制如下所示：</p>
<p><img src="1.png"></p>
<p>整个流程可以分为两个阶段：</p>
<ul>
<li><strong>第一阶段</strong>：将明文的 JavaScript 源代码通过静态编译转换为基于特定 JavaScript 引擎（VM）的内部中间代码。这些代码可能以二进制或可读文本的形式存在，在某些情况下，可将二进制代码经过 Base64 编码后分发。在这种情况下，编码后的代码体积会增长 25% 左右；</li>
<li><strong>第二阶段</strong>：将上述经过编码的二进制或可读文本代码连同其适用的 VM 实现一同放到浏览器中运行。这时，浏览器将通过运行 VM 来间接执行第一阶段产生的二进制或可读文本代码。通常考虑到性能，浏览器中的 VM 其实现可基于 WebAssembly 字节码或 ASM.js。</li>
</ul>
<p>比如以 <a target="_blank" rel="noopener" href="https://github.com/pando-project/jerryscript">JerryScript</a> 这个开源的轻量级 JavaScript 引擎为例，从其文档中我们可以得知，输入的 JavaScript 代码在被真正执行前会被首先转译成中间状态的 Bytecode 字节码格式，而这些编译好的字节码可以连同附加的元数据一起被组织成 JerryScript 内部的 Snapshot 快照格式，这些 Snapshot 可以被 JerryScript 引擎重新加载而继续执行。因此，这里的 Snapshot 便可作为对外分发的一种内部格式。当然，为了进一步保证中间代码格式的私有性，可以选择自行构建相应的 JavaScript VM，以将中间代码的格式和执行模型私有化。基于 JerryScript 构建的 JavaScript 代码保护 POC 可以参考<b><a target="_blank" rel="noopener" href="https://github.com/Becavalier/Zero">这里</a></b>。</p>
<p><img src="2.png"></p>
<p>如果你有其他可用于前端 JavaScript 代码保护的方案，欢迎补充！</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><em><a target="_blank" rel="noopener" href="http://lisperator.net/uglifyjs/transform">http://lisperator.net/uglifyjs/transform</a>.</em></li>
<li><em><a target="_blank" rel="noopener" href="https://blog.jscrambler.com/jscrambler-101-control-flow-flattening/">https://blog.jscrambler.com/jscrambler-101-control-flow-flattening/</a>.</em></li>
</ol>
<br><div class="article-bottom-meta"><span class="post-meta">Last built on<time itemprop="dateModified" datetime="2019-04-10T08:58:34.000Z"> 2023 / 10 / 26, 11:37:10</time></span></div></div></article><br><span class="next-post"><a href="/2019/04/21/FCC-China-DevTalk-访谈实录/" itemprop="url">下一篇 ⇒</a></span><span class="prev-post"><a href="/2019/03/30/初聊风险投资（VC）/" itemprop="url">⇐ 上一篇</a></span><br><section id="comments"><h4>评论 | Comments</h4><br><script src="https://utteranc.es/client.js" repo="Becavalier/utterances-comments" issue-term="title" label="[Comment]" theme="github-light" crossorigin="anonymous" async></script></section><br><br></main><script src="/scripts/index.js" type="text/javascript"></script></body></html>