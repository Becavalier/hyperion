<!DOCTYPE html><html lang="en-us"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>C++ 字符串拷贝优化策略：Eager-Copy、SSO 与 COW | 曜彤.手记</title><meta name="description" content="在 C++ 中，对于一个类型为 std::string 的字符串对象来说，可以有多种方式来拷贝它所对应的资源。而在这些方法中，最常见的三种为：Eager-Copy、SSO 以及 COW。其中最为广泛使用的是 “SSO”，而其他方式则已大都不再被编译器所使用。"><meta name="generator" content="曜彤.手记"><meta name="about" content="[object Object]"><meta name="keywords" content="博客, C++, C, Rust, Web, Java, IT, 编程, 开发, Android, Python, MySQL, 科技, 黑客, 技术, Javascript, 云, 大数据, 计算, 机器学习, AI, 人工智能, 创业, 产品, 公司, WebAssembly, Wasm"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=0"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.jpg"><link rel="apple-touch-icon" sizes="60x60" href="/images/apple-touch-icon-60x60.jpg"><link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.jpg"><link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.jpg"><link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.jpg"><link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.jpg"><link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.jpg"><link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.jpg"><link rel="apple-touch-icon" sizes="196x196" href="/images/apple-touch-icon-196x196.jpg"><link rel="apple-touch-icon" sizes="310x310" href="/images/apple-touch-icon-310x310.jpg"><link href="/images/splash/iphone5_splash.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphone6_splash.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphoneplus_splash.png" media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/iphonex_splash.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/iphonexr_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphonexsmax_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/ipad_splash.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro1_splash.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro3_splash.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro2_splash.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="128x128" href="/images/favicon-128.png"><link rel="icon" type="image/png" sizes="196x196" href="/images/favicon-196x196.png"><meta name="msapplication-TileColor" content="#FFFFFF"><meta name="msapplication-TileImage" content="mstile-144x144.png"><meta name="msapplication-square70x70logo" content="mstile-70x70.png"><meta name="msapplication-square150x150logo" content="mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="mstile-310x150.png"><meta name="msapplication-square310x310logo" content="mstile-310x310.png"><meta name="msapplication-square310x310logo" content="mstile-310x310.png"><link rel="manifest" href="/manifest.webmanifest"><link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="/atom.xml"><link rel="stylesheet" href="/css/prism-okaidia.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body itemscope itemtype="https://schema.org/WebPage"><div class="canvas-containter"><span>X</span></div><header itemscope itemtype="https://schema.org/WPHeader"><div class="logo"></div><h1 class="title"><a href="/" alt="曜彤.手记" title="曜彤.手记" itemprop="headline">曜彤.手记</a><a title="Atom 0.3" target="__blank" href="/atom.xml" class="rss"><img src="/images/rss.png"></a></h1><p itemprop="description" class="description">随记，关于互联网技术、产品与创业</p><nav itemscope itemtype="https://schema.org/SiteNavigationElement"><ul><li itemprop="name" class="menu-item"><a href="/ " alt="首页" title="首页" itemprop="url">首页</a></li><li itemprop="name" class="menu-item"><a href="/articles" alt="文章" title="文章" itemprop="url">文章</a></li><li itemprop="name" class="menu-item"><a href="/tags" alt="标签" title="标签" itemprop="url">标签</a></li><li itemprop="name" class="menu-item"><a href="/about" alt="关于" title="关于" itemprop="url">关于</a></li></ul></nav><p class="meta-icp"><a target="_blank" href="https://beian.miit.gov.cn/"><span>吉 ICP 备 10004938-2 号</span></a></p><div class="space"></div></header><main itemscope itemtype="https://schema.org/Blog"><script src="https://shadow.elemecdn.com/npm/zoomage.js@latest/dist/zoomage.min.js" type="text/javascript"></script><script src="https://shadow.elemecdn.com/npm/axios@0.18.0/dist/axios.min.js" type="text/javascript"></script><script src="/scripts/post.js" type="text/javascript"></script><div class="touch-top"><span></span></div><article post-id="C++ 字符串拷贝优化策略：Eager-Copy、SSO 与 COW" class="full"><h1 itemprop="headline" class="align-center">C++ 字符串拷贝优化策略：Eager-Copy、SSO 与 COW</h1><div class="content"><div class="article-meta"><span class="post-meta"><br>Created on<time itemprop="dateCreated" datetime="2020-05-24T01:31:12.000Z"> 2020 / 05 / 24, 09:31:12</time></span><span class="page-tag-anchor"><a href="/tags/Cpp" itemprop="url">#Cpp</a>&nbsp;&nbsp;</span></div><p>在 C++ 中，对于一个类型为 std::string 的字符串对象来说，可以有多种方式来拷贝它所对应的资源。而在这些方法中，最常见的三种为：Eager-Copy、SSO 以及 COW。其中最为广泛使用的是 “SSO”，而其他方式则已大都不再被编译器所使用。</p>
<p>首先我们先自定义一个 String 类，用来模拟 std::string 的具体实现（这里仅提供了大致功能，并没有考虑诸如“异常安全”等细节处理）：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
  <span class="token keyword">friend</span> std<span class="token operator">::</span>ostream<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>std<span class="token operator">::</span>ostream<span class="token operator">&amp;</span><span class="token punctuation">,</span> String<span class="token operator">&amp;</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span><span class="token operator">*</span> start <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span><span class="token operator">*</span> end <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span><span class="token operator">*</span> end_of_capacity <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  size_t <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> end <span class="token operator">-</span> start<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  size_t <span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> end_of_capacity <span class="token operator">-</span> start<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> start<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
  <span class="token function">String</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> size_t size <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    start <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span><span class="token function">memcpy</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> str<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    end <span class="token operator">=</span> start <span class="token operator">+</span> size<span class="token punctuation">;</span>
    end_of_capacity <span class="token operator">=</span> end<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">~</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span><span class="token function">free</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    end <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    end_of_capacity <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
std<span class="token operator">::</span>ostream<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>std<span class="token operator">::</span>ostream<span class="token operator">&amp;</span> os<span class="token punctuation">,</span> String<span class="token operator">&amp;</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> i <span class="token operator">=</span> s<span class="token punctuation">.</span>start<span class="token punctuation">;</span> i <span class="token operator">!=</span> s<span class="token punctuation">.</span>end<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span> os <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>i<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">return</span> os<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  String <span class="token function">str</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> str <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
  std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> str<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中最重要的是该类的私有成员变量 start、end 以及 end_of_capacity，这三个成员分别代表了当前字符串对象的<strong>起始位置</strong>、<strong>结束位置</strong>，以及当前<strong>已分配的可用 capacity 的临界位置</strong>。而 data() 函数则负责返回该 String 对象对应的原始 char* 指针。</p>
<h3 id="Eager-Copy"><a href="#Eager-Copy" class="headerlink" title="Eager-Copy"></a>Eager-Copy</h3><p>第一种字符串对象拷贝方式为 “eage-copy”，这种方式采用了最为“暴力”的拷贝方法，即：<strong>深拷贝</strong>。在每次拷贝时将原对象对应的内存以及所持有的动态资源完整地复制一份。这种拷贝方式的<strong>缺点是浪费空间</strong>，但其相对<strong>优点是保证了每个对象的相互独立</strong>。基于该方式对应的 String 实现这里不再赘述。</p>
<h3 id="COW（Copy-On-Write）"><a href="#COW（Copy-On-Write）" class="headerlink" title="COW（Copy On Write）"></a>COW（Copy On Write）</h3><p>第二种字符串对象拷贝方式为 “COW”，即“<strong>写时复制</strong>”。这种拷贝方式使用<strong>引用计数</strong>，当一个对象被拷贝多份时，往往在内存空间中只有一个对象实体，对象中有一个引用计数记录有多少对象指针指向这个实体，当引用计数归零时便自动析构该对象。不仅如此，只有在某个对象指针要对该共享对象进行修改时，编译器才会真正执行对象的拷贝。所以该方式便被称为“写时拷贝”。让我们来修改上述代码来模拟字符串的 COW 拷贝方式。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
  <span class="token keyword">friend</span> std<span class="token operator">::</span>ostream<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>std<span class="token operator">::</span>ostream<span class="token operator">&amp;</span><span class="token punctuation">,</span> String<span class="token operator">&amp;</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">struct</span> Resource <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 将动态资源使用单独的类对象进行管理；</span>
    <span class="token keyword">char</span><span class="token operator">*</span> start<span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> end<span class="token punctuation">;</span>
    <span class="token keyword">char</span><span class="token operator">*</span> end_of_capacity<span class="token punctuation">;</span>
    <span class="token function">Resource</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> size_t size <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
      start <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      std<span class="token operator">::</span><span class="token function">memcpy</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> str<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
      end <span class="token operator">=</span> start <span class="token operator">+</span> size<span class="token punctuation">;</span>
      end_of_capacity <span class="token operator">=</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      std<span class="token operator">::</span><span class="token function">free</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
      end <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
      end_of_capacity <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>Resource<span class="token operator">></span> res<span class="token punctuation">;</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span>std<span class="token operator">::</span>ostream<span class="token operator">&amp;</span> os<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 打印接口（类似 swap 的方式，由类提供实现）；</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> i <span class="token operator">=</span> res<span class="token operator">-</span><span class="token operator">></span>start<span class="token punctuation">;</span> i <span class="token operator">!=</span> res<span class="token operator">-</span><span class="token operator">></span>end<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span> os <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>i<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  size_t <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> res<span class="token operator">-</span><span class="token operator">></span>end <span class="token operator">-</span> res<span class="token operator">-</span><span class="token operator">></span>start<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  size_t <span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> res<span class="token operator">-</span><span class="token operator">></span>end_of_capacity <span class="token operator">-</span> res<span class="token operator">-</span><span class="token operator">></span>start<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> res<span class="token operator">-</span><span class="token operator">></span>start<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">bool</span> <span class="token function">isSharingWith</span><span class="token punctuation">(</span>String<span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> res <span class="token operator">==</span> rhs<span class="token punctuation">.</span>res<span class="token punctuation">;</span> <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// 比较两个 String 对象是否共享一个 Resource 对象；</span>
  <span class="token function">String</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">res</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>Resource<span class="token operator">></span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">String</span><span class="token punctuation">(</span><span class="token keyword">const</span> String<span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span> <span class="token punctuation">{</span> res <span class="token operator">=</span> rhs<span class="token punctuation">.</span>res<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  String<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> String<span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// 赋值操作（会改变数据，需要拷贝新对象）；</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">!=</span> <span class="token operator">&amp;</span>rhs<span class="token punctuation">)</span> <span class="token punctuation">{</span> res <span class="token operator">=</span> rhs<span class="token punctuation">.</span>res<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
std<span class="token operator">::</span>ostream<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>std<span class="token operator">::</span>ostream<span class="token operator">&amp;</span> os<span class="token punctuation">,</span> String<span class="token operator">&amp;</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span> s<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>os<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> os<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  String <span class="token function">strA</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strB</span><span class="token punctuation">(</span>strA<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>boolalpha 
    <span class="token operator">&lt;&lt;</span> strA<span class="token punctuation">.</span><span class="token function">isSharingWith</span><span class="token punctuation">(</span>strB<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true；</span>
  strB <span class="token operator">=</span> <span class="token string">"YHSPY"</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>cout 
    <span class="token operator">&lt;&lt;</span> strA<span class="token punctuation">.</span><span class="token function">isSharingWith</span><span class="token punctuation">(</span>strB<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// false；</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，这里我们为 String 类添加了拷贝相关的成员函数，以及一个用来检测“两个 String 对象是否共享同一个 Resource 资源对象”的成员函数 isSharingWith()。在每一次 String 对象被重新赋值（“=”）时，都会将其内部的 res 指针重定向到新创建的 std::shared_ptr 对象，而该智能指针对象便维护着 String 类内具体使用的、分配在动态内存上的 Resource 字符串资源对象的生命周期。</p>
<p>COW 的大致实现思路在 C++11 中可以参考上述代码，但实际上由于这种方式在其内部存在着共享资源，因此在多线程情况下便<strong>有可能会导致线程安全问题</strong>。不仅如此，由于 COW 需要在字符串进行诸如 []、=、+=、+ 等操作时重新分配内存，而这也违背了 C++11 标准（21.4.1, p6）中对迭代器失效情况的规定。该规定表示<strong>字符串容器在使用 operator[] 操作符时，迭代器（指针）不应该失效</strong>。</p>
<h3 id="SSO（Small-String-Optimization）"><a href="#SSO（Small-String-Optimization）" class="headerlink" title="SSO（Small String Optimization）"></a>SSO（Small String Optimization）</h3><p>最后一种字符串对象可以使用的拷贝优化方式为 SSO，翻译过来即“小字符串优化”。该策略使用的方式是：当字符串长度较小时，将其存放在字符串对象内的<strong>栈内存</strong>中；而当字符串长度大于某个临界值时，则转为使用 “Eager-Copy” 的方式。一个模拟的实现方式如下所示：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
  <span class="token keyword">friend</span> std<span class="token operator">::</span>ostream<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>std<span class="token operator">::</span>ostream<span class="token operator">&amp;</span> os<span class="token punctuation">,</span> String<span class="token operator">&amp;</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">static</span> size_t kLocalSize <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 默认使用 2 * sizeof(nullptr) 大小的栈缓存；</span>
  <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>kLocalSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
  size_t size<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// ... 其他相关的成员变量（这里仅为举例所以省略了）；</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
  <span class="token function">String</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">size</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">strlen</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> kLocalSize<span class="token punctuation">)</span> <span class="token punctuation">{</span> std<span class="token operator">::</span><span class="token function">memcpy</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> str<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span>std<span class="token operator">::</span>ostream<span class="token operator">&amp;</span> os<span class="token punctuation">)</span> <span class="token punctuation">{</span> os <span class="token operator">&lt;&lt;</span> buffer<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
std<span class="token operator">::</span>ostream<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>std<span class="token operator">::</span>ostream<span class="token operator">&amp;</span> os<span class="token punctuation">,</span> String<span class="token operator">&amp;</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span> str<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>os<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> os<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  String <span class="token function">strA</span><span class="token punctuation">(</span><span class="token string">"Hello, world!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">strB</span><span class="token punctuation">(</span>strA<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> strB <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
  std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>strB<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 24；</span>
  std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>boolalpha <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>is_pod<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token operator">::</span>value <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// POD；</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里可以看到，我们将这个 String 对象保持为一个 POD 类型，并且将其尺寸固定为本机数据总线（64位 -&gt; 8Byte）的长度。这样整个 String 类便可以被编译器优化，可以使用最少的 CPU 指令来完成对象的拷贝过程。当然，除此之外我们还可以通过其他很多的优化，来提升 String 可以在的对象栈缓存中容纳的字符串最大长度（例如：可以把成员 size 没有用到的 bit 作为 buffer 的一部分来存储字符数据）。</p>
<p>BTW. Facebook 自研的 <em><strong><a target="_blank" rel="noopener" href="https://github.com/facebook/folly/blob/master/folly/docs/FBString.md">FBString</a></strong></em> 便使用了上述我们介绍的全部三种字符串拷贝优化方式来分别处理不同长度的字符串，并且还同时保证了字符串在进行 COW 时的线程安全：</p>
<ul>
<li>Small strings (&lt;= 23 chars) are stored in-situ without memory allocation.</li>
<li>Medium strings (24 - 255 chars) are stored in malloc-allocated memory and copied eagerly.</li>
<li>Large strings (&gt; 255 chars) are stored in malloc-allocated memory and copied lazily.</li>
</ul>
<p>写了一个基本的实现，可以参考<b><a target="_blank" rel="noopener" href="https://github.com/Becavalier/YHString">这里</a></b>。</p>
<br><div class="article-bottom-meta"><span class="post-meta">Last built on<time itemprop="dateModified" datetime="2020-05-24T01:31:12.000Z"> 2023 / 04 / 21, 10:01:04</time></span></div></div></article><br><span class="next-post"><a href="/2020/05/25/C-17-部分新特性一览/" itemprop="url">下一篇 ⇒</a></span><span class="prev-post"><a href="/2020/05/23/Effective-Modern-C-读书笔记（二）/" itemprop="url">⇐ 上一篇</a></span><br><br><br><br><br></main><script src="/scripts/index.js" type="text/javascript"></script></body></html>