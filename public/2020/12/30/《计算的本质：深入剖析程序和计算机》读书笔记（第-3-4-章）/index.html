<!DOCTYPE html><html lang="en-us"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>《计算的本质：深入剖析程序和计算机》读书笔记（第 3-4 章） | 曜彤.手记</title><meta name="description" content="书接上回，本文为第 3-4 章的笔记。"><meta name="generator" content="曜彤.手记"><meta name="about" content="[object Object]"><meta name="keywords" content="博客, C++, C, Rust, Web, Java, IT, 编程, 开发, Android, Python, MySQL, 科技, 黑客, 技术, Javascript, 云, 大数据, 计算, 机器学习, AI, 人工智能, 创业, 产品, 公司, WebAssembly, Wasm"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=0"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.jpg"><link rel="apple-touch-icon" sizes="60x60" href="/images/apple-touch-icon-60x60.jpg"><link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.jpg"><link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.jpg"><link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.jpg"><link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.jpg"><link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.jpg"><link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.jpg"><link rel="apple-touch-icon" sizes="196x196" href="/images/apple-touch-icon-196x196.jpg"><link rel="apple-touch-icon" sizes="310x310" href="/images/apple-touch-icon-310x310.jpg"><link href="/images/splash/iphone5_splash.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphone6_splash.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphoneplus_splash.png" media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/iphonex_splash.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/iphonexr_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphonexsmax_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/ipad_splash.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro1_splash.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro3_splash.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro2_splash.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="128x128" href="/images/favicon-128.png"><link rel="icon" type="image/png" sizes="196x196" href="/images/favicon-196x196.png"><meta name="msapplication-TileColor" content="#FFFFFF"><meta name="msapplication-TileImage" content="mstile-144x144.png"><meta name="msapplication-square70x70logo" content="mstile-70x70.png"><meta name="msapplication-square150x150logo" content="mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="mstile-310x150.png"><meta name="msapplication-square310x310logo" content="mstile-310x310.png"><meta name="msapplication-square310x310logo" content="mstile-310x310.png"><link rel="manifest" href="/manifest.webmanifest"><link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="/atom.xml"><link rel="stylesheet" href="/css/prism-okaidia.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body itemscope itemtype="https://schema.org/WebPage"><div class="canvas-containter"><span>X</span></div><header itemscope itemtype="https://schema.org/WPHeader"><div class="logo"></div><h1 class="title"><a href="/" alt="曜彤.手记" title="曜彤.手记" itemprop="headline">曜彤.手记</a><a title="Atom 0.3" target="__blank" href="/atom.xml" class="rss"><img src="/images/rss.png"></a></h1><p itemprop="description" class="description">随记，关于互联网技术、产品与创业</p><nav itemscope itemtype="https://schema.org/SiteNavigationElement"><ul><li itemprop="name" class="menu-item"><a href="/ " alt="首页" title="首页" itemprop="url">首页</a></li><li itemprop="name" class="menu-item"><a href="/articles" alt="文章" title="文章" itemprop="url">文章</a></li><li itemprop="name" class="menu-item"><a href="/readings" alt="阅读" title="阅读" itemprop="url">阅读</a></li><li itemprop="name" class="menu-item"><a href="/cards" alt="快记" title="快记" itemprop="url">快记</a></li><li itemprop="name" class="menu-item"><a href="/tags" alt="标签" title="标签" itemprop="url">标签</a></li><li itemprop="name" class="menu-item"><a href="/about" alt="关于" title="关于" itemprop="url">关于</a></li></ul></nav><div class="toc-body"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC-3-%E7%AB%A0-%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E8%AE%A1%E7%AE%97%E6%9C%BA"><span class="toc-text">第 3 章 - 最简单的计算机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC-4-%E7%AB%A0-%E5%A2%9E%E5%8A%A0%E8%AE%A1%E7%AE%97%E8%83%BD%E5%8A%9B"><span class="toc-text">第 4 章 - 增加计算能力</span></a></li></ol><div class="bookmark"></div></div><div class="space"></div></header><main itemscope itemtype="https://schema.org/Blog"><script src="https://shadow.elemecdn.com/npm/zoomage.js@latest/dist/zoomage.min.js" type="text/javascript"></script><script src="https://shadow.elemecdn.com/npm/axios@0.18.0/dist/axios.min.js" type="text/javascript"></script><script src="/scripts/post.js" type="text/javascript"></script><div class="touch-top"><span></span></div><article post-id="《计算的本质：深入剖析程序和计算机》读书笔记（第 3-4 章）" class="full"><h1 itemprop="headline" class="align-center">《计算的本质：深入剖析程序和计算机》读书笔记（第 3-4 章）</h1><div class="content"><div class="article-meta"><span class="post-meta"><br>Created on<time itemprop="dateCreated" datetime="2020-12-29T16:29:40.000Z"> 2020 / 12 / 30, 00:29:40</time></span><span class="page-tag-anchor"><a href="/tags/编程语言" itemprop="url">#编程语言</a>&nbsp;&nbsp;</span></div><p>书接上回，本文为第 3-4 章的笔记。</p>
<h3 id="第-3-章-最简单的计算机"><a href="#第-3-章-最简单的计算机" class="headerlink" title="第 3 章 - 最简单的计算机"></a>第 3 章 - 最简单的计算机</h3><ol start="11">
<li><span class="pn">Page 59</span>“<strong>有限状态机</strong>（aka. “有限自动机”）”是一台计算机的极简模型；</li>
</ol>
<ul>
<li>只有一个外部的字符输入流，可以一次读取一个字符（<strong>符号</strong>）；</li>
<li>没有持久化的存储，且几乎没有 RAM；</li>
<li>硬编码的“<strong>规则集合</strong>”，决定在相应输入下如何从一个状态切换到另一个状态；</li>
<li>DFA 的“确定性”：<ul>
<li><em><strong>没有冲突</strong></em>：一个状态对于同样的输入，不能有多个规则；</li>
<li><em><strong>没有遗漏</strong></em>：每个状态都必须针对每个可能的输入字符有至少一个规则。</li>
</ul>
</li>
</ul>
<p>- <em><strong>一个简易的 DFA（确定性有限自动机）</strong></em>：</p>
<p><img src="1.png"></p>
<ul>
<li>上图中状态 “2” 为<strong>接受状态</strong>；</li>
<li>机器接受任何奇数个数的 “a” 组成的字符串（可进行的计算）。</li>
</ul>
<p><img src="2.png"></p>
<p>- <em><strong>使用“规则手册（转移函数）”模拟 DFA 行为</strong></em>：</p>
<pre class="line-numbers language-ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">FARule</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:state</span><span class="token punctuation">,</span> <span class="token symbol">:char</span><span class="token punctuation">,</span> <span class="token symbol">:next_state</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> applies_to<span class="token operator">?</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> char<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 指示规则是否可用；</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>state <span class="token operator">==</span> state <span class="token operator">&amp;&amp;</span> <span class="token keyword">self</span><span class="token punctuation">.</span>char <span class="token operator">==</span> char
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> follow  <span class="token comment" spellcheck="true"># 返回某个规则应用后的下一个状态；</span>
    next_state
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> inspect
    <span class="token string">"#&lt;FARule <span class="token interpolation"><span class="token delimiter tag">#{</span>state<span class="token punctuation">.</span>inspect<span class="token delimiter tag">}</span></span> -- <span class="token interpolation"><span class="token delimiter tag">#{</span>char<span class="token delimiter tag">}</span></span> --> <span class="token interpolation"><span class="token delimiter tag">#{</span>next_state<span class="token punctuation">.</span>inspect<span class="token delimiter tag">}</span></span>>"</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">DFARuleBook</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:rules</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> <span class="token function">next_state</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> char<span class="token punctuation">)</span>
    <span class="token function">rule_for</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> char<span class="token punctuation">)</span><span class="token punctuation">.</span>follow
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token function">rule_for</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> char<span class="token punctuation">)</span>
    rules<span class="token punctuation">.</span>detect <span class="token punctuation">{</span> <span class="token operator">|</span>rule<span class="token operator">|</span> rule<span class="token punctuation">.</span>applies_to<span class="token operator">?</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> char<span class="token punctuation">)</span> <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true"># 找不到规则，则返回 nil（确定性）；</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">DFA</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:current_state</span><span class="token punctuation">,</span> <span class="token symbol">:accept_states</span><span class="token punctuation">,</span> <span class="token symbol">:rulebook</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> accepting<span class="token operator">?</span>
    accept_states<span class="token punctuation">.</span>include<span class="token operator">?</span><span class="token punctuation">(</span>current_state<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token function">read_char</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>current_state <span class="token operator">=</span> rulebook<span class="token punctuation">.</span><span class="token function">next_state</span><span class="token punctuation">(</span>current_state<span class="token punctuation">,</span> char<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token function">read_string</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
    str<span class="token punctuation">.</span>chars<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>char<span class="token operator">|</span>
      <span class="token function">read_char</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
rulebook <span class="token operator">=</span> <span class="token constant">DFARuleBook</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
  <span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
  <span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
  <span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
  <span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
  <span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
dfa <span class="token operator">=</span> <span class="token constant">DFA</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rulebook<span class="token punctuation">)</span>
dfa<span class="token punctuation">.</span><span class="token function">read_string</span><span class="token punctuation">(</span><span class="token string">'baaab'</span><span class="token punctuation">)</span>
puts dfa<span class="token punctuation">.</span>accepting<span class="token operator">?</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="12">
<li><span class="pn">Page 65</span>非确定性有限自动机（<strong>NFA</strong>）：</li>
</ol>
<ul>
<li>对于<strong>每一个输入序列有多条执行路径（规则）</strong>；</li>
<li>在向下一个状态转移时会<strong>有多种可能性</strong>，或<strong>有时根本无法转移</strong>，即进入到一个错误状态（卡死状态）；</li>
<li>能被“有限自动机”识别的语言称为“<strong>正则语言</strong>”。</li>
</ul>
<p>- <em><strong>一个简易的 NFA</strong></em>：</p>
<p><img src="3.png"></p>
<p>- <em><strong>模拟 NFA 行为</strong></em>：</p>
<ul>
<li>通过跟踪一台 NFA 当前<strong>所有可能的状态</strong>来模拟一台简单的 NFA；</li>
<li>可以通过 <strong>DFS</strong> 或“<strong>线程分叉</strong>”来找到一条输入序列可以被 NFA 接受的详细“路径”。但若不需知道路径的详情，可以仅通过查询每一个字符输入时的“<strong>状态集合变化</strong>”来判断输入序列可否被接受。</li>
</ul>
<pre class="line-numbers language-ruby"><code class="language-ruby"><span class="token keyword">require</span> <span class="token string">'set'</span>
<span class="token keyword">class</span> <span class="token class-name">NFARuleBook</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:rules</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> <span class="token function">next_states</span><span class="token punctuation">(</span>states<span class="token punctuation">,</span> char<span class="token punctuation">)</span>
    states<span class="token punctuation">.</span>flat_map <span class="token punctuation">{</span> <span class="token operator">|</span>state<span class="token operator">|</span> <span class="token function">follow_rules_for</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> char<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>to_set
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token function">follow_rules_for</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> char<span class="token punctuation">)</span>
    <span class="token function">rules_for</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> char<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token symbol">:follow</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 返回 “next_state”；</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token function">rules_for</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> char<span class="token punctuation">)</span>
    rules<span class="token punctuation">.</span>select <span class="token punctuation">{</span> <span class="token operator">|</span>rule<span class="token operator">|</span> rule<span class="token punctuation">.</span>applies_to<span class="token operator">?</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> char<span class="token punctuation">)</span> <span class="token punctuation">}</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">NFA</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:current_states</span><span class="token punctuation">,</span> <span class="token symbol">:accept_states</span><span class="token punctuation">,</span> <span class="token symbol">:rulebook</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> accepting<span class="token operator">?</span>
    <span class="token punctuation">(</span>current_states <span class="token operator">&amp;</span> accept_states<span class="token punctuation">)</span><span class="token punctuation">.</span>any<span class="token operator">?</span>  <span class="token comment" spellcheck="true"># 判断当前可能的状态集合与“接受状态”是否有交集？</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token function">read_char</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>current_states <span class="token operator">=</span> rulebook<span class="token punctuation">.</span><span class="token function">next_states</span><span class="token punctuation">(</span>current_states<span class="token punctuation">,</span> char<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token function">read_string</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
    str<span class="token punctuation">.</span>chars<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>char<span class="token operator">|</span>
      <span class="token function">read_char</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>- <em><strong>自由移动（Free Move，ε-moves）</strong></em>：</p>
<ul>
<li>NFA-ε；</li>
<li>让机器<strong>无需读取任何输入就能自发遵照执行</strong>；</li>
<li><strong>可用于组合单体 NFA</strong>（应用于“正则表达式”的解析中）。</li>
</ul>
<p><img src="4.png"></p>
<ul>
<li>这里可以使用 <code>nil</code> 来代替触发“自由移动”的“输入”（实际上无需任何输入）；</li>
</ul>
<pre class="line-numbers language-ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">NFARuleBook</span>
  <span class="token keyword">def</span> <span class="token function">follow_free_moves</span><span class="token punctuation">(</span>states<span class="token punctuation">)</span>
    more_states <span class="token operator">=</span> <span class="token function">next_states</span><span class="token punctuation">(</span>states<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> more_states<span class="token punctuation">.</span>subset<span class="token operator">?</span><span class="token punctuation">(</span>states<span class="token punctuation">)</span>
      states
    <span class="token keyword">else</span>
      <span class="token function">follow_free_moves</span><span class="token punctuation">(</span>states <span class="token operator">+</span> more_states<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 递归查找所有可能；</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">NFA</span>
  <span class="token keyword">def</span> current_states  <span class="token comment" spellcheck="true"># 覆盖原有属性（动态属性）；</span>
    rulebook<span class="token punctuation">.</span><span class="token function">follow_free_moves</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>- <em><strong>一个 NFA 对象的封装</strong></em>：</p>
<pre class="line-numbers language-ruby"><code class="language-ruby"><span class="token keyword">class</span> <span class="token class-name">NFADesign</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:start_state</span><span class="token punctuation">,</span> <span class="token symbol">:accept_states</span><span class="token punctuation">,</span> <span class="token symbol">:rulebook</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> accepts<span class="token operator">?</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
    to_nfa<span class="token punctuation">.</span>tap <span class="token punctuation">{</span> <span class="token operator">|</span>nfa<span class="token operator">|</span> nfa<span class="token punctuation">.</span><span class="token function">read_string</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>accepting<span class="token operator">?</span>  <span class="token comment" spellcheck="true"># "tap" 方法对代码块求值，并返回调用它的对象；</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token function">to_nfa</span><span class="token punctuation">(</span>current_states <span class="token operator">=</span> <span class="token constant">Set</span><span class="token punctuation">[</span>start_state<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token constant">NFA</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>current_states<span class="token punctuation">,</span> accept_states<span class="token punctuation">,</span> rulebook<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="13">
<li><span class="pn">Page 74</span><strong>正则表达式</strong>：NFA 的一个重要应用，<strong>每一个与正则表达式匹配的字符串都能被其对应的 NFA 接受</strong>。可以将 NFA 理解为正则的一个“指称语义”；</li>
</ol>
<ul>
<li>大多数现实中的正则库会使用“<strong>回溯算法</strong>”而非转换为 NFA 来更直接地处理正则表达式。</li>
</ul>
<p>- <em><strong>空（Empty）</strong></em>：</p>
<p><img src="8.png"></p>
<p>- <em><strong>单字符（Literal）</strong></em>：</p>
<p><img src="9.png"></p>
<p>- <em><strong>连接（Concatenate）</strong></em>：</p>
<p><img src="5.png"></p>
<ul>
<li><strong>直接将两个 NFA 按顺序连接到一起，用“自由移动”把它们联结在一起</strong>，并保留第二个 NFA 的接受状态；</li>
<li>该组合机器的结构：<ul>
<li>第一个 NFA 的起始状态；</li>
<li>第二个 NFA 的接受状态；</li>
<li>两台 NFA 的所有规则；</li>
<li>一些额外的“自由移动”，可以将两个 NFA 连接起来。</li>
</ul>
</li>
</ul>
<p>- <em><strong>选择（Choose）</strong></em>：</p>
<p><img src="6.png"></p>
<ul>
<li><strong>增加一个新的起始状态，并通过“自由移动”将两台 NFA 连接起来</strong>；</li>
<li>该组合机器的结构：<ul>
<li>一个新的起始状态；</li>
<li>两台 NFA 的所有接受状态；</li>
<li>两台 NFA 的所有规则；</li>
<li>两个额外的“自由移动”，可以将两个 NFA 连接起来。</li>
</ul>
</li>
</ul>
<p>- <em><strong>重复（Repeat）</strong></em>：</p>
<p><img src="7.png"></p>
<ul>
<li><strong>从它的接受状态到开始状态增加一个自由移动</strong>（可以匹配多个）；</li>
<li><strong>增加一个可自由移动到旧的开始状态的新状态，并使其作为接受状态</strong>（可以匹配空字符串）；</li>
<li>该组合机器的结构：<ul>
<li>一个新的起始状态，它也是一个接受状态；</li>
<li>旧的 NFA 中的所有接受状态；</li>
<li>旧的 NFA 中所有的规则；</li>
<li>一些额外的“自由移动”，把旧的 NFA 的<strong>每一个接受状态</strong>与旧的起始状态连接起来；</li>
<li>另一些“自由移动”，把新的起始状态与旧的起始状态连接起来。</li>
</ul>
</li>
</ul>
<p>- <em><strong>定义正则表达式 AST 上的相关类</strong></em>：</p>
<pre class="line-numbers language-ruby"><code class="language-ruby"><span class="token keyword">module</span> <span class="token constant">Pattern</span>
  <span class="token keyword">def</span> <span class="token function">bracket</span><span class="token punctuation">(</span>outer_precedence<span class="token punctuation">)</span>
    <span class="token keyword">if</span> precedence <span class="token operator">&lt;</span> outer_precedence
      <span class="token string">'('</span> <span class="token operator">+</span> to_s <span class="token operator">+</span> <span class="token string">')'</span>
    <span class="token keyword">else</span>
      to_s
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> inspect
    <span class="token string">"/<span class="token interpolation"><span class="token delimiter tag">#{</span><span class="token keyword">self</span><span class="token delimiter tag">}</span></span>/"</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">Empty</span>  <span class="token comment" spellcheck="true"># 基本正则元素；</span>
  include <span class="token constant">Pattern</span>
  <span class="token keyword">def</span> to_nfa_design  <span class="token comment" spellcheck="true"># 转换到对应的 NFA；</span>
    start_state <span class="token operator">=</span> <span class="token builtin">Object</span><span class="token punctuation">.</span><span class="token keyword">new</span>
    <span class="token class-name">accept_states</span> <span class="token operator">=</span> <span class="token punctuation">[</span>start_state<span class="token punctuation">]</span>
    rulebook <span class="token operator">=</span> <span class="token constant">NFARuleBook</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token constant">NFADesign</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>start_state<span class="token punctuation">,</span> accept_states<span class="token punctuation">,</span> rulebook<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> to_s
    <span class="token string">''</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> precedence
    <span class="token number">3</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">Literal</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:char</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 基本正则元素；</span>
  include <span class="token constant">Pattern</span>
  <span class="token keyword">def</span> to_nfa_design  <span class="token comment" spellcheck="true"># 转换到对应的 NFA；</span>
    start_state <span class="token operator">=</span> <span class="token builtin">Object</span><span class="token punctuation">.</span><span class="token keyword">new</span>
    <span class="token class-name">accept_states</span> <span class="token operator">=</span> <span class="token builtin">Object</span><span class="token punctuation">.</span><span class="token keyword">new</span>
    <span class="token class-name">rule</span> <span class="token operator">=</span> <span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>start_state<span class="token punctuation">,</span> char<span class="token punctuation">,</span> accept_states<span class="token punctuation">)</span>
    rulebook <span class="token operator">=</span> <span class="token constant">NFARuleBook</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span>rule<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token constant">NFADesign</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>start_state<span class="token punctuation">,</span> <span class="token punctuation">[</span>accept_states<span class="token punctuation">]</span><span class="token punctuation">,</span> rulebook<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> to_s
    char
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> precedence
    <span class="token number">3</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">Concatenate</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:first</span><span class="token punctuation">,</span> <span class="token symbol">:second</span><span class="token punctuation">)</span>
  include <span class="token constant">Pattern</span>
  <span class="token keyword">def</span> to_nfa_design
    first_nfa_design <span class="token operator">=</span> first<span class="token punctuation">.</span>to_nfa_design
    second_nfa_design <span class="token operator">=</span> second<span class="token punctuation">.</span>to_nfa_design
    <span class="token comment" spellcheck="true"># 第一个 NFA 的起始状态；</span>
    start_state <span class="token operator">=</span> first_nfa_design<span class="token punctuation">.</span>start_state
    <span class="token comment" spellcheck="true"># 第二个 NFA 的接受状态；</span>
    accept_states <span class="token operator">=</span> second_nfa_design<span class="token punctuation">.</span>accept_states
    <span class="token comment" spellcheck="true"># 两台 NFA 的所有规则；</span>
    rules <span class="token operator">=</span> first_nfa_design<span class="token punctuation">.</span>rulebook<span class="token punctuation">.</span>rules <span class="token operator">+</span> second_nfa_design<span class="token punctuation">.</span>rulebook<span class="token punctuation">.</span>rules
    <span class="token comment" spellcheck="true"># 额外的“自由移动”；</span>
    extra_rules <span class="token operator">=</span> first_nfa_design<span class="token punctuation">.</span>accept_states<span class="token punctuation">.</span>map <span class="token punctuation">{</span> 
      <span class="token operator">|</span>state<span class="token operator">|</span> <span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> second_nfa_design<span class="token punctuation">.</span>start_state<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    rulebook <span class="token operator">=</span> <span class="token constant">NFARuleBook</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>rules <span class="token operator">+</span> extra_rules<span class="token punctuation">)</span>
    <span class="token constant">NFADesign</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>start_state<span class="token punctuation">,</span> accept_states<span class="token punctuation">,</span> rulebook<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> to_s
    <span class="token punctuation">[</span>first<span class="token punctuation">,</span> second<span class="token punctuation">]</span><span class="token punctuation">.</span>map <span class="token punctuation">{</span> <span class="token operator">|</span>pattern<span class="token operator">|</span> pattern<span class="token punctuation">.</span><span class="token function">bracket</span><span class="token punctuation">(</span>precedence<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>join
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> precedence
    <span class="token number">1</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">Choose</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:first</span><span class="token punctuation">,</span> <span class="token symbol">:second</span><span class="token punctuation">)</span>
  include <span class="token constant">Pattern</span>
  <span class="token keyword">def</span> to_nfa_design
    first_nfa_design <span class="token operator">=</span> first<span class="token punctuation">.</span>to_nfa_design 
    second_nfa_design <span class="token operator">=</span> second<span class="token punctuation">.</span>to_nfa_design
    <span class="token comment" spellcheck="true"># 一个新的起始状态；</span>
    start_state <span class="token operator">=</span> <span class="token builtin">Object</span><span class="token punctuation">.</span><span class="token keyword">new</span>
    <span class="token comment" spellcheck="true"># 两台 NFA 的所有接受状态；</span>
    accept_states <span class="token operator">=</span> first_nfa_design<span class="token punctuation">.</span>accept_states <span class="token operator">+</span> second_nfa_design<span class="token punctuation">.</span>accept_states 
    <span class="token comment" spellcheck="true"># 两台 NFA 的所有规则；</span>
    rules <span class="token operator">=</span> first_nfa_design<span class="token punctuation">.</span>rulebook<span class="token punctuation">.</span>rules <span class="token operator">+</span> second_nfa_design<span class="token punctuation">.</span>rulebook<span class="token punctuation">.</span>rules 
    <span class="token comment" spellcheck="true"># 两个额外的“自由移动”，可以将两个 NFA 连接起来；</span>
    extra_rules <span class="token operator">=</span> <span class="token punctuation">[</span>first_nfa_design<span class="token punctuation">,</span> second_nfa_design<span class="token punctuation">]</span><span class="token punctuation">.</span>map <span class="token punctuation">{</span> 
      <span class="token operator">|</span>nfa_design<span class="token operator">|</span> <span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>start_state<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> nfa_design<span class="token punctuation">.</span>start_state<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
    rulebook <span class="token operator">=</span> <span class="token constant">NFARuleBook</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>rules <span class="token operator">+</span> extra_rules<span class="token punctuation">)</span>
    <span class="token constant">NFADesign</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>start_state<span class="token punctuation">,</span> accept_states<span class="token punctuation">,</span> rulebook<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> to_s
    <span class="token punctuation">[</span>first<span class="token punctuation">,</span> second<span class="token punctuation">]</span><span class="token punctuation">.</span>map <span class="token punctuation">{</span> <span class="token operator">|</span>pattern<span class="token operator">|</span> pattern<span class="token punctuation">.</span><span class="token function">bracket</span><span class="token punctuation">(</span>precedence<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> precedence
    <span class="token number">0</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">Repeat</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:pattern</span><span class="token punctuation">)</span>
  include <span class="token constant">Pattern</span>
  <span class="token keyword">def</span> to_nfa_design
    pattern_nfa_design <span class="token operator">=</span> pattern<span class="token punctuation">.</span>to_nfa_design
    <span class="token comment" spellcheck="true"># 一个新的起始状态，它也是一个接受状态；</span>
    start_state <span class="token operator">=</span> <span class="token builtin">Object</span><span class="token punctuation">.</span><span class="token keyword">new</span>
    <span class="token comment" spellcheck="true"># 旧的 NFA 中的所有接受状态；</span>
    accept_states <span class="token operator">=</span> pattern_nfa_design<span class="token punctuation">.</span>accept_states <span class="token operator">+</span> <span class="token punctuation">[</span>start_state<span class="token punctuation">]</span>
    <span class="token comment" spellcheck="true"># 旧的 NFA 中所有的规则；</span>
    rules <span class="token operator">=</span> pattern_nfa_design<span class="token punctuation">.</span>rulebook<span class="token punctuation">.</span>rules
    <span class="token comment" spellcheck="true"># 一些额外的“自由移动”，把旧的 NFA 的每一个接受状态与旧的起始状态连接起来；</span>
    extra_rules <span class="token operator">=</span> pattern_nfa_design<span class="token punctuation">.</span>accept_states<span class="token punctuation">.</span>map <span class="token punctuation">{</span> 
      <span class="token operator">|</span>accept_state<span class="token operator">|</span> <span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>accept_state<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> pattern_nfa_design<span class="token punctuation">.</span>start_state<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token operator">+</span>
    <span class="token comment" spellcheck="true"># 另一些“自由移动”，把新的起始状态与旧的起始状态连接起来；</span>
    <span class="token punctuation">[</span><span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>start_state<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> pattern_nfa_design<span class="token punctuation">.</span>start_state<span class="token punctuation">)</span><span class="token punctuation">]</span> 
    
    rulebook <span class="token operator">=</span> <span class="token constant">NFARuleBook</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>rules <span class="token operator">+</span> extra_rules<span class="token punctuation">)</span>
    <span class="token constant">NFADesign</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>start_state<span class="token punctuation">,</span> accept_states<span class="token punctuation">,</span> rulebook<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> to_s
    pattern<span class="token punctuation">.</span><span class="token function">bracket</span><span class="token punctuation">(</span>precedence<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'*'</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> precedence
    <span class="token number">2</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
pattern <span class="token operator">=</span> <span class="token constant">Repeat</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>
  <span class="token constant">Concatenate</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>
    <span class="token constant">Literal</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token constant">Choose</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token constant">Empty</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">,</span> <span class="token constant">Literal</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
puts pattern<span class="token punctuation">.</span>to_nfa_design<span class="token punctuation">.</span>accepts<span class="token operator">?</span><span class="token punctuation">(</span><span class="token string">'abaab'</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="14">
<li><span class="pn">Page 89</span><strong>NFA 到 DFA 的转换</strong>：</li>
</ol>
<ul>
<li>把任何 NFA 转成接受完全相同字符串的 DFA 是可能的；</li>
<li>DFA 的行为与其模拟是<strong>一一对应</strong>的，即“完全匹配”。而 NFA 的模拟只能描述其行为中的“一条路径”，即“可能状态的集合”之间的移动；</li>
<li>最坏情况下，一台有 n 个状态的 NFA 可能需要 <strong>2^n</strong> 个状态的 DFA；</li>
<li><strong>DFA 比 NFA 更容易模拟，且用硬件或机器代码实现起来足够简单</strong>。因此通常可以先将一个概念（比如“正则”）转换为 NFA，再转换为 DFA，最后被快速实现；</li>
<li><strong>DFA 最小化</strong>：即所持有<strong>状态是最少的</strong> DFA。从 NFA 到 DFA 的转换有时会产生包含冗余状态的“非最小化 DFA”，此时可以通过 “<strong>Brzozowski</strong>” 算法来进行优化。可以通过最小化的 DFA 来判断两个 NFA 的等价性。</li>
</ul>
<p>- <em><strong>一个例子</strong></em>：</p>
<ul>
<li>NFA：</li>
</ul>
<p><img src="10.png"></p>
<ul>
<li>对应的 DFA：<ul>
<li><em>follow_free_moves</em> 会在每次查找下一个状态集合后，收集所有可以再次通过 “ε-moves” 得到的新状态。并将此作为下一次查询的输入状态。</li>
</ul>
</li>
</ul>
<p><img src="13.png"></p>
<pre class="line-numbers language-ruby"><code class="language-ruby">rulebook <span class="token operator">=</span> <span class="token constant">NFARulebook</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
  <span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
  <span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
  <span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
  <span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">NFASimulation</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:nfa_design</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> <span class="token function">next_state</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> char<span class="token punctuation">)</span>
    nfa_design<span class="token punctuation">.</span><span class="token function">to_nfa</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span>tap <span class="token punctuation">{</span> <span class="token operator">|</span>nfa<span class="token operator">|</span>
      nfa<span class="token punctuation">.</span><span class="token function">read_char</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span>current_states
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
nfa_design <span class="token operator">=</span> <span class="token constant">NFADesign</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rulebook<span class="token punctuation">)</span>
simulation <span class="token operator">=</span> <span class="token constant">NFASimulation</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>nfa_design<span class="token punctuation">)</span>
puts simulation<span class="token punctuation">.</span><span class="token function">next_state</span><span class="token punctuation">(</span><span class="token constant">Set</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">#&lt;Set: {1, 2}>.</span>

<span class="token keyword">class</span> <span class="token class-name">NFARuleBook</span>
  <span class="token keyword">def</span> alphabet
    rules<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token symbol">:char</span><span class="token punctuation">)</span><span class="token punctuation">.</span>compact<span class="token punctuation">.</span>uniq
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">NFASimulation</span>
  <span class="token keyword">def</span> <span class="token function">rules_for</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>
    nfa_design<span class="token punctuation">.</span>rulebook<span class="token punctuation">.</span>alphabet<span class="token punctuation">.</span>map <span class="token punctuation">{</span> <span class="token operator">|</span>char<span class="token operator">|</span>
      <span class="token constant">FARule</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> char<span class="token punctuation">,</span> <span class="token function">next_state</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> char<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token function">discover_states_and_rules</span><span class="token punctuation">(</span>states<span class="token punctuation">)</span>
    rules <span class="token operator">=</span> states<span class="token punctuation">.</span>flat_map <span class="token punctuation">{</span> <span class="token operator">|</span>state<span class="token operator">|</span> <span class="token function">rules_for</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    more_states <span class="token operator">=</span> rules<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token symbol">:follow</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_set
    <span class="token keyword">if</span> more_states<span class="token punctuation">.</span>subset<span class="token operator">?</span><span class="token punctuation">(</span>states<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 检查 more_states 是否是 states 的子集（意味着已经找到了全部状态）；</span>
      <span class="token punctuation">[</span>states<span class="token punctuation">,</span> rules<span class="token punctuation">]</span>
    <span class="token keyword">else</span>
      <span class="token function">discover_states_and_rules</span><span class="token punctuation">(</span>states <span class="token operator">+</span> more_states<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 递归找到所有路径；</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> to_dfa
    start_state <span class="token operator">=</span> nfa_design<span class="token punctuation">.</span>to_nfa<span class="token punctuation">.</span>current_states
    states<span class="token punctuation">,</span> rules <span class="token operator">=</span> <span class="token function">discover_states_and_rules</span><span class="token punctuation">(</span><span class="token constant">Set</span><span class="token punctuation">[</span>start_state<span class="token punctuation">]</span><span class="token punctuation">)</span>
    accept_states <span class="token operator">=</span> states<span class="token punctuation">.</span>select <span class="token punctuation">{</span> <span class="token operator">|</span>state<span class="token operator">|</span> nfa_design<span class="token punctuation">.</span><span class="token function">to_nfa</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">.</span>accepting<span class="token operator">?</span> <span class="token punctuation">}</span>
    <span class="token constant">DFA</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>start_state<span class="token punctuation">,</span> accept_states<span class="token punctuation">,</span> <span class="token constant">DFARuleBook</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>

dfa <span class="token operator">=</span> simulation<span class="token punctuation">.</span>to_dfa
<span class="token comment" spellcheck="true">#&lt;struct FARule state=#&lt;Set: {1, 2}>, character="a", next_state=#&lt;Set: {1, 2}>></span>
<span class="token comment" spellcheck="true">#&lt;struct FARule state=#&lt;Set: {1, 2}>, character="b", next_state=#&lt;Set: {3, 2}>></span>
<span class="token comment" spellcheck="true">#&lt;struct FARule state=#&lt;Set: {3, 2}>, character="a", next_state=#&lt;Set: {}>></span>
<span class="token comment" spellcheck="true">#&lt;struct FARule state=#&lt;Set: {3, 2}>, character="b", next_state=#&lt;Set: {1, 3, 2}>></span>
<span class="token comment" spellcheck="true">#&lt;struct FARule state=#&lt;Set: {}>, character="a", next_state=#&lt;Set: {}>></span>
<span class="token comment" spellcheck="true">#&lt;struct FARule state=#&lt;Set: {}>, character="b", next_state=#&lt;Set: {}>></span>
<span class="token comment" spellcheck="true">#&lt;struct FARule state=#&lt;Set: {1, 3, 2}>, character="a", next_state=#&lt;Set: {1, 2}>></span>
<span class="token comment" spellcheck="true">#&lt;struct FARule state=#&lt;Set: {1, 3, 2}>, character="b", next_state=#&lt;Set: {1, 3, 2}>></span>
puts dfa<span class="token punctuation">.</span>rulebook<span class="token punctuation">.</span>rules
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="第-4-章-增加计算能力"><a href="#第-4-章-增加计算能力" class="headerlink" title="第 4 章 - 增加计算能力"></a>第 4 章 - 增加计算能力</h3><ol start="15">
<li><span class="pn">Page 100</span><strong>确定性下推自动机</strong>（DPDA）：</li>
</ol>
<ul>
<li>一台有限自动机只能有<strong>固定的状态集合</strong>，因此其存储是有限的，无法跟踪任意数量的信息。在信息数目不可预知，且需要在计算过程中存储并在之后重用的场景下，有限自动机无能为力；</li>
<li>NFA 与任意“正则”等价，因此<strong>理论上使用正则无法区分出“有效 HTML” 与“无效 HTML”</strong>。但现实情况下，比如 Ruby 的正则引擎，由于采用了“<strong>调用栈跟踪</strong>”使得其可以应用于上述场景（单纯的 DFA 与 NFA 无法做到）；</li>
<li>DPDA <strong>只是将“栈”作为一个计数器，并且它的规则只区分“栈为空”和“栈不为空”</strong>；</li>
<li><strong>确定性</strong>：<ul>
<li>对于同样的状态和栈顶字符<strong>不能有多于一个的规则可以应用</strong>（单独的 “ε-moves” 也可应用，只要不与其他规则产生冲突即可）；</li>
<li>没有规则可用时，使机器进入“停滞状态”。</li>
</ul>
</li>
<li>下推自动机（PushDown Automaton，PDA）：<strong>自带“栈”的有限状态机</strong>，给了机器一种“外部存储”的能力；<ul>
<li>永远不要让栈真的变空（当弹出 $ 时可以选择再同时推入）。</li>
</ul>
</li>
</ul>
<p>- <em><strong>一个例子</strong></em>：</p>
<p><img src="11.png"></p>
<p>- <em><strong>模拟 DPDA</strong></em>：</p>
<pre class="line-numbers language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># 栈；</span>
<span class="token keyword">class</span> <span class="token class-name">Stack</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:contents</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> <span class="token function">push</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span>
    <span class="token constant">Stack</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span>char<span class="token punctuation">]</span> <span class="token operator">+</span> contents<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> pop
    <span class="token constant">Stack</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>contents<span class="token punctuation">.</span><span class="token function">drop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> top
    contents<span class="token punctuation">.</span>first
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> inspect
    <span class="token string">"#&lt;Stack (<span class="token interpolation"><span class="token delimiter tag">#{</span>top<span class="token delimiter tag">}</span></span>)<span class="token interpolation"><span class="token delimiter tag">#{</span>contents<span class="token punctuation">.</span><span class="token function">drop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token delimiter tag">}</span></span>>"</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token comment" spellcheck="true"># 对于 PDA 的每一步：当前状态？栈当前内容？</span>
<span class="token keyword">class</span> <span class="token class-name">PDAConfiguration</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:state</span><span class="token punctuation">,</span> <span class="token symbol">:stack</span><span class="token punctuation">)</span>
<span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">PDARule</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:state</span><span class="token punctuation">,</span> <span class="token symbol">:char</span><span class="token punctuation">,</span> <span class="token symbol">:next_state</span><span class="token punctuation">,</span> <span class="token symbol">:pop_char</span><span class="token punctuation">,</span> <span class="token symbol">:push_char</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> applies_to<span class="token operator">?</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> char<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 检查机器状态、栈顶字符以及下一个输入的字符；</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>state <span class="token operator">==</span> config<span class="token punctuation">.</span>state <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">self</span><span class="token punctuation">.</span>pop_char <span class="token operator">==</span> config<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>top <span class="token operator">&amp;&amp;</span>
      <span class="token keyword">self</span><span class="token punctuation">.</span>char <span class="token operator">==</span> char
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token function">follow</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    <span class="token constant">PDAConfiguration</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>next_state<span class="token punctuation">,</span> <span class="token function">next_stack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token function">next_stack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    popped_stack <span class="token operator">=</span> config<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>pop  <span class="token comment" spellcheck="true"># 弹出栈顶元素；</span>
    push_char<span class="token punctuation">.</span>reverse<span class="token punctuation">.</span><span class="token function">inject</span><span class="token punctuation">(</span>popped_stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">|</span>stack<span class="token punctuation">,</span> char<span class="token operator">|</span> stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">DPDARuleBook</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:rules</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> <span class="token function">next_config</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> char<span class="token punctuation">)</span>
    <span class="token function">rule_for</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> char<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">follow</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 返回下一个“配置”；</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token function">rule_for</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> char<span class="token punctuation">)</span>
    rules<span class="token punctuation">.</span>detect <span class="token punctuation">{</span> <span class="token operator">|</span>rule<span class="token operator">|</span> rule<span class="token punctuation">.</span>applies_to<span class="token operator">?</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> char<span class="token punctuation">)</span> <span class="token punctuation">}</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token comment" spellcheck="true"># configuration = PDAConfiguration.new(1, Stack.new(['$']))</span>
<span class="token comment" spellcheck="true"># rulebook = DPDARuleBook.new([</span>
<span class="token comment" spellcheck="true">#   # :state, :char, :next_state, :pop_char, :push_char.</span>
<span class="token comment" spellcheck="true">#   PDARule.new(1, '(', 2, '$', ['b', '$']),</span>
<span class="token comment" spellcheck="true">#   PDARule.new(2, '(', 2, 'b', ['b', 'b']),</span>
<span class="token comment" spellcheck="true">#   PDARule.new(2, ')', 2, 'b', []),</span>
<span class="token comment" spellcheck="true">#   PDARule.new(2, nil, 1, '$', ['$'])</span>
<span class="token comment" spellcheck="true"># ])</span>
<span class="token comment" spellcheck="true"># configuration = rulebook.next_config(configuration, '(')</span>
<span class="token comment" spellcheck="true"># configuration = rulebook.next_config(configuration, '(')</span>
<span class="token comment" spellcheck="true"># configuration = rulebook.next_config(configuration, ')')</span>
<span class="token comment" spellcheck="true"># configuration = rulebook.next_config(configuration, ')')</span>
<span class="token comment" spellcheck="true"># puts configuration</span>

<span class="token keyword">class</span> <span class="token class-name">DPDA</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:current_config</span><span class="token punctuation">,</span> <span class="token symbol">:accept_states</span><span class="token punctuation">,</span> <span class="token symbol">:rulebook</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> accepting<span class="token operator">?</span>
    accept_states<span class="token punctuation">.</span>include<span class="token operator">?</span><span class="token punctuation">(</span>current_config<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token function">read_char</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 在读取字符时会返回行的 PDAConfiguration（状态 + 栈）；</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>current_config <span class="token operator">=</span> rulebook<span class="token punctuation">.</span><span class="token function">next_config</span><span class="token punctuation">(</span>current_config<span class="token punctuation">,</span> char<span class="token punctuation">)</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token function">read_string</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
    str<span class="token punctuation">.</span>chars<span class="token punctuation">.</span><span class="token keyword">each</span> <span class="token keyword">do</span> <span class="token operator">|</span>char<span class="token operator">|</span>
      <span class="token function">read_char</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token comment" spellcheck="true"># 支持“自由移动”；</span>
<span class="token keyword">class</span> <span class="token class-name">DPDARuleBook</span>
  <span class="token keyword">def</span> applies_to<span class="token operator">?</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> char<span class="token punctuation">)</span>
    <span class="token operator">!</span><span class="token function">rule_for</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> char<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">nil</span><span class="token operator">?</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> <span class="token function">follow_free_moves</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    <span class="token keyword">if</span> applies_to<span class="token operator">?</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 若有可用的“自由移动”；</span>
      <span class="token function">follow_free_moves</span><span class="token punctuation">(</span><span class="token function">next_config</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 递归进行“自由移动”；</span>
    <span class="token keyword">else</span>
      config
    <span class="token keyword">end</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token keyword">class</span> <span class="token class-name">DPDA</span>
  <span class="token keyword">def</span> current_config
    rulebook<span class="token punctuation">.</span><span class="token function">follow_free_moves</span><span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">)</span>
  <span class="token keyword">end</span>
<span class="token keyword">end</span>
<span class="token comment" spellcheck="true"># 封装；</span>
<span class="token keyword">class</span> <span class="token class-name">DPDADesign</span> <span class="token operator">&lt;</span> <span class="token builtin">Struct</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token symbol">:start_state</span><span class="token punctuation">,</span> <span class="token symbol">:bottom_char</span><span class="token punctuation">,</span> <span class="token symbol">:accept_states</span><span class="token punctuation">,</span> <span class="token symbol">:rulebook</span><span class="token punctuation">)</span>
  <span class="token keyword">def</span> accepts<span class="token operator">?</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
    to_dpda<span class="token punctuation">.</span>tap <span class="token punctuation">{</span> <span class="token operator">|</span>dpda<span class="token operator">|</span> dpda<span class="token punctuation">.</span><span class="token function">read_string</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">.</span>accepting<span class="token operator">?</span>
  <span class="token keyword">end</span>
  <span class="token keyword">def</span> to_dpda
    start_stack <span class="token operator">=</span> <span class="token constant">Stack</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span>bottom_char<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 栈初始状态；</span>
    start_config <span class="token operator">=</span> <span class="token constant">PDAConfiguration</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>start_state<span class="token punctuation">,</span> start_stack<span class="token punctuation">)</span>
    <span class="token constant">DPDA</span><span class="token punctuation">.</span><span class="token keyword">new</span><span class="token punctuation">(</span>start_config<span class="token punctuation">,</span> accept_states<span class="token punctuation">,</span> rulebook<span class="token punctuation">)</span>
  <span class="token keyword">end</span> 
<span class="token keyword">end</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="16">
<li><span class="pn">Page 110</span><strong>非确定性下推自动机</strong>（NPDA）：</li>
</ol>
<ul>
<li><strong>无法将一个 NPDA 转换成对应的 DPDA</strong>（栈的多种组合无法被合并成一个）；</li>
<li>NPDA 可用来解决“<strong>判断无标记回文</strong>”的问题，而 DPDA 无法做到。</li>
</ul>
<p>- <em><strong>一个例子</strong></em>：</p>
<p><img src="12.png"></p>
<ol start="17">
<li><span class="pn">Page 116</span>PDA 解析编程语言：</li>
</ol>
<ul>
<li>“<strong>词法分析</strong>”可以通过“正则表达式”（也就是一台 <strong>NFA</strong>）来实现；</li>
<li>“<strong>语法分析</strong>”可以通过 <strong>NPDA</strong> 实现（LL 分析，从左到右的顺序，按照“左侧优先”进行推导）。</li>
</ul>
<br><div class="article-bottom-meta"><span class="post-meta">Last built on<time itemprop="dateModified" datetime="2020-12-29T16:29:40.000Z"> 2023 / 10 / 26, 11:37:10</time></span></div></div></article><br><span class="next-post"><a href="/2021/01/03/《计算的本质：深入剖析程序和计算机》读书笔记（第-5-9-章）/" itemprop="url">下一篇 ⇒</a></span><span class="prev-post"><a href="/2020/12/25/《计算的本质：深入剖析程序和计算机》读书笔记（第-1-2-章）/" itemprop="url">⇐ 上一篇</a></span><br><section id="comments"><div><script src="https://utteranc.es/client.js" repo="Becavalier/utterances-comments" issue-term="title" label="[Comment]" theme="github-light" crossorigin="anonymous" async></script></div></section><br><br></main><script src="/scripts/index.js" type="text/javascript"></script></body></html>