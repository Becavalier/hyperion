<!DOCTYPE html><html lang="en-us"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>尝试构建体积最小的 ELF 可执行程序 | 曜彤.手记</title><meta name="description" content="本文将尝试构建一个代码量最少、体积最小的 ELF 可执行程序，程序运行时会向 stdout 输出字符串 “Hello, YHSPY!”。"><meta name="generator" content="曜彤.手记"><meta name="about" content="[object Object]"><meta name="keywords" content="博客, C++, C, Rust, Web, Java, IT, 编程, 开发, Android, Python, MySQL, 科技, 黑客, 技术, Javascript, 云, 大数据, 计算, 机器学习, AI, 人工智能, 创业, 产品, 公司, WebAssembly, Wasm"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=0"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.jpg"><link rel="apple-touch-icon" sizes="60x60" href="/images/apple-touch-icon-60x60.jpg"><link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.jpg"><link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.jpg"><link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.jpg"><link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.jpg"><link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.jpg"><link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.jpg"><link rel="apple-touch-icon" sizes="196x196" href="/images/apple-touch-icon-196x196.jpg"><link rel="apple-touch-icon" sizes="310x310" href="/images/apple-touch-icon-310x310.jpg"><link href="/images/splash/iphone5_splash.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphone6_splash.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphoneplus_splash.png" media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/iphonex_splash.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/iphonexr_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphonexsmax_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/ipad_splash.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro1_splash.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro3_splash.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro2_splash.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="128x128" href="/images/favicon-128.png"><link rel="icon" type="image/png" sizes="196x196" href="/images/favicon-196x196.png"><meta name="msapplication-TileColor" content="#FFFFFF"><meta name="msapplication-TileImage" content="mstile-144x144.png"><meta name="msapplication-square70x70logo" content="mstile-70x70.png"><meta name="msapplication-square150x150logo" content="mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="mstile-310x150.png"><meta name="msapplication-square310x310logo" content="mstile-310x310.png"><meta name="msapplication-square310x310logo" content="mstile-310x310.png"><link rel="manifest" href="/manifest.webmanifest"><link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="/atom.xml"><link rel="stylesheet" href="/css/prism-okaidia.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body itemscope itemtype="https://schema.org/WebPage"><div class="canvas-containter"><span>X</span></div><header itemscope itemtype="https://schema.org/WPHeader"><div class="logo"></div><h1 class="title"><a href="/" alt="曜彤.手记" title="曜彤.手记" itemprop="headline">曜彤.手记</a><a title="Atom 0.3" target="__blank" href="/atom.xml" class="rss"><img src="/images/rss.png"></a></h1><p itemprop="description" class="description">随记，关于互联网技术、产品与创业</p><nav itemscope itemtype="https://schema.org/SiteNavigationElement"><ul><li itemprop="name" class="menu-item"><a href="/ " alt="首页" title="首页" itemprop="url">首页</a></li><li itemprop="name" class="menu-item"><a href="/articles" alt="文章" title="文章" itemprop="url">文章</a></li><li itemprop="name" class="menu-item"><a href="/readings" alt="阅读" title="阅读" itemprop="url">阅读</a></li><li itemprop="name" class="menu-item"><a href="/cards" alt="快记" title="快记" itemprop="url">快记</a></li><li itemprop="name" class="menu-item"><a href="/tags" alt="标签" title="标签" itemprop="url">标签</a></li><li itemprop="name" class="menu-item"><a href="/about" alt="关于" title="关于" itemprop="url">关于</a></li></ul></nav><div class="toc-body"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#15-KB"><span class="toc-text">15 KB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-3-KB"><span class="toc-text">8.3 KB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#440-Bytes"><span class="toc-text">440 Bytes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#229-Bytes"><span class="toc-text">229 Bytes</span></a></li></ol><div class="bookmark"></div></div><div class="space"></div></header><main itemscope itemtype="https://schema.org/Blog"><script src="https://shadow.elemecdn.com/npm/zoomage.js@latest/dist/zoomage.min.js" type="text/javascript"></script><script src="https://shadow.elemecdn.com/npm/axios@0.18.0/dist/axios.min.js" type="text/javascript"></script><script src="/scripts/post.js" type="text/javascript"></script><div class="touch-top"><span></span></div><article post-id="尝试构建体积最小的 ELF 可执行程序" class="full"><h1 itemprop="headline" class="align-center">尝试构建体积最小的 ELF 可执行程序</h1><div class="content"><div class="article-meta"><span class="post-meta"><br>Created on<time itemprop="dateCreated" datetime="2020-06-19T07:44:56.000Z"> 2020 / 06 / 19, 15:44:56</time></span><span class="page-tag-anchor"><a href="/tags/计算机" itemprop="url">#计算机</a>&nbsp;&nbsp;</span></div><p>本文将尝试构建一个代码量最少、体积最小的 ELF 可执行程序，程序运行时会向 stdout 输出字符串 “Hello, YHSPY!”。</p>
<h4 id="15-KB"><a href="#15-KB" class="headerlink" title="15 KB"></a>15 KB</h4><p>首先来一个 C 语言下的，最基本的写法：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> str <span class="token operator">=</span> <span class="token string">"Hello, YHSPY!"</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码十分简单，手起刀落一气呵成。此时我们可以发现，这段代码对应的可执行文件有 17 KB 大小。在使用 <code>strip</code> 去掉符号表之后，整个文件也还是有 15 KB 的大小。分析下来，我们知道如果想要向 stdout 输出我们给定的字符串，则一定要通过 Linux 下的系统调用 write 来进行。</p>
<h4 id="8-3-KB"><a href="#8-3-KB" class="headerlink" title="8.3 KB"></a>8.3 KB</h4><p>正如我们在“<strong>链接、装载与库相关记录（二）</strong>”一文的末尾处所介绍的那样，我们可以通过 NASM 来避开编译器，直接以汇编的形式来书写我们这个最小的 ELF 可执行程序，首先给出一样的汇编代码如下（main.asm）：</p>
<pre class="line-numbers language-nasm"><code class="language-nasm">          <span class="token keyword">global    _start</span>

          <span class="token keyword">section   .text</span>
<span class="token label function">_start:</span>   mov       <span class="token register variable">rax</span>, <span class="token number">1</span>                  <span class="token comment" spellcheck="true">; system call for write</span>
          mov       <span class="token register variable">rdi</span>, <span class="token number">1</span>                  <span class="token comment" spellcheck="true">; file handle 1 is stdout</span>
          mov       <span class="token register variable">rsi</span>, message            <span class="token comment" spellcheck="true">; address of string to output</span>
          mov       <span class="token register variable">rdx</span>, <span class="token number">14</span>                 <span class="token comment" spellcheck="true">; number of bytes</span>
          syscall                           <span class="token comment" spellcheck="true">; invoke operating system to do the write</span>
          mov       <span class="token register variable">rax</span>, <span class="token number">60</span>                 <span class="token comment" spellcheck="true">; system call for exit</span>
          xor       <span class="token register variable">rdi</span>, <span class="token register variable">rdi</span>                <span class="token comment" spellcheck="true">; exit code 0</span>
          syscall                           <span class="token comment" spellcheck="true">; invoke operating system to exit</span>

          <span class="token keyword">section   .rodata</span>
<span class="token label function">message:</span>  db        <span class="token string">"Hello, YHSPY!"</span>, <span class="token number">10</span>      <span class="token comment" spellcheck="true">; note the newline at the end</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里对代码的结构我们不再赘述。接下来，我们通过 NASM 将这段代码编译成目标文件，在通过 ld 以静态链接的方式生成 ELF 可执行文件。</p>
<pre class="line-numbers language-bash"><code class="language-bash">nasm -f elf64 main.asm -o main.o
ld main.o -o main
./main  <span class="token comment" spellcheck="true"># "Hello, YHSPY!"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>经过查看后，发现此时生成的 main 可执行文件仍然有 8.7 KB 大小；经过 strip 处理后仍然有 8.3 KB 大小。实际上，如果你有查看我们在第一步生成的 main.o 文件的大小，你会发现这个目标文件仅有 848 Byte，但最后链接生成的 ELF 可执行文件却有 8.7 KB，这确实不符合常理。</p>
<h4 id="440-Bytes"><a href="#440-Bytes" class="headerlink" title="440 Bytes"></a>440 Bytes</h4><p>通过 <code>hexdump -C main</code> 查看 ELF 可执行文件的内容发现，在其二进制内容中，各个 Section 并不是紧凑的放在一起中，其中有很多 0x0 的 Padding。如下所示（比如其中的 0xf0 - 0x1000 均为无效值）：</p>
<pre class="line-numbers language-text"><code class="language-text">...
000000c0  00 20 40 00 00 00 00 00  00 20 40 00 00 00 00 00  |. @...... @.....|
000000d0  0d 00 00 00 00 00 00 00  0d 00 00 00 00 00 00 00  |................|
000000e0  00 10 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000000f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00001000  b8 01 00 00 00 bf 01 00  00 00 48 be 00 20 40 00  |..........H.. @.|
00001010  00 00 00 00 ba 0d 00 00  00 0f 05 b8 3c 00 00 00  |............<...|
00001020  48 31 ff 0f 05 00 00 00  00 00 00 00 00 00 00 00  |H1..............|
00001030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00002000  48 65 6c 6c 6f 2c 20 57  6f 72 6c 64 0a 00 00 00  |Hello, YHSPY!...|
00002010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
...
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因此，接下来我们将通过链接脚本来手动控制链接的过程，让各个 Section 在 ELF 文件中的位置更加紧凑。main.lds 文件的内容如下所示：</p>
<pre class="line-numbers language-text"><code class="language-text">ENTRY(_start)
SECTIONS
{
  . = 0x400000 + SIZEOF_HEADERS;  /* 设置当前位置的 VMA */
  main : { *(.text) *(.rodata) }  /* 将所有输入目标文件中的 .text 与 .rodata 段合并到 main 段中 */
  /DISCARD/ : { *(.symtab) *(.strtab) }
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里我们将 .text 和 .rodata 两个段进行合并，并直接放置于 ELF 头的后面；同时通过在命令行中添加 “-s” 参数去掉 ELF 文件中的符号表、字符串表。我们通过以下命令重新链接生成 ELF 可执行文件：</p>
<pre class="line-numbers language-bash"><code class="language-bash">ld -s -static -T main.lds -o main main.o
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>此时，我们的 ELF 可执行文件体积达到了 440 Bytes。</p>
<h4 id="229-Bytes"><a href="#229-Bytes" class="headerlink" title="229 Bytes"></a>229 Bytes</h4><blockquote>
<p>Most ELF executables are built with both a program header table and a section header table. However, <em><strong>only the former is required in order for the OS to load, link and execute a program</strong></em>. It should be noted that most programs that work with ELF files are dependent on the section header table as an index to the file’s contents. Thus, utilities such as gdb and objdump will often have limited functionality when working with an executable with no section header table. Some other utilities may refuse to work with them at all.</p>
</blockquote>
<p>由于 GNU 下的 strip 无法移除 ELF 可执行文件中的 .shstrtab 段，并且观察发现在各个 Section 之间仍然有很多空白没有任何实际用处的 Padding 存在，因此最后我们再使用 <b><a target="_blank" rel="noopener" href="https://github.com/aunali1/super-strip">sstrip</a></b>（Super Strip）来对 ELF 文件进行处理。处理后的文件大小达到了 229 Byte。</p>
<br><div class="article-bottom-meta"><span class="post-meta">Last built on<time itemprop="dateModified" datetime="2020-06-19T07:44:56.000Z"> 2023 / 10 / 26, 11:37:10</time></span></div></div></article><br><span class="next-post"><a href="/2020/06/19/ld-链接控制脚本与默认脚本/" itemprop="url">下一篇 ⇒</a></span><span class="prev-post"><a href="/2020/06/19/GCC-下的-COMMON-块控制/" itemprop="url">⇐ 上一篇</a></span><br><section id="comments"><div><script src="https://utteranc.es/client.js" repo="Becavalier/utterances-comments" issue-term="title" label="[Comment]" theme="github-light" crossorigin="anonymous" async></script></div></section><br><br></main><script src="/scripts/index.js" type="text/javascript"></script></body></html>