<!DOCTYPE html><html lang="en-us"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>《虚拟机系统与进程的通用平台》基础概述 | 曜彤.手记</title><meta name="description" content="这本书读起来比较学术，所以看心情挑着读读。（翻译质量奇差）"><meta name="generator" content="曜彤.手记"><meta name="about" content="[object Object]"><meta name="keywords" content="博客, C++, C, Rust, Web, Java, IT, 编程, 开发, Android, Python, MySQL, 科技, 黑客, 技术, Javascript, 云, 大数据, 计算, 机器学习, AI, 人工智能, 创业, 产品, 公司, WebAssembly, Wasm"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=0"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.jpg"><link rel="apple-touch-icon" sizes="60x60" href="/images/apple-touch-icon-60x60.jpg"><link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.jpg"><link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.jpg"><link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.jpg"><link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.jpg"><link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.jpg"><link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.jpg"><link rel="apple-touch-icon" sizes="196x196" href="/images/apple-touch-icon-196x196.jpg"><link rel="apple-touch-icon" sizes="310x310" href="/images/apple-touch-icon-310x310.jpg"><link href="/images/splash/iphone5_splash.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphone6_splash.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphoneplus_splash.png" media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/iphonex_splash.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/iphonexr_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphonexsmax_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/ipad_splash.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro1_splash.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro3_splash.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro2_splash.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="128x128" href="/images/favicon-128.png"><link rel="icon" type="image/png" sizes="196x196" href="/images/favicon-196x196.png"><meta name="msapplication-TileColor" content="#FFFFFF"><meta name="msapplication-TileImage" content="mstile-144x144.png"><meta name="msapplication-square70x70logo" content="mstile-70x70.png"><meta name="msapplication-square150x150logo" content="mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="mstile-310x150.png"><meta name="msapplication-square310x310logo" content="mstile-310x310.png"><meta name="msapplication-square310x310logo" content="mstile-310x310.png"><link rel="manifest" href="/manifest.webmanifest"><link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="/atom.xml"><link rel="stylesheet" href="/css/prism-okaidia.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body itemscope itemtype="https://schema.org/WebPage"><div class="canvas-containter"><span>X</span></div><header itemscope itemtype="https://schema.org/WPHeader"><div class="logo"></div><h1 class="title"><a href="/" alt="曜彤.手记" title="曜彤.手记" itemprop="headline">曜彤.手记</a><a title="Atom 0.3" target="__blank" href="/atom.xml" class="rss"><img src="/images/rss.png"></a></h1><p itemprop="description" class="description">随记，关于互联网技术、产品与创业</p><nav itemscope itemtype="https://schema.org/SiteNavigationElement"><ul><li itemprop="name" class="menu-item"><a href="/ " alt="首页" title="首页" itemprop="url">首页</a></li><li itemprop="name" class="menu-item"><a href="/articles" alt="文章" title="文章" itemprop="url">文章</a></li><li itemprop="name" class="menu-item"><a href="/readings" alt="阅读" title="阅读" itemprop="url">阅读</a></li><li itemprop="name" class="menu-item"><a href="/cards" alt="快记" title="快记" itemprop="url">快记</a></li><li itemprop="name" class="menu-item"><a href="/tags" alt="标签" title="标签" itemprop="url">标签</a></li><li itemprop="name" class="menu-item"><a href="/about" alt="关于" title="关于" itemprop="url">关于</a></li></ul></nav><div class="dynamic-slot"></div><div class="toc-body"><div class="bookmark"></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Chapter-1%EF%BC%9A%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AF%BC%E8%AE%BA"><span class="toc-text">Chapter 1：虚拟机导论</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Chapter-2%EF%BC%9A%E4%BB%BF%E7%9C%9F%EF%BC%9A%E8%A7%A3%E9%87%8A%E5%92%8C%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%BF%BB%E8%AF%91"><span class="toc-text">Chapter 2：仿真：解释和二进制翻译</span></a></li></ol></div><div class="space"></div></header><main itemscope itemtype="https://schema.org/Blog"><script src="https://shadow.elemecdn.com/npm/zoomage.js@latest/dist/zoomage.min.js" type="text/javascript"></script><script src="https://shadow.elemecdn.com/npm/axios@0.18.0/dist/axios.min.js" type="text/javascript"></script><script src="/scripts/post.js" type="text/javascript"></script><div class="touch-top"><span></span></div><article post-id="《虚拟机系统与进程的通用平台》基础概述" class="full article-post"><h1 itemprop="headline" class="align-center">《虚拟机系统与进程的通用平台》基础概述</h1><div class="content"><div class="article-meta"><span class="post-meta"><br>Created on<time itemprop="dateCreated" datetime="2020-07-15T10:09:30.000Z"> 2020 / 07 / 15, 18:09:30</time></span><span class="page-tag-anchor"><a href="/tags/虚拟机" itemprop="url">#虚拟机</a>&nbsp;&nbsp;</span></div><p>这本书读起来比较学术，所以看心情挑着读读。（翻译质量奇差）</p>
<h3 id="Chapter-1：虚拟机导论"><a href="#Chapter-1：虚拟机导论" class="headerlink" title="Chapter 1：虚拟机导论"></a>Chapter 1：虚拟机导论</h3><ol>
<li><span class="pn">Page 16</span><strong>指令集（I386 \ X86-64 \ PowerPC）一般会作为中间接口</strong>。CPU 设计师和编译器工程师分别按照这个 ISA 中的指令集来设计硬件芯片和软件的高级语言编译器。另外的标准化接口还有操作系统调用。而多种接口规范的存在，也导致了<strong>软件的可移植性降低</strong>。</li>
<li><span class="pn">Page 16</span>形式上，虚拟化是构建一个<strong>将虚拟客户系统映射到真实主机系统的同态</strong>。通常，两者的细节是相同的。</li>
<li><span class="pn">Page 19</span>计算机系统体系结构，如下图。2 和 3 分别是系统调用接口与 lic \ libcxx 等库中提供的接口；7 和 8 分别为<strong>用户指令集</strong>与<strong>操作系统指令集</strong>。ISA 是划分软件和硬件两个层面的分界线。ABI 由 3（<strong>系统调用 ABI</strong>，比如 X86-64 下不能使用 rcx 传参，相对于 ISA 的调用约定可能会有些许不同）和 7（<strong>ISA 调用约定</strong>，cdecl \ System-V-AMD64 ABI 等）组成；API（源代码级别）由 2 和 7（个人理解是指单纯的指令调用）组成。</li>
</ol>
<p><img src="1.png"></p>
<p><strong>C ABI</strong> 规定内容（其中一部分内容由 Calling-Convention 决定）：</p>
<ul>
<li>预定义类型（char、int、float 等）的大小和布局；</li>
<li>复合类型（array 和 struct）的布局；</li>
<li>编程人员定义的名称的外部（链接器可见）拼写；</li>
<li>机器码函数调用序列；</li>
<li>堆栈布局；</li>
<li>寄存器使用；</li>
</ul>
<p><strong>C++ ABI</strong> 包括 C ABI，除此之外还有：</p>
<ul>
<li>层次结构类对象（即，基类和虚拟基类）的布局；</li>
<li>类成员指针的布局；</li>
<li>传递隐藏函数参数（例如 this）；</li>
<li>如何调用虚拟函数：<ul>
<li>Vtable 内容和布局；</li>
<li>指向 vtable 的指针在对象中的位置；</li>
<li>查找 this 指针调整；</li>
</ul>
</li>
<li>查找基类偏移；</li>
<li>通过指向成员的指针调用函数；</li>
<li>管理模板实例；</li>
<li>名称的外部拼写（“Name Mangling”）；</li>
<li>构造和析构静态对象；</li>
<li>抛出和捕获异常；</li>
<li>标准库的一些细节：<ul>
<li>实现定义的细节；</li>
<li>类型信息和运行时类型信息；</li>
<li>内联函数对成员的访问；</li>
</ul>
</li>
</ul>
<ol start="4">
<li><span class="pn">Page 21</span><strong>进程级虚拟机</strong>：能够支持一个独立进程，虚拟机负责仿真用户级指令和系统调用（比如 Wine）；<strong>系统级虚拟机</strong>：提供完整的系统环境，使其可以支持操作系统及其潜在的许多用户进程，它使得客户操作系统能够访问底层的硬件资源（比如 VirtualBox、VMware）。</li>
<li><span class="pn">Page 25</span>早期的系统级虚拟机在实现时，<strong>VMM（Virtual Machine Manager）是直接安装在裸机上的，上面再装上虚拟机</strong>。VMM 在最高特权模式下运行，而客户机系统运行时的特权要少一些。VMM 会拦截并执行所有客户机操作系统发出的与硬件资源交互的动作。而后期另一种可选的系统虚拟机即所谓的“宿主虚拟机”，即安装在宿主操作系统上，不需要 VMM 的支持，但缺点是效率较低。</li>
<li><span class="pn">Page 25</span>在系统虚拟机中，VMM 的一个主要特色是提供了对平台的复制。VMM 可以访问并管理所有硬件资源，当客户机操作系统要执行一个特定操作时（比如直接访问共享硬件资源的特权指令），这个操作将<strong>由 VMM 来解释并检查正确性，再由 VMM 替客户机执行</strong>。</li>
<li><span class="pn">Page 28</span>虚拟机分类法：</li>
</ol>
<p><img src="2.png"></p>
<p><strong>进程虚拟机</strong>：</p>
<ul>
<li>多道程序设计；</li>
<li>仿真器和动态二进制解释器：在为某个指令集设计的硬件上仿真另一个指令集（如 Intel IA-32 EL），最简单的方法是<strong>解释</strong>；</li>
<li>相同 ISA 下的二进制优化器（如 Dynamo）；</li>
<li>高级语言虚拟机（HLL）：平台独立性（如 JVM）；</li>
</ul>
<p><strong>系统虚拟机</strong>：</p>
<ul>
<li>标准虚拟机和宿主虚拟机：前者 VMM 直接安装在裸机上；后者安装在宿主操作系统上；</li>
<li>全系统虚拟机（<strong>主机和宿主机的 ISA 不同</strong>，导致翻译的代码通常不能利用底层系统的 ISA 在虚拟内存管理和陷阱处理等方面的特性）；</li>
<li>协同设计虚拟机：<strong>硬件优化</strong>（创建新的 ISA，改善硬件实现的性能和功耗。如 Transmeta Crusoe 处理器，底层采用了 VLIW（Very Long Instruction Word）指令集来优化性能、节省功耗，上层采用 CMS，即“代码变形”软件来转换上层 ISA 指令到本机指令集）；</li>
</ul>
<ol start="8">
<li><span class="pn">Page 28</span>一个例子：Java 应用（<strong>JVM</strong>）-&gt; Linux IA-32（<strong>VMware</strong>）-&gt; Windows IA-32（<strong>CMS</strong>）-&gt; Crusoe VLIW；</li>
</ol>
<h3 id="Chapter-2：仿真：解释和二进制翻译"><a href="#Chapter-2：仿真：解释和二进制翻译" class="headerlink" title="Chapter 2：仿真：解释和二进制翻译"></a>Chapter 2：仿真：解释和二进制翻译</h3><ol start="9">
<li><span class="pn">Page 30</span>陷阱和中断：</li>
</ol>
<ul>
<li>陷阱（<strong>trap</strong>）：一般可以理解为“软中断”，发生在用户进程中。常用于<strong>处理运行时异常</strong>（如除零、无效内存访问等）或者进行<strong>系统调用</strong>；</li>
<li>中断（<strong>interrupt</strong>）：一般单纯指由<strong>“硬件”引发的中断</strong>；</li>
</ul>
<ol start="10">
<li><span class="pn">Page 31</span><strong>译码分派</strong>（decode-and-dispatch）解释器：逐条指令地执行源程序来运行，并根据读取到的指令修改源状态。解释的性能代价会相当高。即使解释器代码用汇编语言编写，<strong>解释一条像“取字并置零”的单一指令仍需要包含目标 ISA 中数十条指令的执行</strong>。</li>
<li><span class="pn">Page 34</span><strong>线索解释</strong>（Threaded Interpretation）：在当前指令处理例程结束之前以某种方式（直接、间接查表等）直接跳转到下一个指令处理例程继续执行，进而<strong>省去循环分派的过程，降低 CPU 分支预测产生的损耗</strong>。</li>
</ol>
<p><img src="3.png"></p>
<ol start="12">
<li><span class="pn">Page 34</span>预译码（Pre-decoding）：<strong>将指令的操作码和扩展操作码合并为一个单独的预译码操作码，同时将操作数或立即数等参数按照字节对齐的方式进行存放</strong>。这在简化了原指令序列的同时，也会易于虚拟机的访问。一个预译码（针对 IA32）的基本结构如下：</li>
</ol>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> CODE_SIZE 1024</span>
<span class="token keyword">struct</span> instruction <span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> op<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 此处可以用 OpCode 处理例程的地址代替（DTC）；</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> dest<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> src1<span class="token punctuation">;</span>
  unsinged <span class="token keyword">int</span> src2<span class="token punctuation">;</span>
<span class="token punctuation">}</span> code<span class="token punctuation">[</span>CODE_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>（待更新。大概率不会更新了，翻译质量太差）</p>
<br><div class="article-bottom-meta"><span class="post-meta">Last built on<time itemprop="dateModified" datetime="2020-07-15T10:09:30.000Z"> 2023 / 10 / 26, 11:37:10</time></span></div></div></article><br><span class="next-post"><a href="/2020/07/18/老生常谈之：switch-case-VS-if-else/" itemprop="url">下一篇 ⇒</a></span><span class="prev-post"><a href="/2020/07/11/std-optional-与-Optional-References/" itemprop="url">⇐ 上一篇</a></span><br><section id="comments"><h4>评论 | Comments</h4><br><div class="comment-container"><div class="loading-mask">Loading ...</div><script src="https://utteranc.es/client.js" repo="Becavalier/utterances-comments" issue-term="title" label="[Comment]" theme="github-light" crossorigin="anonymous" async></script></div></section><br><br></main><script src="/scripts/index.js" type="text/javascript"></script></body></html>