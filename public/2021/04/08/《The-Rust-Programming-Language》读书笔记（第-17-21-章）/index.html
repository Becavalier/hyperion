<!DOCTYPE html><html lang="en-us"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>《The Rust Programming Language》读书笔记（第 17-21 章） | 曜彤.手记</title><meta name="description" content="书接上回，第 17-21 章的笔记。"><meta name="generator" content="曜彤.手记"><meta name="about" content="[object Object]"><meta name="keywords" content="博客, C++, C, Rust, Web, Java, IT, 编程, 开发, Android, Python, MySQL, 科技, 黑客, 技术, Javascript, 云, 大数据, 计算, 机器学习, AI, 人工智能, 创业, 产品, 公司, WebAssembly, Wasm"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=0"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.jpg"><link rel="apple-touch-icon" sizes="60x60" href="/images/apple-touch-icon-60x60.jpg"><link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.jpg"><link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.jpg"><link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.jpg"><link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.jpg"><link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.jpg"><link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.jpg"><link rel="apple-touch-icon" sizes="196x196" href="/images/apple-touch-icon-196x196.jpg"><link rel="apple-touch-icon" sizes="310x310" href="/images/apple-touch-icon-310x310.jpg"><link href="/images/splash/iphone5_splash.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphone6_splash.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphoneplus_splash.png" media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/iphonex_splash.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/iphonexr_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphonexsmax_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/ipad_splash.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro1_splash.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro3_splash.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro2_splash.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="128x128" href="/images/favicon-128.png"><link rel="icon" type="image/png" sizes="196x196" href="/images/favicon-196x196.png"><meta name="msapplication-TileColor" content="#FFFFFF"><meta name="msapplication-TileImage" content="mstile-144x144.png"><meta name="msapplication-square70x70logo" content="mstile-70x70.png"><meta name="msapplication-square150x150logo" content="mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="mstile-310x150.png"><meta name="msapplication-square310x310logo" content="mstile-310x310.png"><meta name="msapplication-square310x310logo" content="mstile-310x310.png"><link rel="manifest" href="/manifest.webmanifest"><link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="/atom.xml"><link rel="stylesheet" href="/css/prism-okaidia.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body itemscope itemtype="https://schema.org/WebPage"><div class="canvas-containter"><span>X</span></div><header itemscope itemtype="https://schema.org/WPHeader"><div class="logo"></div><h1 class="title"><a href="/" alt="曜彤.手记" title="曜彤.手记" itemprop="headline">曜彤.手记</a><a title="Atom 0.3" target="__blank" href="/atom.xml" class="rss"><img src="/images/rss.png"></a></h1><p itemprop="description" class="description">随记，关于互联网技术、产品与创业</p><nav itemscope itemtype="https://schema.org/SiteNavigationElement"><ul><li itemprop="name" class="menu-item"><a href="/ " alt="首页" title="首页" itemprop="url">首页</a></li><li itemprop="name" class="menu-item"><a href="/articles" alt="文章" title="文章" itemprop="url">文章</a></li><li itemprop="name" class="menu-item"><a href="/readings" alt="阅读" title="阅读" itemprop="url">阅读</a></li><li itemprop="name" class="menu-item"><a href="/cards" alt="快记" title="快记" itemprop="url">快记</a></li><li itemprop="name" class="menu-item"><a href="/tags" alt="标签" title="标签" itemprop="url">标签</a></li><li itemprop="name" class="menu-item"><a href="/about" alt="关于" title="关于" itemprop="url">关于</a></li></ul></nav><div class="toc-slot"></div><div class="toc-body"><div class="bookmark"></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Chapter-17-Object-Oriented-Programming-Features-of-Rust"><span class="toc-text">Chapter 17 - Object Oriented Programming Features of Rust</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Chapter-18-Patterns-and-Matching"><span class="toc-text">Chapter 18 - Patterns and Matching</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Chapter-19-Advanced-Features"><span class="toc-text">Chapter 19 - Advanced Features</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Chapter-20-Final-Project-Building-a-Multithreaded-Web-Server"><span class="toc-text">Chapter 20 - Final Project: Building a Multithreaded Web Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Chapter-21-Appendix"><span class="toc-text">Chapter 21 - Appendix</span></a></li></ol></div><div class="space"></div></header><main itemscope itemtype="https://schema.org/Blog"><script src="https://shadow.elemecdn.com/npm/zoomage.js@latest/dist/zoomage.min.js" type="text/javascript"></script><script src="https://shadow.elemecdn.com/npm/axios@0.18.0/dist/axios.min.js" type="text/javascript"></script><script src="/scripts/post.js" type="text/javascript"></script><div class="touch-top"><span></span></div><article post-id="《The Rust Programming Language》读书笔记（第 17-21 章）" class="full"><h1 itemprop="headline" class="align-center">《The Rust Programming Language》读书笔记（第 17-21 章）</h1><div class="content"><div class="article-meta"><span class="post-meta"><br>Created on<time itemprop="dateCreated" datetime="2021-04-08T15:48:43.000Z"> 2021 / 04 / 08, 23:48:43</time></span><span class="page-tag-anchor"><a href="/tags/Rust" itemprop="url">#Rust</a>&nbsp;&nbsp;</span></div><p>书接上回，第 17-21 章的笔记。</p>
<h3 id="Chapter-17-Object-Oriented-Programming-Features-of-Rust"><a href="#Chapter-17-Object-Oriented-Programming-Features-of-Rust" class="headerlink" title="Chapter 17 - Object Oriented Programming Features of Rust"></a>Chapter 17 - Object Oriented Programming Features of Rust</h3><ol start="58">
<li><span class="pn">Page 408</span>Rust 中的 OOP：</li>
</ol>
<ul>
<li>封装：<code>struct</code> / <code>impl</code> 结构的封装，与 <code>pub</code> 提供的成员可见性控制；</li>
<li>继承：<strong>不支持</strong>。对于代码重用，可以使用 trait 的默认实现；</li>
<li>多态：<strong>不支持</strong>。Rust 支持 <em>bounded parametric polymorphism</em>，即通过泛型（抽象不同类型）与 trait（对类型的限制）实现的与传统多态类似的效果。</li>
<li><strong>Rust 不支持传统 OOP 模式的一部分原因</strong>：继承在许多编程语言中已不再是一种编程设计解决方案，因为它经常面临<strong>共享不必要代码的风险</strong>。子类不应该总是共享其父类的所有特征，但是继承会导致该问题，而这会使程序的设计不那么灵活。同时，它还引入了对子类进行调用没有意义，或会导致错误的方法的可能性，因为这些方法不适用于子类。此外，某些语言仅允许子类从一个类继承，从而进一步限制了程序设计的灵活性。由于这些原因，Rust 采用了一种不同的方法，即使用“特征对象”而不是继承。</li>
</ul>
<ol start="59">
<li><span class="pn">Page 412</span><strong>Trait Object</strong>：</li>
</ol>
<ul>
<li>一个 <em>trait object</em> 既指向（<strong><em>object</em> 需要通过指针引用</strong>）了实现了该 trait 的类型实例，也指向用于在运行时查找该类型上实现的 trait 方法的表；<em>trait object</em> 可用于取代泛型或具体类型；</li>
<li>相较于单态化（<em>monomorphized</em>）的 “<em>generic struct</em> + <em>trait bounds</em>” 模式，多态化的 “<em>struct</em> + <em>concrete trait objects</em>” 可以支持在运行时为 <em>trait objects</em> 填充多种具体类型；</li>
<li>由于会发生<strong>运行时</strong>的 <em>dynamic dispatch</em>，因此<strong>会禁用一些诸如 “inline” 等优化，牺牲一定性能</strong>。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> Draw <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">draw</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// version 1: generic struct + trait bounds.</span>
<span class="token comment" spellcheck="true">// pub struct Screen&lt;T: Draw> {</span>
<span class="token comment" spellcheck="true">//     pub components: Vec&lt;T>,</span>
<span class="token comment" spellcheck="true">// }</span>
<span class="token comment" spellcheck="true">// impl&lt;T> Screen&lt;T> </span>
<span class="token comment" spellcheck="true">//     where T: Draw, {</span>
<span class="token comment" spellcheck="true">//         pub fn run(&amp;self) {</span>
<span class="token comment" spellcheck="true">//             for component in self.components.iter() {</span>
<span class="token comment" spellcheck="true">//                 component.draw(); </span>
<span class="token comment" spellcheck="true">//             }</span>
<span class="token comment" spellcheck="true">//         }</span>
<span class="token comment" spellcheck="true">//     }</span>

<span class="token comment" spellcheck="true">// version 2: struct + trait object.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> Screen <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> components<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>Box<span class="token operator">&lt;</span>dyn Draw<span class="token operator">>></span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// trait object.</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> Screen <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> component <span class="token keyword">in</span> <span class="token keyword">self</span><span class="token punctuation">.</span>components<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            component<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><em><strong>object-safe</strong></em> traits：为了保证一个 <em>trait object</em> 是安全的，对于其 <em>trait</em> 上定义的所有方法：<ul>
<li>返回值类型不能是 <em>Self</em>（别名，<strong>指代正在实现该 trait 的类型</strong>）；</li>
<li>不能使用泛型参数。</li>
</ul>
</li>
</ul>
<ol start="60">
<li><span class="pn">Page 419</span>实现“面向对象”设计模式：</li>
</ol>
<ul>
<li><strong>状态模式</strong>（<em>state pattern</em>）：一个值的实际行为基于其内部状态对象进行变化，而无法直接从外部进行干预。<ul>
<li>含有冗余代码；</li>
<li>状态转换之间有一定耦合。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> Post <span class="token punctuation">{</span>
    state<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>Box<span class="token operator">&lt;</span>dyn State<span class="token operator">>></span><span class="token punctuation">,</span>
    content<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> Post <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Post <span class="token punctuation">{</span>
        Post <span class="token punctuation">{</span>
            state<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span>Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Draft <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            content<span class="token punctuation">:</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">content</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span>str <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// get a reference to the value inside the "Option".</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">add_text</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">request_review</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// take the ownership and setup a new one.</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token function">Some</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">request_review</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token function">Some</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">trait</span> State <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// the method is only valid when called on a "Box" holding the type.</span>
    <span class="token keyword">fn</span> <span class="token function">request_review</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span>Self<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Box<span class="token operator">&lt;</span>dyn State<span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span>Self<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Box<span class="token operator">&lt;</span>dyn State<span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> content<span class="token operator">&lt;</span><span class="token string">'a>(&amp;self, post: &amp;'</span>a Post<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span>'a str <span class="token punctuation">{</span> <span class="token string">""</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> Draft <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> State <span class="token keyword">for</span> Draft <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">request_review</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span>Self<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Box<span class="token operator">&lt;</span>dyn State<span class="token operator">></span> <span class="token punctuation">{</span>
        Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>PendingReview <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span>Self<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Box<span class="token operator">&lt;</span>dyn State<span class="token operator">></span> <span class="token punctuation">{</span> 
        <span class="token keyword">self</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> PendingReview <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> State <span class="token keyword">for</span> PendingReview <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">request_review</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span>Self<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Box<span class="token operator">&lt;</span>dyn State<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span>Self<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Box<span class="token operator">&lt;</span>dyn State<span class="token operator">></span> <span class="token punctuation">{</span> 
        Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Published <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> Published <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> State <span class="token keyword">for</span> Published <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">request_review</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span>Self<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Box<span class="token operator">&lt;</span>dyn State<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">:</span> Box<span class="token operator">&lt;</span>Self<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Box<span class="token operator">&lt;</span>dyn State<span class="token operator">></span> <span class="token punctuation">{</span> 
        <span class="token keyword">self</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">fn</span> content<span class="token operator">&lt;</span><span class="token string">'a>(&amp;self, post: &amp;'</span>a Post<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span>'a str <span class="token punctuation">{</span> 
        <span class="token operator">&amp;</span>post<span class="token punctuation">.</span>content
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>基于 Rust 的类型系统进行优化：<ul>
<li>不再遵循 OOP；</li>
<li>可以直接在编译时减少逻辑上的错误（不同类型有不同的操作）。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">pub</span> <span class="token keyword">struct</span> Post <span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> DraftPost <span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> Post <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> DraftPost <span class="token punctuation">{</span>
        DraftPost <span class="token punctuation">{</span>
            content<span class="token punctuation">:</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">content</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span>str <span class="token punctuation">{</span> 
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>content
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> DraftPost <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">add_text</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">request_review</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> PendingReviewPost <span class="token punctuation">{</span>
        PendingReviewPost <span class="token punctuation">{</span>
            content<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>content<span class="token punctuation">,</span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> PendingReviewPost <span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> PendingReviewPost <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Post <span class="token punctuation">{</span>
        Post <span class="token punctuation">{</span>
            content<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>content<span class="token punctuation">,</span>
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> post <span class="token operator">=</span> Post<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    post<span class="token punctuation">.</span><span class="token function">add_text</span><span class="token punctuation">(</span><span class="token string">"I ate a salad for lunch today"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> post <span class="token operator">=</span> post<span class="token punctuation">.</span><span class="token function">request_review</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> post <span class="token operator">=</span> post<span class="token punctuation">.</span><span class="token function">approve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span><span class="token string">"I ate a salad for lunch today"</span><span class="token punctuation">,</span> post<span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Chapter-18-Patterns-and-Matching"><a href="#Chapter-18-Patterns-and-Matching" class="headerlink" title="Chapter 18 - Patterns and Matching"></a>Chapter 18 - Patterns and Matching</h3><ol start="61">
<li><span class="pn">Page 433</span>一个“模式”包含对下面这些元素的组合：</li>
</ol>
<ul>
<li>字面量值；</li>
<li>数组、枚举、struct 或元组的解构；</li>
<li>变量；</li>
<li>通配符；</li>
<li>占位符。</li>
</ul>
<ol start="62">
<li><span class="pn">Page 436</span>Rust 中的几种模式匹配场景：</li>
</ol>
<p><em>while…let</em>：<strong>条件循环</strong>；</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> stack <span class="token operator">=</span> Vec<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>top<span class="token punctuation">)</span> <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><em>for…in</em>：</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// the pattern is "(index, value)".</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>index<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token keyword">in</span> v<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">enumerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{} is at index {}"</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><em>let</em> 表达式：本质上为 <code>let PATTERN = EXPRESSION;</code>。</li>
<li>函数（或闭包）参数：</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">print_coordinates</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>i32<span class="token punctuation">,</span> i32<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Current location: ({}, {})"</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> point <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">print_coordinates</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="63">
<li><span class="pn">Page 439</span><strong>Refutability</strong>：</li>
</ol>
<ul>
<li><em>refutable</em>：对某些可能的值，模式匹配可能会失败。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=</span> a_value <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><em>irrefutable</em>：可以匹配任何传入的可能值。以下场景需使用该类型模式匹配：<ul>
<li>函数参数；</li>
<li><code>let</code> 语句；</li>
<li><code>for</code> 循环语句。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol start="64">
<li><span class="pn">Page 442</span><strong>模式匹配语法</strong>：</li>
</ol>
<ul>
<li>匹配字面量值：</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">match</span> x <span class="token punctuation">{</span>
    <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"one"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">2</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"two"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token number">3</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"three"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    _ <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"anything"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>匹配命名变量：</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">match</span> x <span class="token punctuation">{</span>
    <span class="token function">Some</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Got 50"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// this newly introduced variable "y" will shadow the outer one.</span>
    <span class="token function">Some</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Matched, y = {:?}"</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> 
    _ <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Default case, x = {:?}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"at the end: x = {:?}, y = {:?}"</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>多模式匹配：</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">match</span> x <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// match 1 or 2.</span>
    <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"one or two"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token number">3</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"three"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    _ <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"anything"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>匹配范围：<code>..=</code><ul>
<li>仅支持数字值或字符值。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">match</span> x <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// match value within [1, 5].</span>
    <span class="token number">1</span><span class="token punctuation">..</span><span class="token operator">=</span><span class="token number">5</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"one through five"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    _ <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"something else"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> 
<span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token string">'c'</span><span class="token punctuation">;</span>
<span class="token keyword">match</span> y <span class="token punctuation">{</span>
    <span class="token string">'a'</span><span class="token punctuation">..</span><span class="token operator">=</span><span class="token string">'j'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"early ASCII letter"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token string">'k'</span><span class="token punctuation">..</span><span class="token operator">=</span><span class="token string">'z'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"late ASCII letter"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    _ <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"something else"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>解构 struct：</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">struct</span> Point <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> i32<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> i32<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> Point <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">7</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// shorthand.</span>
    <span class="token keyword">let</span> Point <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span> p<span class="token punctuation">;</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// destructure with literal values as part of the struct pattern.</span>
    <span class="token keyword">match</span> p <span class="token punctuation">{</span>
        Point <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"On the x axis at {}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">,</span>
        Point <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"On the y axis at {}"</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span>
        Point <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"On neither axis: ({}, {})"</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>解构 enum：</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">enum</span> Color <span class="token punctuation">{</span>
    <span class="token function">Rgb</span><span class="token punctuation">(</span>i32<span class="token punctuation">,</span> i32<span class="token punctuation">,</span> i32<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">Hsv</span><span class="token punctuation">(</span>i32<span class="token punctuation">,</span> i32<span class="token punctuation">,</span> i32<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">struct</span> Upgrade <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> i32<span class="token punctuation">,</span> time<span class="token punctuation">:</span> i32
<span class="token punctuation">}</span>
<span class="token keyword">enum</span> Message <span class="token punctuation">{</span>
    Quit<span class="token punctuation">,</span>
    Move <span class="token punctuation">{</span> x<span class="token punctuation">:</span> i32<span class="token punctuation">,</span> y<span class="token punctuation">:</span> i32<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">Write</span><span class="token punctuation">(</span>String<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">ChangeColor</span><span class="token punctuation">(</span>Color<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">Upgrade</span><span class="token punctuation">(</span>Upgrade<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> msg <span class="token operator">=</span> Message<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">ChangeColor</span><span class="token punctuation">(</span>Color<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Hsv</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">match</span> msg <span class="token punctuation">{</span>
        Message<span class="token punctuation">:</span><span class="token punctuation">:</span>Quit <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        Message<span class="token punctuation">:</span><span class="token punctuation">:</span>Move <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token punctuation">}</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        Message<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Write</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        Message<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">ChangeColor</span><span class="token punctuation">(</span>Color<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Hsv</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> s<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        Message<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">ChangeColor</span><span class="token punctuation">(</span>Color<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Rgb</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        Message<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Upgrade</span><span class="token punctuation">(</span>Upgrade <span class="token punctuation">{</span> id<span class="token punctuation">,</span> time <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="65">
<li><span class="pn">Page 449</span><strong>忽略模式中的部分值</strong>：</li>
</ol>
<ul>
<li>忽略函数定义的某个参数：</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">foo</span><span class="token punctuation">(</span>_<span class="token punctuation">:</span> i32<span class="token punctuation">,</span> y<span class="token punctuation">:</span> i32<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"This code only uses the y parameter: {}"</span><span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>忽略复合语句中的某个值：</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> <span class="token keyword">mut</span> setting_value <span class="token operator">=</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">let</span> new_setting_value <span class="token operator">=</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">match</span> <span class="token punctuation">(</span>setting_value<span class="token punctuation">,</span> new_setting_value<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token punctuation">(</span><span class="token function">Some</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Some</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Can't overwrite an existing customized value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _ <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        setting_value <span class="token operator">=</span> new_setting_value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"setting is {:?}"</span><span class="token punctuation">,</span> setting_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>忽略集合中的多余值：<code>..</code>。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">struct</span> Point <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> i32<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> i32<span class="token punctuation">,</span>
    z<span class="token punctuation">:</span> i32<span class="token punctuation">,</span> 
<span class="token punctuation">}</span>
<span class="token keyword">let</span> origin <span class="token operator">=</span> Point <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">match</span> origin <span class="token punctuation">{</span>
    Point <span class="token punctuation">{</span> x<span class="token punctuation">,</span> <span class="token punctuation">..</span><span class="token punctuation">,</span> z <span class="token punctuation">}</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"x is {}, z is {}"</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="66">
<li><span class="pn">Page 453</span><strong>Match Grard</strong>：在 match-arm 中可以额外使用的 <em>if</em> 关键字；在进行匹配时，该 <em>if</em> 所表达的条件也需要被匹配。</li>
</ol>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">let</span> num <span class="token operator">=</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">match</span> num <span class="token punctuation">{</span>
    <span class="token function">Some</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">if</span> x <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"less than five: {}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token function">Some</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">,</span>
    None <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="67">
<li><span class="pn">Page 455</span><code>@</code> 绑定：</li>
</ol>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">enum</span> Message <span class="token punctuation">{</span>
    Hello <span class="token punctuation">{</span> id<span class="token punctuation">:</span> i32 <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> msg <span class="token operator">=</span> Message<span class="token punctuation">:</span><span class="token punctuation">:</span>Hello <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">match</span> msg <span class="token punctuation">{</span>
    Message<span class="token punctuation">:</span><span class="token punctuation">:</span>Hello <span class="token punctuation">{</span>
        id<span class="token punctuation">:</span> id <span class="token operator">@</span> <span class="token number">3</span><span class="token punctuation">..</span><span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// create a variable "id" that holds a value of the tested value.</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Found an id in range: {}"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">,</span> 
    Message<span class="token punctuation">:</span><span class="token punctuation">:</span>Hello <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">..</span><span class="token operator">=</span><span class="token number">12</span> <span class="token punctuation">}</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Found an id in another range"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    Message<span class="token punctuation">:</span><span class="token punctuation">:</span>Hello <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Found some other id: {}"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Chapter-19-Advanced-Features"><a href="#Chapter-19-Advanced-Features" class="headerlink" title="Chapter 19 - Advanced Features"></a>Chapter 19 - Advanced Features</h3><ol start="68">
<li><span class="pn">Page 457</span>不安全的 Rust：</li>
</ol>
<ul>
<li>unsafe 不会禁用 Rust 固有的诸如 borrow-checker 等安全检查；使用 unsafe 关键字只能使我们访问五个特殊的 cases，编译器将不会检查这五个 cases 下的内存安全性。</li>
</ul>
<p>- <em><strong>解引用一个原始指针</strong></em>：</p>
<ul>
<li>原始指针：<code>*const T</code> 与 <code>*mut T</code>；<ul>
<li>忽略“借用规则”，允许在一个位置同时拥有可变与不可变指针，或拥有多个可变指针；</li>
<li>不保证会指向有效的内存；</li>
<li>值可以为 <em>null</em>（由标准库的包装类 <em>std::ptr::null()</em> 提供）；</li>
<li>不会实现任何自动清理（比如 <code>Box&lt;T&gt;</code>）。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">let</span> <span class="token keyword">mut</span> num <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// let r1: *const i32 = &amp;num;</span>
    <span class="token comment" spellcheck="true">// let r2: *mut i32 = &amp;mut num;</span>
    <span class="token keyword">let</span> r1 <span class="token operator">=</span> <span class="token operator">&amp;</span>num <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">const</span> i32<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// immutable raw pointer.</span>
    <span class="token keyword">let</span> r2 <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> num <span class="token keyword">as</span> <span class="token operator">*</span><span class="token keyword">mut</span> i32<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// mutable raw pointer.</span>
    <span class="token keyword">let</span> r3 <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> num<span class="token punctuation">;</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> <span class="token operator">*</span>r1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> <span class="token operator">*</span>r2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> r3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>- <em><strong>调用不安全的函数或方法</strong></em>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">split_at_mut</span><span class="token punctuation">(</span>slice<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">,</span> mid<span class="token punctuation">:</span> usize<span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span>i32<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">let</span> len <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> ptr <span class="token operator">=</span> slice<span class="token punctuation">.</span><span class="token function">as_mut_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert!</span><span class="token punctuation">(</span>mid <span class="token operator">&lt;=</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> 
        <span class="token punctuation">(</span>
            std<span class="token punctuation">:</span><span class="token punctuation">:</span>slice<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from_raw_parts_mut</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// move raw pointer forward.</span>
            std<span class="token punctuation">:</span><span class="token punctuation">:</span>slice<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from_raw_parts_mut</span><span class="token punctuation">(</span>ptr<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mid<span class="token punctuation">)</span><span class="token punctuation">,</span> len <span class="token operator">-</span> mid<span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>FFI（Foreign Function Interface）：</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// a Rust function can be called from C, used by compiling to a shared library and linked from C.</span>
<span class="token attribute attr-name">#[no_mangle]</span>
<span class="token keyword">pub</span> <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">fn</span> <span class="token function">call_from_c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Just called a Rust function from C!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">abs</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> i32<span class="token punctuation">)</span> <span class="token punctuation">-></span> i32<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Absolute value of -3 according to C: {}"</span><span class="token punctuation">,</span> <span class="token function">abs</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>- <em><strong>访问或修改可变的静态变量</strong></em>：</p>
<ul>
<li>即“全局变量”，在 Rust 中被称为“静态变量”；</li>
<li>访问和修改可变静态变量是不安全的，因为其在多线程情况下可能导致数据竞争。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">static</span> <span class="token keyword">mut</span> COUNTER<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function">add_to_count</span><span class="token punctuation">(</span>inc<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        COUNTER <span class="token operator">+=</span> inc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token function">add_to_count</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"COUNTER: {}"</span><span class="token punctuation">,</span> COUNTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>- <em><strong>实现不安全的 trait</strong></em>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">unsafe</span> <span class="token keyword">trait</span> Foo <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> Foo <span class="token keyword">for</span> i32 <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>- <em><strong>访问 Union 中的字段</strong></em>：同 C/C++ 中的 <em>union</em> 类似。</p>
<pre class="line-numbers language-rust"><code class="language-rust">union MyUnion <span class="token punctuation">{</span>
    f1<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    f2<span class="token punctuation">:</span> f32<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">let</span> u <span class="token operator">=</span> MyUnion <span class="token punctuation">{</span> f1<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> f <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>f1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="69">
<li><span class="pn">Page 467</span><strong>高级 Traits</strong>：</li>
</ol>
<p>- <em><strong>使用 Associated Types 为 trait 指定“占位”类型</strong></em>：</p>
<ul>
<li>Associated Types 将类型占位符与 trait 连接在一起，以便 <em>trait method</em> 的定义可以在其签名中使用这些占位符类型。<strong>trait 的实现者将指定用于特定实现的该类型场景中要使用的具体类型</strong>。这样，我们可以定义使用某些类型的 trait，而无需确切了解这些类型是什么，直到实现该 trait；</li>
<li><em><strong>为什么不使用泛型 trait 来实现？</strong></em>主要由于：<ul>
<li>从写法上，使用泛型 trait 在调用 trait 方法时需要显式指定类型；</li>
<li>将类型强绑定到 trait，会导致可以为 struct 实现不同泛型的 trait，这样 trait 的具体类型与 struct 的类型会由两部分来共同指定（违背 “<em>the truth of source</em>” 原则）。因此两个类型统一由 struct 的实现来指定则更加方便（写法上）和统一。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// trait "Iterator" from std.</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> Iterator <span class="token punctuation">{</span>
    <span class="token keyword">type</span> Item<span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Option<span class="token operator">&lt;</span>Self<span class="token punctuation">:</span><span class="token punctuation">:</span>Item<span class="token operator">></span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>- <em><strong>默认泛型类型参数与运算符重载</strong></em>：</p>
<ul>
<li>位于 <code>std::ops</code> 下的 trait 的默认行为可以被覆写，这些 trait 有关于一些基本运算符在不同类型上的行为。<strong>默认情况下，运算符的 “Rhs” 操作数与实现对应 trait 的类型相同</strong>；</li>
<li>使用“默认泛型类型参数”的目的：<ul>
<li>可以减少一些模板代码的编写；</li>
<li>用于对已有的 trait 进行扩展（如：已有 trait 仅针对固定类型，而扩展想要为其增加更多类型的支持），而不破坏已经实现的功能。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>ops<span class="token punctuation">:</span><span class="token punctuation">:</span>Add<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// the "Rhs" of the Add operation is the the type we’re implementing Add on.</span>
<span class="token comment" spellcheck="true">// trait Add&lt;Rhs=Self> {  </span>
<span class="token comment" spellcheck="true">//     type Output;</span>
<span class="token comment" spellcheck="true">//     fn add(self, rhs: Rhs) -> Self::Output; </span>
<span class="token comment" spellcheck="true">// }</span>

<span class="token attribute attr-name">#[derive(Debug, PartialEq)]</span>
<span class="token keyword">struct</span> Point <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> i32<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> i32<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// impl Add&lt;Point> for Point { ...</span>
<span class="token keyword">impl</span> Add <span class="token keyword">for</span> Point <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// the default "Rhs" would be the "Point".</span>
    <span class="token keyword">type</span> Output <span class="token operator">=</span> Point<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// determines the type returned from the add method.</span>
    <span class="token keyword">fn</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> other<span class="token punctuation">:</span> Point<span class="token punctuation">)</span> <span class="token punctuation">-></span> Point <span class="token punctuation">{</span>
        Point <span class="token punctuation">{</span>
            x<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>x <span class="token operator">+</span> other<span class="token punctuation">.</span>x<span class="token punctuation">,</span>
            y<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>y <span class="token operator">+</span> other<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span>
        Point <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token operator">+</span> Point <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        Point <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">3</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>- <em><strong>用于消除歧义的语法：调用具有相同名称的方法</strong></em>。</p>
<ul>
<li>对于 <em>method</em>：</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">trait</span> Pilot <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">fly</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">trait</span> Wizard <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">fly</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">struct</span> Human<span class="token punctuation">;</span>
<span class="token keyword">impl</span> Pilot <span class="token keyword">for</span> Human <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">fly</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"This is your captain speaking."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> Wizard <span class="token keyword">for</span> Human <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">fly</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Up."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> Human <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">fly</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Wizard<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">fly</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"*waving arms furiously*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">let</span> person <span class="token operator">=</span> Human<span class="token punctuation">;</span> 
    Pilot<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">fly</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Wizard<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">fly</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Human<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">fly</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>
    person<span class="token punctuation">.</span><span class="token function">fly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>对于 <em>associated function</em>：</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">trait</span> Animal <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">baby_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> String<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">struct</span> Dog<span class="token punctuation">;</span>
<span class="token keyword">impl</span> Dog <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">baby_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> String <span class="token punctuation">{</span>
        String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Spot"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> Animal <span class="token keyword">for</span> Dog <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">baby_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> String <span class="token punctuation">{</span>
        String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"puppy"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment" spellcheck="true">// use "fully qualified syntax" to point out which one we want to call.</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"A baby dog is called a {}"</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>Dog <span class="token keyword">as</span> Animal<span class="token operator">></span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">baby_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>- <em><strong>一个 trait 的实现依赖于另一个 trait 提供的功能</strong></em>：</p>
<ul>
<li>一个 trait 实现所依赖的另一个 trait 被称为 “<em>supertrait</em>”。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>fmt<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// the "OutlinePrint" trait requires "fmt::Display" trait.</span>
<span class="token keyword">trait</span> OutlinePrint<span class="token punctuation">:</span> fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Display <span class="token punctuation">{</span> 
    <span class="token keyword">fn</span> <span class="token function">outline_print</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// call the method defined on the "fmt::Display" trait.</span>
        <span class="token keyword">let</span> len <span class="token operator">=</span> output<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"*{}*"</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"* {} *"</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"*{}*"</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>len <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span class="token keyword">struct</span> Point <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> i32<span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> i32<span class="token punctuation">,</span> 
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> OutlinePrint <span class="token keyword">for</span> Point <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span> fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Display <span class="token keyword">for</span> Point <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Formatter<span class="token punctuation">)</span> <span class="token punctuation">-></span> fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Result <span class="token punctuation">{</span>
        <span class="token function">write!</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"({}, {})"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    Point <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">outline_print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>- <em><strong>在外部类型上“实现”外部 trait</strong></em>：</p>
<ul>
<li>可以借助 <em>newtype pattern</em> 来“打破” trait 定义的“孤儿法则（triat 的定义或者类型的定义，二者之一必须在本地，才可以为某个类型实现某个 <em>triat</em>）”；</li>
<li>此处的 <em>newtype pattern</em> 只是一个 workaround，意味着<b>其添加的行为只会影响 <em>newtype</em>，而无法实际影响外部的类型</b>。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>fmt<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>ops<span class="token punctuation">:</span><span class="token punctuation">:</span>Deref<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token function">Wrapper</span><span class="token punctuation">(</span>Vec<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">impl</span> fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Display <span class="token keyword">for</span> Wrapper <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Formatter<span class="token punctuation">)</span> <span class="token punctuation">-></span> fmt<span class="token punctuation">:</span><span class="token punctuation">:</span>Result <span class="token punctuation">{</span>
        <span class="token function">write!</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token string">"[{}]"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">", "</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> Deref <span class="token keyword">for</span> Wrapper <span class="token punctuation">{</span>
    <span class="token keyword">type</span> Target <span class="token operator">=</span> Vec<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span>Self<span class="token punctuation">:</span><span class="token punctuation">:</span>Target <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> w <span class="token operator">=</span> <span class="token function">Wrapper</span><span class="token punctuation">(</span><span class="token function">vec!</span><span class="token punctuation">[</span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"w = {}"</span><span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> w<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">" | "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// call the methods on the warpped value (by implementing "Defer").</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="70">
<li><span class="pn">Page 479</span><strong>高级类型</strong>：</li>
</ol>
<p>- <em><strong>使用“类型别名”创建同义类型</strong></em>：</p>
<ul>
<li>用于为复杂类型起“别名”，以使代码编写更加清晰；</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// an example from the std::io module.</span>
<span class="token comment" spellcheck="true">// type Result&lt;T> = std::result::Result&lt;T, std::io::Error>;</span>
<span class="token keyword">type</span> Kilometers <span class="token operator">=</span> i32<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// a type alias for i32.</span>
<span class="token keyword">let</span> x<span class="token punctuation">:</span> i32 <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> y<span class="token punctuation">:</span> Kilometers <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"x + y = {}"</span><span class="token punctuation">,</span> x <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>- <em><strong>Never 类型</strong></em>：<code>!</code>。</p>
<ul>
<li>在“类型论”中，<code>!</code> 类型被称为“空类型（<em>empty type</em>）”，不产生任何值；</li>
<li>可用于表示一个函数，<strong>在调用后永不返回</strong>（<em>diverging functions</em>）；</li>
<li><code>!</code> 类型<strong>可以被强制转换为其他任何类型</strong>；</li>
<li>常见的 <code>loop &#123;&#125;</code> \ <code>panic!</code> \ <code>continue</code> 等表达式的返回值都为 <code>!</code> 类型。</li>
</ul>
<p>- <em><strong>动态大小类型（DSTs）与 <code>Sized</code> trait</strong></em>：</p>
<ul>
<li>这些类型的内存占用大小只能在运行时得知，比如 <em>str</em> 类型；</li>
<li>动态大小类型使用的黄金法则：<strong>必须始终将动态大小类型的值放在某种类型的指针后面</strong>，如：*&amp;<em>、</em>Box&lt;T&gt;<em>、</em>Rc&lt;T&gt;* 等；</li>
<li>默认情况下，所有泛型默认情况下都实现了 <em>Sized</em> trait，意味着需要编译时知道该类型的具体大小。某些情况下，可以通过特殊的 <code>?Sized</code> 语法<strong>放宽</strong>这个要求。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> generic<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>t<span class="token punctuation">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">fn</span> generic<span class="token operator">&lt;</span>T<span class="token punctuation">:</span> Sized<span class="token operator">></span><span class="token punctuation">(</span>t<span class="token punctuation">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// by default, the size of T should be known at compile time.</span>
<span class="token comment" spellcheck="true">// "T may or may not be Sized" (this syntax only works for the Sized trait).</span>
<span class="token keyword">fn</span> generic<span class="token operator">&lt;</span>T<span class="token punctuation">:</span> ?Sized<span class="token operator">></span><span class="token punctuation">(</span>t<span class="token punctuation">:</span> <span class="token operator">&amp;</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="71">
<li><span class="pn">Page 486</span><strong>高级函数与闭包</strong>：</li>
</ol>
<p>- <em><strong>函数指针</strong></em>：</p>
<ul>
<li>用关键字 <code>fn</code> 标识；</li>
<li>默认实现了所有 <em>Fn</em>，<em>FnMut</em>，<em>FnOnce</em> 三个闭包 trait，因此<strong>函数指针可以传递给接受闭包作为参数的函数</strong>。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">add_one</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> i32<span class="token punctuation">)</span> <span class="token punctuation">-></span> i32 <span class="token punctuation">{</span>
    x <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// accept a function pointer.</span>
<span class="token keyword">fn</span> <span class="token function">do_twice</span><span class="token punctuation">(</span>f<span class="token punctuation">:</span> <span class="token keyword">fn</span><span class="token punctuation">(</span>i32<span class="token punctuation">)</span> <span class="token punctuation">-></span> i32<span class="token punctuation">,</span> arg<span class="token punctuation">:</span> i32<span class="token punctuation">)</span> <span class="token punctuation">-></span> i32 <span class="token punctuation">{</span>
    <span class="token function">f</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">f</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> answer <span class="token operator">=</span> <span class="token function">do_twice</span><span class="token punctuation">(</span>add_one<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"The answer is: {}"</span><span class="token punctuation">,</span> answer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>鉴于 <em>tuple struct</em> 的初始化方式与函数调用相似，因此某些场景下也可以直接使用其来替代函数或闭包的行为。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">enum</span> Status <span class="token punctuation">{</span>
    <span class="token function">Value</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Stop<span class="token punctuation">,</span> 
<span class="token punctuation">}</span>
<span class="token keyword">let</span> list_of_statuses<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>Status<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0u32</span><span class="token punctuation">..</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Status<span class="token punctuation">:</span><span class="token punctuation">:</span>Value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>- <em><strong>返回闭包（函数）</strong></em>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// we can return a function pointer directly.</span>
<span class="token keyword">fn</span> <span class="token function">returns_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token keyword">fn</span><span class="token punctuation">(</span>i32<span class="token punctuation">)</span> <span class="token punctuation">-></span> i32 <span class="token punctuation">{</span> 
    <span class="token operator">|</span>x<span class="token operator">|</span> x <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// closures are represented by traits, so we can’t return closures directly.</span>
<span class="token keyword">fn</span> <span class="token function">returns_closure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Box<span class="token operator">&lt;</span>dyn <span class="token function">Fn</span><span class="token punctuation">(</span>i32<span class="token punctuation">)</span> <span class="token punctuation">-></span> i32<span class="token operator">></span> <span class="token punctuation">{</span> 
    Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">|</span>x<span class="token operator">|</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="72">
<li><span class="pn">Page 489</span><strong>宏</strong>：</li>
</ol>
<ul>
<li>使用 <code>macro_rules!</code> 的声明式宏（<em><strong>未来将不推荐使用</strong></em>）；</li>
<li>使用 <code>#[derive]</code> 的自定义宏，可以使用在 <em>strcut</em> 与 <em>enum</em> 上；</li>
<li>“类属性宏”，用于在任意条目上定义自定义属性；</li>
<li>“类函数宏”，使用方式类似函数，操作于传入的“符号”上。</li>
</ul>
<ol start="73">
<li><span class="pn">Page 490</span><strong>声明式宏</strong>：</li>
</ol>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[macro_export]</span>
<span class="token macro-rules function">macro_rules!</span> vec <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// similar to the "match" expression.</span>
    <span class="token comment" spellcheck="true">// captures values that match the pattern within the parentheses.</span>
    <span class="token comment" spellcheck="true">// "$x:expr" matches any Rust expression and gives the expression the name $x.</span>
    <span class="token punctuation">(</span> $<span class="token punctuation">(</span> $x<span class="token punctuation">:</span>expr <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// $x pattern matches three times with 1, 2 and 3.</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> temp_vec <span class="token operator">=</span> Vec<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// generated for each part that matches $() in the pattern zero or more times.</span>
            $<span class="token punctuation">(</span>
                temp_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>$x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">)</span><span class="token operator">*</span>
            <span class="token comment" spellcheck="true">// temp_vec.push(1); </span>
            <span class="token comment" spellcheck="true">// temp_vec.push(2); </span>
            <span class="token comment" spellcheck="true">// temp_vec.push(3);</span>
            temp_vec
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>u32<span class="token operator">></span> <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:#?}"</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="74">
<li><span class="pn">Page 492</span><strong>用于从属性生成代码的“过程式宏”</strong>：</li>
</ol>
<ul>
<li>目前，<strong>过程式宏仅能实现在其自己的独立 crate 中</strong>。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// the definition of the trait.</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> HelloMacro <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">hello_macro</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// the definition of the macro for the trait.</span>
<span class="token keyword">extern</span> <span class="token keyword">crate</span> proc_macro<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// the compiler’s API that allows us to read and manipulate Rust code.</span>
<span class="token keyword">use</span> proc_macro<span class="token punctuation">:</span><span class="token punctuation">:</span>TokenStream<span class="token punctuation">;</span> 
<span class="token comment" spellcheck="true">// turns "syn" data structures back into Rust code.</span>
<span class="token keyword">use</span> quote<span class="token punctuation">:</span><span class="token punctuation">:</span>quote<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// parses Rust code from a string into a data structure.</span>
<span class="token keyword">use</span> syn<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[proc_macro_derive(HelloMacro)]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">hello_macro_derive</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> TokenStream<span class="token punctuation">)</span> <span class="token punctuation">-></span> TokenStream <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// construct a representation of Rust code as a syntax tree </span>
    <span class="token comment" spellcheck="true">// that we can manipulate</span>
    <span class="token keyword">let</span> ast <span class="token operator">=</span> syn<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">parse</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Build the trait implementation</span>
    <span class="token function">impl_hello_macro</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ast<span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">impl_hello_macro</span><span class="token punctuation">(</span>ast<span class="token punctuation">:</span> <span class="token operator">&amp;</span>syn<span class="token punctuation">:</span><span class="token punctuation">:</span>DeriveInput<span class="token punctuation">)</span> <span class="token punctuation">-></span> TokenStream <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// the name of the struct implementing this trait.</span>
    <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token operator">&amp;</span>ast<span class="token punctuation">.</span>ident<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// define the Rust code that we want to return.</span>
    <span class="token keyword">let</span> gen <span class="token operator">=</span> <span class="token macro-rules function">quote!</span> <span class="token punctuation">{</span>
        <span class="token keyword">impl</span> HelloMacro <span class="token keyword">for</span> #name <span class="token punctuation">{</span> 
            <span class="token keyword">fn</span> <span class="token function">hello_macro</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// converting "#name" to a string literal at compile time.</span>
                <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Hello, Macro! My name is {}!"</span><span class="token punctuation">,</span> <span class="token function">stringify!</span><span class="token punctuation">(</span>#name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    gen<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// the usage of the macro.</span>
<span class="token keyword">use</span> hello_macro<span class="token punctuation">:</span><span class="token punctuation">:</span>HelloMacro<span class="token punctuation">;</span>
<span class="token keyword">use</span> hello_macro_derive<span class="token punctuation">:</span><span class="token punctuation">:</span>HelloMacro<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(HelloMacro)]</span>
<span class="token keyword">struct</span> Pancakes<span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    Pancakes<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">hello_macro</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="75">
<li><span class="pn">Page 498</span><strong>类属性宏</strong>：</li>
</ol>
<ul>
<li>允许创建除 <em>derive</em> 以外新的属性，更加灵活。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// the usage of the attribute-like macro.</span>
#<span class="token punctuation">[</span><span class="token function">route</span><span class="token punctuation">(</span>GET<span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">fn</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// the definition of the macro.</span>
<span class="token comment" spellcheck="true">// the first parameter is for the contents of the attribute: the [GET, "/"] part.</span>
<span class="token comment" spellcheck="true">// the second is the body of the item the attribute is attached to, namely [fn index() {}].</span>
<span class="token attribute attr-name">#[proc_macro_attribute]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">route</span><span class="token punctuation">(</span>attr<span class="token punctuation">:</span> TokenStream<span class="token punctuation">,</span> item<span class="token punctuation">:</span> TokenStream<span class="token punctuation">)</span> <span class="token punctuation">-></span> TokenStream <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="76">
<li><span class="pn">Page 499</span><strong>类函数宏</strong>：</li>
</ol>
<ul>
<li>使用方式同函数调用类似。比 <code>macro_rules!</code>（仅支持类 <em>match</em> 模式）的宏方式更加灵活。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// the usage of the function-like macro.</span>
<span class="token keyword">let</span> sql <span class="token operator">=</span> <span class="token function">sql!</span><span class="token punctuation">(</span>SELECT <span class="token operator">*</span> FROM posts WHERE id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// the definition of the macro.</span>
<span class="token comment" spellcheck="true">// receive the tokens that are inside the parentheses and return the code we wanted to generate.</span>
<span class="token attribute attr-name">#[proc_macro]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">sql</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> TokenStream<span class="token punctuation">)</span> <span class="token punctuation">-></span> TokenStream <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Chapter-20-Final-Project-Building-a-Multithreaded-Web-Server"><a href="#Chapter-20-Final-Project-Building-a-Multithreaded-Web-Server" class="headerlink" title="Chapter 20 - Final Project: Building a Multithreaded Web Server"></a>Chapter 20 - Final Project: Building a Multithreaded Web Server</h3><p>（略）</p>
<h3 id="Chapter-21-Appendix"><a href="#Chapter-21-Appendix" class="headerlink" title="Chapter 21 - Appendix"></a>Chapter 21 - Appendix</h3><ol start="77">
<li><span class="pn">Page 544</span><strong>Raw Identifier</strong>：</li>
</ol>
<ul>
<li>一种特殊语法，可以使我们<strong>使用语言关键字作为标识符</strong>；</li>
<li>一般仅用于代码库的“前向兼容”。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> r#<span class="token keyword">match</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"the function name is called {}"</span><span class="token punctuation">,</span> <span class="token string">"match"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    r#<span class="token keyword">match</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="78">
<li><span class="pn">Page 551</span><strong>可继承的 traits</strong>：</li>
</ol>
<ul>
<li><code>Debug</code>：可以在格式化字符串中使用调试格式 “*{:?}*”，以检查值的具体结构；</li>
<li><code>PartialEq</code>：可以使类型实例进行相等性比较（<code>==</code>、<code>!=</code>）；</li>
<li><code>Eq</code>：没有实现。其目的是用于表明每个被标记类型的值都等于其自身，既满足 “<em>equivalence relations</em>（自反性、对称性、传递性）”。而如“浮点数（如 NaN）”则不满足该关系，因此浮点数需要实现 PartialEq 而非 Eq；</li>
<li><code>PartialOrd</code>（依赖 PartialEq）：可以使类型实例之间进行比较，以便于进行排序（<code>&lt;</code>、<code>&gt;=</code>）；比较的结果不一定存在（可能为 <em>None</em>）。</li>
<li><code>Ord</code>（依赖 PartialOrd 与 Eq）：用于告知对于被标记类型的任何两个值，一定存在有效的<strong>全序</strong>（<em>total order</em>，即任何一对元素都是可相互比较的）。即对于集合 X 中的所有元素 a、b 和 c，存在：<ul>
<li><strong>反对称性</strong>：若 a &lt;= b 且 b &lt;= a，则 a = b；</li>
<li><strong>传递性</strong>：若 a &lt;= b 且 b &lt;= c，则 a &lt;= c；</li>
<li><strong>完全性</strong>（蕴含“自反性”，如 “a &lt;= a”）：a &lt;= b 或 b &lt;= a。</li>
</ul>
</li>
<li><code>Clone</code>：允许显式创建值的深层副本，并且复制过程可能涉及运行任意代码和复制堆数据；</li>
<li><code>Copy</code>：允许仅复制存储在堆栈中的位来复制值（如指针）；</li>
<li><code>Hash</code>：允许获取任意大小类型的实例，并使用哈希函数将该实例映射到固定大小的值；</li>
<li><code>Default</code>：允许为类型创建默认值。</li>
</ul>
<ol start="79">
<li><span class="pn">Page 555</span><strong>相关工具</strong>：</li>
</ol>
<ul>
<li><em>rustfmt</em>：代码格式化。运行 <code>cargo fmt</code> 以格式化整个项目中的代码；</li>
<li><em>rustfix</em>：自动修复编译器警告。运行 <code>cargo fix</code> 以进行自动修复；</li>
<li><em>clippy</em>：包含一系列 Linter，可以分析代码，以便捕获常见错误并改进 Rust 代码。运行 <code>cargo clippy</code> 以进行自动优化。</li>
</ul>
<br><div class="article-bottom-meta"><span class="post-meta">Last built on<time itemprop="dateModified" datetime="2021-04-08T15:48:43.000Z"> 2023 / 10 / 26, 11:37:10</time></span></div></div></article><br><span class="next-post"><a href="/2021/04/13/《The-Rustonomicon》读书笔记/" itemprop="url">下一篇 ⇒</a></span><span class="prev-post"><a href="/2021/04/01/《The-Rust-Programming-Language》读书笔记（第-12-16-章）/" itemprop="url">⇐ 上一篇</a></span><br><section id="comments"><div><script src="https://utteranc.es/client.js" repo="Becavalier/utterances-comments" issue-term="title" label="[Comment]" theme="github-light" crossorigin="anonymous" async></script></div></section><br><br></main><script src="/scripts/index.js" type="text/javascript"></script></body></html>