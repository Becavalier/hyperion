<!DOCTYPE html><html lang="en-us"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>《The Rust Programming Language》读书笔记（第 12-16 章） | 曜彤.手记</title><meta name="description" content="书接上回，第 12-16 章的笔记。"><meta name="generator" content="曜彤.手记"><meta name="about" content="[object Object]"><meta name="keywords" content="博客, C++, C, Rust, Web, Java, IT, 编程, 开发, Android, Python, MySQL, 科技, 黑客, 技术, Javascript, 云, 大数据, 计算, 机器学习, AI, 人工智能, 创业, 产品, 公司, WebAssembly, Wasm"><meta name="HandheldFriendly" content="True"><meta name="MobileOptimized" content="320"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=0"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="apple-touch-icon" sizes="57x57" href="/images/apple-touch-icon-57x57.jpg"><link rel="apple-touch-icon" sizes="60x60" href="/images/apple-touch-icon-60x60.jpg"><link rel="apple-touch-icon" sizes="72x72" href="/images/apple-touch-icon-72x72.jpg"><link rel="apple-touch-icon" sizes="76x76" href="/images/apple-touch-icon-76x76.jpg"><link rel="apple-touch-icon" sizes="114x114" href="/images/apple-touch-icon-114x114.jpg"><link rel="apple-touch-icon" sizes="120x120" href="/images/apple-touch-icon-120x120.jpg"><link rel="apple-touch-icon" sizes="144x144" href="/images/apple-touch-icon-144x144.jpg"><link rel="apple-touch-icon" sizes="152x152" href="/images/apple-touch-icon-152x152.jpg"><link rel="apple-touch-icon" sizes="196x196" href="/images/apple-touch-icon-196x196.jpg"><link rel="apple-touch-icon" sizes="310x310" href="/images/apple-touch-icon-310x310.jpg"><link href="/images/splash/iphone5_splash.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphone6_splash.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphoneplus_splash.png" media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/iphonex_splash.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/iphonexr_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/iphonexsmax_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image"><link href="/images/splash/ipad_splash.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro1_splash.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro3_splash.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link href="/images/splash/ipadpro2_splash.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png"><link rel="icon" type="image/png" sizes="128x128" href="/images/favicon-128.png"><link rel="icon" type="image/png" sizes="196x196" href="/images/favicon-196x196.png"><meta name="msapplication-TileColor" content="#FFFFFF"><meta name="msapplication-TileImage" content="mstile-144x144.png"><meta name="msapplication-square70x70logo" content="mstile-70x70.png"><meta name="msapplication-square150x150logo" content="mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="mstile-310x150.png"><meta name="msapplication-square310x310logo" content="mstile-310x310.png"><meta name="msapplication-square310x310logo" content="mstile-310x310.png"><link rel="manifest" href="/manifest.webmanifest"><link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="/atom.xml"><link rel="stylesheet" href="/css/prism-okaidia.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body itemscope itemtype="https://schema.org/WebPage"><div class="canvas-containter"><span>X</span></div><header itemscope itemtype="https://schema.org/WPHeader"><div class="logo"></div><h1 class="title"><a href="/" alt="曜彤.手记" title="曜彤.手记" itemprop="headline">曜彤.手记</a><a title="Atom 0.3" target="__blank" href="/atom.xml" class="rss"><img src="/images/rss.png"></a></h1><p itemprop="description" class="description">随记，关于互联网技术、产品与创业</p><nav itemscope itemtype="https://schema.org/SiteNavigationElement"><ul><li itemprop="name" class="menu-item"><a href="/ " alt="首页" title="首页" itemprop="url">首页</a></li><li itemprop="name" class="menu-item"><a href="/articles" alt="文章" title="文章" itemprop="url">文章</a></li><li itemprop="name" class="menu-item"><a href="/tags" alt="标签" title="标签" itemprop="url">标签</a></li><li itemprop="name" class="menu-item"><a href="/about" alt="关于" title="关于" itemprop="url">关于</a></li></ul></nav><div class="space"></div></header><main itemscope itemtype="https://schema.org/Blog"><script src="https://shadow.elemecdn.com/npm/zoomage.js@latest/dist/zoomage.min.js" type="text/javascript"></script><script src="https://shadow.elemecdn.com/npm/axios@0.18.0/dist/axios.min.js" type="text/javascript"></script><script src="/scripts/post.js" type="text/javascript"></script><div class="touch-top"><span></span></div><article post-id="《The Rust Programming Language》读书笔记（第 12-16 章）" class="full"><h1 itemprop="headline" class="align-center">《The Rust Programming Language》读书笔记（第 12-16 章）</h1><div class="content"><div class="article-meta"><span class="post-meta"><br>Created on<time itemprop="dateCreated" datetime="2021-04-01T10:07:48.000Z"> 2021 / 04 / 01, 18:07:48</time></span><span class="page-tag-anchor"><a href="/tags/Rust" itemprop="url">#Rust</a>&nbsp;&nbsp;</span></div><p>书接上回，第 12-16 章的笔记。</p>
<h3 id="Chapter-12-An-I-O-Project-Building-a-Command-Line-Program"><a href="#Chapter-12-An-I-O-Project-Building-a-Command-Line-Program" class="headerlink" title="Chapter 12 - An I/O Project: Building a Command Line Program"></a>Chapter 12 - An I/O Project: Building a Command Line Program</h3><ol start="33">
<li><span class="pn">Page 268</span>基本代码（Monolithic）：</li>
</ol>
<p>- <em><strong>src/main.rs</strong></em>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// src/main.rs</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>env<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>process<span class="token punctuation">;</span>
<span class="token keyword">use</span> minigrep<span class="token punctuation">:</span><span class="token punctuation">:</span>Config<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// "unwrap_or_else" allows us to define some non-panic error handling.</span>
    <span class="token comment" spellcheck="true">// "env::args()" returns an iterator.</span>
    <span class="token keyword">let</span> config <span class="token operator">=</span> Config<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>env<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap_or_else</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>err<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// closure (anonymous function).</span>
        <span class="token function">eprintln!</span><span class="token punctuation">(</span><span class="token string">"Problem parsing arguments: {}"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        process<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span> minigrep<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">run</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// prints to the standard error stream.</span>
        <span class="token function">eprintln!</span><span class="token punctuation">(</span><span class="token string">"Application error: {}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        process<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>- <em><strong>src/lib.rs</strong></em>：</p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// src/lib.rs</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>error<span class="token punctuation">:</span><span class="token punctuation">:</span>Error<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>fs<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>env<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// the function will return a type that implements the "Error" trait,</span>
<span class="token comment" spellcheck="true">// but we don’t have to specify what particular type the return value will be.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">run</span><span class="token punctuation">(</span>config<span class="token punctuation">:</span> Config<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Box<span class="token operator">&lt;</span>dyn Error<span class="token operator">>></span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// propagate errors.</span>
  <span class="token keyword">let</span> contents <span class="token operator">=</span> fs<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">read_to_string</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>filename<span class="token punctuation">)</span>?<span class="token punctuation">;</span>
  <span class="token keyword">let</span> results <span class="token operator">=</span> <span class="token keyword">if</span> config<span class="token punctuation">.</span>case_sensitive <span class="token punctuation">{</span>
    <span class="token function">search</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">.</span>query<span class="token punctuation">,</span> <span class="token operator">&amp;</span>contents<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">search_case_insensitive</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">.</span>query<span class="token punctuation">,</span> <span class="token operator">&amp;</span>contents<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> line <span class="token keyword">in</span> results <span class="token punctuation">{</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">// we’re calling "run" for its side effects only.</span>
  <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> Config <span class="token punctuation">{</span>
  <span class="token keyword">pub</span> query<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  <span class="token keyword">pub</span> filename<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  <span class="token keyword">pub</span> case_sensitive<span class="token punctuation">:</span> bool<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> Config <span class="token punctuation">{</span>
  <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">mut</span> args<span class="token punctuation">:</span> env<span class="token punctuation">:</span><span class="token punctuation">:</span>Args<span class="token punctuation">)</span> <span class="token punctuation">-></span> Result<span class="token operator">&lt;</span>Config<span class="token punctuation">,</span> <span class="token operator">&amp;</span>'<span class="token keyword">static</span> str<span class="token operator">></span> <span class="token punctuation">{</span>
      args<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// skip the filename.</span>
      <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token keyword">match</span> args<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">Some</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> arg<span class="token punctuation">,</span>
          None <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token string">"Didn't get a query string"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> filename <span class="token operator">=</span> <span class="token keyword">match</span> args<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">Some</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> arg<span class="token punctuation">,</span>
          None <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">return</span> <span class="token function">Err</span><span class="token punctuation">(</span><span class="token string">"Didn't get a file name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> case_sensitive <span class="token operator">=</span> env<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">var</span><span class="token punctuation">(</span><span class="token string">"CASE_INSENSITIVE"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">Ok</span><span class="token punctuation">(</span>Config <span class="token punctuation">{</span>
        query<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> case_sensitive<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> search<span class="token operator">&lt;</span><span class="token string">'a>(query: &amp;str, contents: &amp;'</span>a str<span class="token punctuation">)</span> <span class="token punctuation">-></span> Vec<span class="token operator">&lt;</span><span class="token operator">&amp;</span>'a str<span class="token operator">></span> <span class="token punctuation">{</span>
    contents<span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">|</span>line<span class="token operator">|</span> line<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> search_case_insensitive<span class="token operator">&lt;</span>'a<span class="token operator">></span><span class="token punctuation">(</span>
  query<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">,</span> 
  contents<span class="token punctuation">:</span> <span class="token operator">&amp;</span>'a str<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-></span> Vec<span class="token operator">&lt;</span><span class="token operator">&amp;</span>'a str<span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// will return a String, rather than string slice.</span>
  <span class="token keyword">let</span> query <span class="token operator">=</span> query<span class="token punctuation">.</span><span class="token function">to_lowercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> <span class="token keyword">mut</span> results <span class="token operator">=</span> Vec<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// "lines()" returns an iterator.</span>
  <span class="token keyword">for</span> line <span class="token keyword">in</span> contents<span class="token punctuation">.</span><span class="token function">lines</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> line<span class="token punctuation">.</span><span class="token function">to_lowercase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>query<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  results
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[cfg(test)]</span>
<span class="token keyword">mod</span> tests <span class="token punctuation">{</span>
  <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">*</span><span class="token punctuation">;</span>

  <span class="token attribute attr-name">#[test]</span>
  <span class="token keyword">fn</span> <span class="token function">one_result</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token string">"duct"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> contents <span class="token operator">=</span> "\
Rust<span class="token punctuation">:</span>
safe<span class="token punctuation">,</span> fast<span class="token punctuation">,</span> productive<span class="token punctuation">.</span>
Pick three<span class="token punctuation">.</span>
Duct tape<span class="token punctuation">.</span>"<span class="token punctuation">;</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span><span class="token function">vec!</span><span class="token punctuation">[</span><span class="token string">"safe, fast, productive."</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">search</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token attribute attr-name">#[test]</span>
  <span class="token keyword">fn</span> <span class="token function">case_insensitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> query <span class="token operator">=</span> <span class="token string">"rUsT"</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> contents <span class="token operator">=</span> "\
Rust<span class="token punctuation">:</span>
safe<span class="token punctuation">,</span> fast<span class="token punctuation">,</span> productive<span class="token punctuation">.</span>
Pick three<span class="token punctuation">.</span>
Trust me<span class="token punctuation">.</span>"<span class="token punctuation">;</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span>
      <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token string">"Rust:"</span><span class="token punctuation">,</span> <span class="token string">"Trust me."</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
      <span class="token function">search_case_insensitive</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> contents<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="34">
<li><span class="pn">Page 286</span><strong>TDD</strong>（Test-Driven Development）的基本实施步骤：</li>
</ol>
<ul>
<li>编写一个会导致失败的测试，并确定其失败原因符合预期；</li>
<li>添加或修改实现代码使得该测试可以通过；</li>
<li>重构上一步中新添加的代码或修改的代码，同时保证测试持续通过；</li>
<li>重复第一步。</li>
</ul>
<h3 id="Chapter-13-Functional-Language-Features-Iterators-and-Closures"><a href="#Chapter-13-Functional-Language-Features-Iterators-and-Closures" class="headerlink" title="Chapter 13 - Functional Language Features: Iterators and Closures"></a>Chapter 13 - Functional Language Features: Iterators and Closures</h3><ol start="35">
<li><span class="pn">Page 288</span><strong>闭包</strong>（Closure）：</li>
</ol>
<ul>
<li>即“<strong>匿名函数</strong>”（与 C++ 中的 Lambda 类似），可以赋值给变量、作为参数或返回值；</li>
<li>普通函数通常需要被作为公共接口，从而提供给外部用户使用，因此需要类型注解；而闭包通常仅用于非暴露的内部代码，且作为匿名函数使用。不仅如此，闭包实现通常较短且仅与其定义上下文的一小块逻辑相关联，因此<strong>编译器可以可靠地自动推断闭包函数的输入参数与返回值的类型</strong>；</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">add_one_v1</span> <span class="token punctuation">(</span>x<span class="token punctuation">:</span>u32<span class="token punctuation">)</span> <span class="token punctuation">-></span> u32 <span class="token punctuation">{</span> x <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// function definition.</span>
<span class="token keyword">let</span> add_one_v2 <span class="token operator">=</span> <span class="token closure-params"><span class="token punctuation">|</span>x<span class="token punctuation">:</span> u32<span class="token punctuation">|</span></span> <span class="token punctuation">-></span> u32 <span class="token punctuation">{</span> x <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// the rests are closure definition.</span>
<span class="token keyword">let</span> add_one_v3 <span class="token operator">=</span> <span class="token closure-params"><span class="token punctuation">|</span>x<span class="token punctuation">|</span></span> <span class="token punctuation">{</span> x <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token keyword">let</span> add_one_v4 <span class="token operator">=</span> <span class="token operator">|</span>x<span class="token operator">|</span> x <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>可以<strong>捕获</strong>其定义所在作用域内的其他变量值。在捕获时，闭包会使用<strong>额外的内存</strong>来存放捕获的变量值。闭包可以使用三种方式来捕获外界的变量：<ul>
<li><code>FnOnce</code>：将捕获变量的<strong>所有权转移到闭包中</strong>，比如使用 <code>move</code> 标记的闭包（所有闭包默认均实现，一般仅能被执行一次）；</li>
<li><code>FnMut</code>：以“<strong>可变引用</strong>”的方式捕获外界变量；</li>
<li><code>Fn</code>：以“<strong>不可变引用</strong>”的方式捕获外界变量。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> equal_to_x <span class="token operator">=</span> <span class="token keyword">move</span> <span class="token operator">|</span>z<span class="token operator">|</span> z <span class="token operator">==</span> x<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// the value of "x" has been moved into the closure.</span>
    <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">assert!</span><span class="token punctuation">(</span><span class="token function">equal_to_x</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>每个闭包实例都有自己独一无二的的匿名类型，即使两个闭包有同样的签名，它们的类型也并不相同。为了定义可以容纳闭包的集合，可以使用 <code>Fn</code> \ <code>FnMut</code> \ <code>FnOnce</code> traits，</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// memoization.</span>
<span class="token keyword">struct</span> Cacher<span class="token operator">&lt;</span>T<span class="token operator">></span>
<span class="token keyword">where</span> T<span class="token punctuation">:</span> <span class="token function">Fn</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span> <span class="token punctuation">-></span> u32<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  calculation<span class="token punctuation">:</span> T<span class="token punctuation">,</span>
  value<span class="token punctuation">:</span> Option<span class="token operator">&lt;</span>u32<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span>T<span class="token operator">></span> Cacher<span class="token operator">&lt;</span>T<span class="token operator">></span> 
<span class="token keyword">where</span> T<span class="token punctuation">:</span> <span class="token function">Fn</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span> <span class="token punctuation">-></span> u32<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>calculation<span class="token punctuation">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">-></span> Cacher<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
        Cacher <span class="token punctuation">{</span>
            calculation<span class="token punctuation">,</span>
            value<span class="token punctuation">:</span> None<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">fn</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> arg<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">-></span> u32 <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token punctuation">{</span>
            <span class="token function">Some</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> v<span class="token punctuation">,</span>
            None <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>calculation<span class="token punctuation">)</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">Some</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
                v
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="36">
<li><span class="pn">Page 303</span><strong>迭代器</strong>（Iterator）：</li>
</ol>
<ul>
<li>允许<strong>按顺序</strong>对一个序列中的元素依次进行处理；</li>
<li>Rust 中的迭代器是 “<strong>lazy</strong>” 的，即在每一次调用 <code>next()</code> 时（显式/隐式）才会返回集合中的元素。<strong><em>for-in</em> 语句会转移迭代器对象的所有权</strong>；</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v1 <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> v1_iter <span class="token operator">=</span> v1<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// return an iterator for v1.</span>
    <span class="token keyword">for</span> val <span class="token keyword">in</span> v1_iter <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>所有迭代器都实现了标准库中定义的 <em>Iterator</em> trait，以及对应的 <code>next()</code> 方法。集合的三种迭代器类型：<ul>
<li><code>iter()</code>：返回<strong>不可变引用</strong>；</li>
<li><code>iter_mut()</code>：返回<strong>可变引用</strong>；</li>
<li><code>into_iter()</code>：返回<strong>集合元素的所有权</strong>。</li>
</ul>
</li>
<li>当迭代器被“<strong>用尽</strong>（<em>consuming out</em>）”后，无法再被重复使用。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> x <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> v1_iter <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token operator">&amp;</span>val <span class="token keyword">in</span> v1_iter <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// got immutable references to the values inside "x".</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> v2_iter <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">iter_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">=</span> v2_iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// pattern matching.</span>
        <span class="token comment" spellcheck="true">// got mutable references.   </span>
        <span class="token operator">*</span>v <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// dereference and assign.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> v3_iter <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> val <span class="token keyword">in</span> v3_iter <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// take the ownership of the values.</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{}"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// println!("{:#?}", x);  // panic!.</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>可以通过 <em>iterator adaptor</em> 将一个迭代器转换为另一种迭代器。通过这种方式，可以“串联”起多个适配器以对集合中的数据进行不同的转换：</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v1<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>i32<span class="token operator">></span> <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// the iterator adaptor is lazy.</span>
    <span class="token keyword">let</span> v2<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>_<span class="token operator">></span> <span class="token operator">=</span> v1<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span>x<span class="token operator">|</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:#?}"</span><span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>结合使用迭代器与闭包：</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(PartialEq, Debug)]</span>
<span class="token keyword">struct</span> Shoe <span class="token punctuation">{</span>
    size<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
    style<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function">shoes_in_my_size</span><span class="token punctuation">(</span>shoes<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>Shoe<span class="token operator">></span><span class="token punctuation">,</span> shoe_size<span class="token punctuation">:</span> u32<span class="token punctuation">)</span> <span class="token punctuation">-></span> Vec<span class="token operator">&lt;</span>Shoe<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// capture the surrounding parameter.</span>
    shoes<span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token operator">|</span>s<span class="token operator">|</span> s<span class="token punctuation">.</span>size <span class="token operator">==</span> shoe_size<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><strong>自定义迭代器</strong>：为自定义类型实现 <code>Iterator</code> trait；</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">struct</span> Counter <span class="token punctuation">{</span>
    count<span class="token punctuation">:</span> u32<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> Counter <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Counter <span class="token punctuation">{</span>
        Counter <span class="token punctuation">{</span> count<span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> Iterator <span class="token keyword">for</span> Counter <span class="token punctuation">{</span>
    <span class="token keyword">type</span> Item <span class="token operator">=</span> u32<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// the iterator will return u32.</span>
    <span class="token keyword">fn</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Option<span class="token operator">&lt;</span>Self<span class="token punctuation">:</span><span class="token punctuation">:</span>Item<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token keyword">self</span><span class="token punctuation">.</span>count <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token punctuation">{</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">Some</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            None
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> counter <span class="token operator">=</span> Counter<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> counter<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> counter_v<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>_<span class="token operator">></span> <span class="token operator">=</span> counter<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token operator">|</span>x<span class="token operator">|</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"{:#?}"</span><span class="token punctuation">,</span> counter_v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>迭代器是 Rust 众多“<strong>零开销抽象</strong>（<em>zero-cost abstractions</em>）”特性之一，因此相较于使用手写的循环实现，<strong>使用迭代器不会产生额外的性能开销</strong>（C++ 的实现类似）。</li>
</ul>
<h3 id="Chapter-14-More-About-Cargo-and-Crates-io"><a href="#Chapter-14-More-About-Cargo-and-Crates-io" class="headerlink" title="Chapter 14 - More About Cargo and Crates.io"></a>Chapter 14 - More About Cargo and Crates.io</h3><ol start="37">
<li><span class="pn">Page 320</span>自定义<strong>发布和开发时选项</strong>：</li>
</ol>
<pre class="line-numbers language-toml"><code class="language-toml">[profile.dev]  # from 1 to 3.
opt-level = 0

[profile.release] 
opt-level = 3
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="38">
<li><span class="pn">Page 321</span><strong>文档注释</strong>：<code>///</code>。</li>
</ol>
<ul>
<li>在执行 <code>cargo doc --open</code> 时会自动生成含有描述公有 API 使用方法的 HTML 版本文档；</li>
<li>在执行 <code>cargo test</code> 时，文档注释中的测试用例也会自动执行；</li>
<li>在注释中支持使用 Markdown 格式。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">/// Adds one to the number given.</span>
<span class="token comment" spellcheck="true">/// # Examples</span>
<span class="token comment" spellcheck="true">///</span>
<span class="token comment" spellcheck="true">/// ```</span>
<span class="token comment" spellcheck="true">/// let arg = 5;</span>
<span class="token comment" spellcheck="true">/// let answer = my_crate::add_one(arg); ///</span>
<span class="token comment" spellcheck="true">/// assert_eq!(6, answer);</span>
<span class="token comment" spellcheck="true">/// ```</span>
<span class="token comment" spellcheck="true">/// # Panics</span>
<span class="token comment" spellcheck="true">/// // describe the exposed functions that may cause panic.</span>
<span class="token comment" spellcheck="true">/// # Errors</span>
<span class="token comment" spellcheck="true">/// // describe the exposed functions that returns Result.</span>
<span class="token comment" spellcheck="true">/// # Safety</span>
<span class="token comment" spellcheck="true">/// // describe the exposed functions which are unsafe.</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">add_one</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> i32<span class="token punctuation">)</span> <span class="token punctuation">-></span> i32 <span class="token punctuation">{</span>
    x <span class="token operator">+</span> <span class="token number">1</span> 
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="39">
<li><span class="pn">Page 323</span>用于<strong>整体描述模块内容的注释</strong>类型：</li>
</ol>
<ul>
<li>一般用在 <em>crate root</em> 文件（模块）中。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token comment" spellcheck="true">// src/lib.rs</span>
<span class="token comment" spellcheck="true">//! # My Crate</span>
<span class="token comment" spellcheck="true">//!</span>
<span class="token comment" spellcheck="true">//! `my_crate` is a collection of utilities to make performing certain //! calculations more convenient.</span>
<span class="token comment" spellcheck="true">/// Adds one to the number given.</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="40">
<li><span class="pn">Page 329</span>可以使用 <code>pub use</code> 重新整理导出 API 接口的引用结构。</li>
<li><span class="pn">Page 330</span>为将要发布的 crate 添加<strong>元信息</strong>：</li>
</ol>
<pre class="line-numbers language-toml"><code class="language-toml">[package]
name = "guessing_game"
version = "0.1.0"
authors = ["Becavalier <yhorg@hotmail.com>"]
edition = "2018"
description = "A fun game where you guess what number the computer has chosen."
license = "MIT OR Apache-2.0"
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>可以使用 <code>cargo publish</code> 发布 crate；</li>
<li>目前 crates.io 暂无 namespacing 机制（考虑到 Namespace Squatting 等一系列潜在的问题）；</li>
</ul>
<ol start="42">
<li><span class="pn">Page 332</span>使用 <code>cargo yank --vers &lt;version&gt;</code> 阻止某一版本 crate 被<strong>新的项目</strong>使用；反之：<code>cargo yank --vers &lt;version&gt; --undo</code>。</li>
<li><span class="pn">Page 333</span><strong>Cargo Workspace</strong>：</li>
</ol>
<ul>
<li>“工作空间”由一系列的“包”组成，它们<strong>共享同一个 Cargo.lock 文件和编译输出目录</strong>，可用于组织大型 Rust 项目中相关的包；</li>
<li>工作目录中的每一个 <em>library crate</em> 都<strong>需要被单独发布</strong>。</li>
</ul>
<pre class="line-numbers language-toml"><code class="language-toml">[workspace]
# specify packages.
members = [ 
  "adder",
  "add-one", 
]
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="44">
<li><span class="pn">Page 339</span>使用 <code>cargo install</code> 安装来自 Crates.io 的二进制包（默认安装在 <em>$HOME/.cargo/bin</em>），并可在系统的全局环境下使用。</li>
</ol>
<h3 id="Chapter-15-Smart-Pointers"><a href="#Chapter-15-Smart-Pointers" class="headerlink" title="Chapter 15 - Smart Pointers"></a>Chapter 15 - Smart Pointers</h3><ol start="45">
<li><span class="pn">Page 341</span><strong>智能指针</strong>（Smart Pointer）：</li>
</ol>
<ul>
<li>Rust 中引用和智能指针的区别：引用是一种指针，这种指针仅能够<strong>“借用”数据</strong>；而智能指针则<strong>“拥有”它们所指向的数据</strong>；</li>
<li><strong>智能指针通常使用 struct 实现</strong>，且实现了 <code>Deref</code> 与 <code>Drop</code> 两个 traits；<ul>
<li><code>Deref</code> trait 允许一个实例能够像引用一样被解引用；</li>
<li><code>Drop</code> trait 允许自定义当一个智能指针的实例脱离当前作用域时的行为。</li>
</ul>
</li>
<li>三种标准库中的常见智能指针类型：<ul>
<li><code>Box&lt;T&gt;</code>：用于在堆上分配空间；</li>
<li><code>Rc&lt;T&gt;</code>：基于“引用计数”的智能指针，允许拥有多个所有权；</li>
<li><code>Ref&lt;T&gt;</code> 与 <code>RefMut&lt;T&gt;</code>：通过 <code>RefCell&lt;T&gt;</code> 访问，该类型在运行时而不是编译时强制执行借用规则。</li>
</ul>
</li>
</ul>
<ol start="46">
<li><span class="pn">Page 342</span><code>Box&lt;T&gt;</code>：</li>
</ol>
<ul>
<li>适用场景：<ul>
<li>如果有一个在编译时无法得知其大小的类型，并且想要在需要精确大小的上下文中使用该类型的值；</li>
<li>当有大量数据并且想要转移所有权，但要确保不会复制数据时；</li>
<li>当想拥有一个值并且只在乎它实现了特定特征的 trait，而不是特定类型时。</li>
</ul>
</li>
<li>可以像使用引用一样的方式来使用该指针；</li>
<li>当该类型指针<strong>脱离当前作用域时，其指向的堆内存会被自动释放</strong>。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> b <span class="token operator">=</span> Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// allocated on the heap.</span>
    <span class="token operator">*</span>b <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// manipulate as a pointer.</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"b = {}"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// "b" will be deallocated before getting here.</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><em>Recursive Types</em>：即某种类型，其大小无法在编译时得知。该类型的一个值其本身可以包含有另一个相同类型的值（无限递归）。比如 <em>Cons List</em>，在 Rust 中该类型可借助 Box 实现：</li>
</ul>
<p><img src="1.png"></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">enum</span> List <span class="token punctuation">{</span>
    <span class="token function">Cons</span><span class="token punctuation">(</span>i32<span class="token punctuation">,</span> Box<span class="token operator">&lt;</span>List<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// save a pointer with a fixed size.</span>
    Nil<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">:</span><span class="token punctuation">:</span>List<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Cons<span class="token punctuation">,</span> Nil<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> list <span class="token operator">=</span> <span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> 
        Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> 
            Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> 
                Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Nil<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="47">
<li><span class="pn">Page 348</span><code>Deref</code> trait：</li>
</ol>
<ul>
<li>对于<strong>可变引用</strong>，可以实现 <code>DerefMut</code> trait 来支持其解引用行为。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token operator">&amp;</span>x<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// pointer to the original value.</span>
    <span class="token keyword">let</span> m <span class="token operator">=</span> Box<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// pointer to a copied value on the heap.</span>

    <span class="token function">assert_eq!</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token operator">*</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// assert_eq!(5, y);  // panic!, they are different types.</span>

    <span class="token keyword">let</span> <span class="token keyword">mut</span> n <span class="token operator">=</span> MyBox<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>n <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// mutation.</span>
    <span class="token function">assert_eq!</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">*</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// underlying: *n -> *(n.deref()).</span>
<span class="token punctuation">}</span>
<span class="token keyword">struct</span> MyBox<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// tuple struct.</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>T<span class="token operator">></span> MyBox<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">-></span> MyBox<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">MyBox</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>ops<span class="token punctuation">:</span><span class="token punctuation">:</span>Deref<span class="token punctuation">;</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>T<span class="token operator">></span> Deref <span class="token keyword">for</span> MyBox<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// &amp;T -> &amp;U.</span>
    <span class="token keyword">type</span> Target <span class="token operator">=</span> T<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// define an associated type.</span>
    <span class="token keyword">fn</span> <span class="token function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span>T <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span>T<span class="token operator">></span> DerefMut <span class="token keyword">for</span> MyBox<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// for mutability. &amp;mut T -> &amp;mut U.</span>
    <span class="token keyword">fn</span> <span class="token function">deref_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> T <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><em>Deref Coercion</em>：对于实现了 <code>Deref</code> trait 的类型，其在作为函数和方法的参数时，Rust 会将该类型转换为对其他类型的引用。<strong>当将对特定类型的值的引用作为参数，传递给与函数或方法定义中的参数类型不匹配的函数或方法时，会自动发生该转换</strong>。一系列对 <code>deref()</code> 的调用会将我们提供的类型转换为参数需要的类型。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">hello</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token operator">&amp;</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Hello, {}!"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> m <span class="token operator">=</span> MyBox<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Rust"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">hello</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// hello(&amp;(*m)[..]);  // original way with "Deref Coercion".</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="48">
<li><span class="pn">Page 354</span><code>Drop</code> trait：</li>
</ol>
<ul>
<li>可以<strong>自定义当某个值脱离当前作用域时的行为</strong>；</li>
<li>变量会根据它们创建时<strong>相反的顺序</strong>来依次调用该方法；</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">struct</span> S <span class="token punctuation">{</span>
    data<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> Drop <span class="token keyword">for</span> S <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">drop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Dropping S with data `{}`!"</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> S <span class="token punctuation">{</span>
        data<span class="token punctuation">:</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"my stuff"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> d <span class="token operator">=</span> S <span class="token punctuation">{</span>
        data<span class="token punctuation">:</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"other stuff"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>可以使用 <code>std::mem::drop()</code> <strong>提前调用某个变量的 <em>drop</em> 方法</strong>（比如用于在某个作用域内提前<strong>释放锁</strong>）：</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> S <span class="token punctuation">{</span>
        data<span class="token punctuation">:</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"my stuff"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// std::mem::drop(c); </span>
    <span class="token function">drop</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// drop "c" manually.</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"S dropped before the end of main."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="49">
<li><span class="pn">Page 358</span><code>Rc&lt;T&gt;</code>：</li>
</ol>
<ul>
<li>基于“<strong>引用计数</strong>”的智能指针；</li>
<li>仅适用于“单线程”场景；</li>
<li>仅支持<strong>编译时</strong>的<strong>不可变引用</strong>；</li>
<li>使用场景：程序<strong>在多个地方需要使用某个在堆上分配的资源，且无法在编译时得知哪一部分代码会最后一个使用该资源</strong>。</li>
</ul>
<p><img src="2.png"></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">enum</span> List <span class="token punctuation">{</span>
    <span class="token function">Cons</span><span class="token punctuation">(</span>i32<span class="token punctuation">,</span> Rc<span class="token operator">&lt;</span>List<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Nil<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">:</span><span class="token punctuation">:</span>List<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Cons<span class="token punctuation">,</span> Nil<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>rc<span class="token punctuation">:</span><span class="token punctuation">:</span>Rc<span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> 
                Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> 
                    Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Nil<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// increments the reference count.</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="50">
<li><span class="pn">Page 363</span><code>RefCall&lt;T&gt;</code>：</li>
</ol>
<ul>
<li>代表<strong>对它所持有数据的单一所有权</strong>，主要在当确定代码遵循借用规则，但编译器无法理解并保证这一点的时候使用。</li>
<li>仅适用于“单线程”场景；</li>
<li>支持<strong>运行时</strong>的<strong>可变与不可变引用</strong>；</li>
<li><em><strong>Interior Mutability</strong></em>：是 Rust 中的一种设计模式，它允许<strong>通过数据的不可变引用来在运行时对数据进行变更</strong>。被该类型“包裹”的对象可以通过不可变引用来进行变更。</li>
</ul>
<ol start="51">
<li><span class="pn">Page 371</span>结合使用 <code>RefCell&lt;T&gt;</code> 与 <code>Rc&lt;T&gt;</code>：</li>
</ol>
<ul>
<li>可用于实现<strong>可变数据的多重所有权</strong>：</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">enum</span> List <span class="token punctuation">{</span>
    <span class="token function">Cons</span><span class="token punctuation">(</span>Rc<span class="token operator">&lt;</span>RefCell<span class="token operator">&lt;</span>i32<span class="token operator">>></span><span class="token punctuation">,</span> Rc<span class="token operator">&lt;</span>List<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Nil<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">:</span><span class="token punctuation">:</span>List<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Cons<span class="token punctuation">,</span> Nil<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>rc<span class="token punctuation">:</span><span class="token punctuation">:</span>Rc<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>RefCell<span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> value <span class="token operator">=</span> Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">Cons</span><span class="token punctuation">(</span>Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span> Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Nil<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token function">Cons</span><span class="token punctuation">(</span>Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token function">Cons</span><span class="token punctuation">(</span>Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token number">10</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// automatic referencing and dereferencing.</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"a after = {:?}"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"b after = {:?}"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"c after = {:?}"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="52">
<li><span class="pn">Page 373</span><strong>循环引用</strong>：</li>
</ol>
<p>- <em><strong>一个产生循环引用的例子</strong></em>：</p>
<p><img src="3.png"></p>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">:</span><span class="token punctuation">:</span>List<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Cons<span class="token punctuation">,</span> Nil<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>rc<span class="token punctuation">:</span><span class="token punctuation">:</span>Rc<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>RefCell<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">enum</span> List <span class="token punctuation">{</span>
    <span class="token function">Cons</span><span class="token punctuation">(</span>i32<span class="token punctuation">,</span> RefCell<span class="token operator">&lt;</span>Rc<span class="token operator">&lt;</span>List<span class="token operator">>></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Nil<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> List <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> Option<span class="token operator">&lt;</span><span class="token operator">&amp;</span>RefCell<span class="token operator">&lt;</span>Rc<span class="token operator">&lt;</span>List<span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> <span class="token keyword">self</span> <span class="token punctuation">{</span>
            <span class="token function">Cons</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> item<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">Some</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">,</span>
            Nil <span class="token operator">=</span><span class="token operator">></span> None<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Nil<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">Cons</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token function">Some</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span> <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token function">tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token operator">*</span>link<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>- <em><strong>借助 <code>Weak&lt;T&gt;</code> 解决循环引用</strong></em>：</p>
<ul>
<li>调用 <code>Rc::clone()</code> 会增加 <em>strong_count</em> 的数量，而调用 <code>Rc::downgrade()</code> 会返回一个类型为 <code>Weak&lt;T&gt;</code> 的智能指针，并同时增加 <em>weak_count</em> 的数量。而 <em>weak_count</em> 的数量是否为零，不会影响 <code>Rc&lt;T&gt;</code> 指针的释放；</li>
<li>在使用返回的 <code>Weak&lt;T&gt;</code> 前需要调用 <em>upgrade</em> 以返回该“弱指针”的可用状态（是否已被释放），该状态会被存放在 <em>Option&lt;Rc<T>&gt;</em> 类型中。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Rc<span class="token punctuation">,</span> Weak<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>cell<span class="token punctuation">:</span><span class="token punctuation">:</span>RefCell<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> Node <span class="token punctuation">{</span>
    value<span class="token punctuation">:</span> i32<span class="token punctuation">,</span>
    parent<span class="token punctuation">:</span> RefCell<span class="token operator">&lt;</span>Weak<span class="token operator">&lt;</span>Node<span class="token operator">>></span><span class="token punctuation">,</span>
    children<span class="token punctuation">:</span> RefCell<span class="token operator">&lt;</span>Vec<span class="token operator">&lt;</span>Rc<span class="token operator">&lt;</span>Node<span class="token operator">>></span><span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> leaf <span class="token operator">=</span> Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Node <span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        parent<span class="token punctuation">:</span> RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Weak<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// placeholder.</span>
        children<span class="token punctuation">:</span> RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> branch <span class="token operator">=</span> Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Node <span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        parent<span class="token punctuation">:</span> RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Weak<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// placeholder.</span>
        children<span class="token punctuation">:</span> RefCell<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token function">vec!</span><span class="token punctuation">[</span>Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>leaf<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>leaf<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> Rc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">downgrade</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>branch<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// populating.</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"leaf parent = {:#?}"</span><span class="token punctuation">,</span> leaf<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">upgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// return Option&lt;_, None>.</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="Chapter-16-Fearless-Concurrency"><a href="#Chapter-16-Fearless-Concurrency" class="headerlink" title="Chapter 16 - Fearless Concurrency"></a>Chapter 16 - Fearless Concurrency</h3><ol start="53">
<li><span class="pn">Page 383</span>使用线程：</li>
</ol>
<ul>
<li>由编程语言提供的线程一般被称为 “<em>green thread</em>”，与操作系统提供的线程一般呈“<strong>多对多</strong>”关系。前者会实际运行在后者的上下文中；<strong>由于“多对多”模型需要更多的运行时（由编程语言自行插入到二进制可执行文件中的）代码，因此默认情况下 Rust 标准库仅提供“一对一”的线程模型</strong>；</li>
<li>默认情况下，当主线程退出时，其他线程会停止运行并被销毁。可以使用创建线程时返回的 <em>JoinHandle</em> 类型上的 <em>join()</em> 方法，来让当前线程等待（阻塞），直到新创建线程的执行完成。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>time<span class="token punctuation">:</span><span class="token punctuation">:</span>Duration<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// by default, the new thread will be stopped when the main thread ends.</span>
    <span class="token comment" spellcheck="true">// "thread::spawn()" returns a "JoinHandle".</span>
    <span class="token keyword">let</span> handle <span class="token operator">=</span> thread<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">{</span>
            <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"hi number {} from the spawned thread!"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            thread<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sleep</span><span class="token punctuation">(</span>Duration<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">1</span><span class="token punctuation">..</span><span class="token number">5</span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"hi number {} from the main thread!"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        thread<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">sleep</span><span class="token punctuation">(</span>Duration<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from_millis</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// let the current thread wait here for the thread to finish.</span>
    handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>使用带有 <em>move</em> 语义的闭包来在<strong>线程间移动资源</strong>：</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// force the closure to take ownership of the values it’s using.</span>
    <span class="token keyword">let</span> handle <span class="token operator">=</span> thread<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Here's a vector: {:?}"</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="54">
<li><span class="pn">Page 391</span><strong>Message Passing</strong>：</li>
</ol>
<ul>
<li>线程或参与者通过互相发送包含数据的消息进行通信。“*Do not communicate by sharing memory; instead, share memory by communicating.*”；</li>
<li>可以通过<strong>克隆 transmitter</strong>（*clone()*）来支持多个线程的消息发送端；</li>
<li>仅支持“单一所有权”，即<strong>同一时间只有一个线程拥有、且可以处理该资源</strong>。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread<span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>sync<span class="token punctuation">:</span><span class="token punctuation">:</span>mpsc<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// "multiple producer, single consumer".</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// get the "sending end" (transmitter) and "receiving end" (receiver).</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>tx<span class="token punctuation">,</span> rx<span class="token punctuation">)</span> <span class="token operator">=</span> mpsc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> val <span class="token operator">=</span> String<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"Hi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// send a message.</span>
        tx<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment" spellcheck="true">// block the main thread’s execution and wait until a value is sent down the channel.</span>
    <span class="token keyword">let</span> received <span class="token operator">=</span> rx<span class="token punctuation">.</span><span class="token function">recv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// we can even iterate the receiver directly.</span>
    <span class="token comment" spellcheck="true">// for v in rx {  </span>
    <span class="token comment" spellcheck="true">//     println!("Got: {}", received);</span>
    <span class="token comment" spellcheck="true">// }</span>

    <span class="token comment" spellcheck="true">// let received = rx.try_recv().unwrap();  // the non-blocking version, can be used within a loop.</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Got: {}"</span><span class="token punctuation">,</span> received<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="55">
<li><span class="pn">Page 398</span><strong>共享状态</strong>多线程：</li>
</ol>
<ul>
<li>支持“多所有权”，允许<strong>多个线程处理某个特定资源（内存）</strong>；</li>
<li>使用“<strong>互斥锁</strong>（Mutex，<em>Mutual Exclusion</em>）”仅允许一次从一个线程访问数据，以防止数据竞争问题。一个线程需要首先发出信号，告知其想要获得互斥锁，互斥锁是 Mutex 中的一种数据结构，用于表明当前谁拥有对某个数据的独占权。而当线程使用数据完毕后，需要释放锁。</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>sync<span class="token punctuation">:</span><span class="token punctuation">:</span>Mutex<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> m <span class="token operator">=</span> Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// wrap the data inside the Mutex.</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// "lock()" will block the thread until getting the lock.</span>
        <span class="token comment" spellcheck="true">// will return a MutexGuard, which is a smart pointer.</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> num <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token operator">*</span>num <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// the lock will be released automatically when it goes out of the scope.</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"m = {:?}"</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>在多个线程间使用 Mutex 访问共享数据：<ul>
<li>需要使用线程安全的 “<em>Arc</em>（<strong>Atomic</strong>）” 来提供对 Mutex 的多所有权，每个所有权分发给一个单独的线程来使用。</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-rust"><code class="language-rust"><span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>sync<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">{</span>Mutex<span class="token punctuation">,</span> Arc<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> std<span class="token punctuation">:</span><span class="token punctuation">:</span>thread<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// use thread-safe Rc -> Arc.</span>
    <span class="token keyword">let</span> counter <span class="token operator">=</span> Arc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>Mutex<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> handles <span class="token operator">=</span> <span class="token function">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">10</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> counter <span class="token operator">=</span> Arc<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> handle <span class="token operator">=</span> thread<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token punctuation">|</span><span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> num <span class="token operator">=</span> counter<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>num <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        handles<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> handle <span class="token keyword">in</span> handles <span class="token punctuation">{</span>
        handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">println!</span><span class="token punctuation">(</span><span class="token string">"Result: {}"</span><span class="token punctuation">,</span> <span class="token operator">*</span>counter<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><em>Mutex&lt;T&gt;</em> <strong>也提供了 <em>interior mutability</em> 的能力</strong>。<ul>
<li><em>RefCell&lt;T&gt;</em> / *Rc&lt;T&gt;*；</li>
<li><em>Mutex&lt;T&gt;</em> / *Arc&lt;T&gt;*。</li>
</ul>
</li>
</ul>
<ol start="56">
<li><span class="pn">Page 406</span><code>Send</code> trait：</li>
</ol>
<ul>
<li>一个实现了该 trait 的类型其所有权可以<strong>在多个线程间转移</strong>。</li>
</ul>
<ol start="57">
<li><span class="pn">Page 407</span><code>Sync</code> trait：</li>
</ol>
<ul>
<li>一个实现了该 trait 的类型可以<strong>被多个线程引用</strong>。</li>
</ul>
<br><div class="article-bottom-meta"><span class="post-meta">Last built on<time itemprop="dateModified" datetime="2021-04-01T10:07:48.000Z"> 2023 / 10 / 26, 11:37:10</time></span></div></div></article><br><span class="next-post"><a href="/2021/04/08/《The-Rust-Programming-Language》读书笔记（第-17-21-章）/" itemprop="url">下一篇 ⇒</a></span><span class="prev-post"><a href="/2021/03/27/《The-Rust-Programming-Language》读书笔记（第-7-11-章）/" itemprop="url">⇐ 上一篇</a></span><br><section id="comments"><div><script src="https://utteranc.es/client.js" repo="Becavalier/utterances-comments" issue-term="title" label="[Comment]" theme="github-light" crossorigin="anonymous" async></script></div></section><br><br></main><script src="/scripts/index.js" type="text/javascript"></script></body></html>